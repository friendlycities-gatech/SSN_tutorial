<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 5 Advanced Aesthetics | Spatial Social Networks (SSN) Visualization and Metrics with R</title>
  <meta name="description" content="This book describes the basic concepts, theories, methods, and visualizations involved to map and analyze spatial networks in R." />
  <meta name="generator" content="bookdown 0.18 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 5 Advanced Aesthetics | Spatial Social Networks (SSN) Visualization and Metrics with R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book describes the basic concepts, theories, methods, and visualizations involved to map and analyze spatial networks in R." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 5 Advanced Aesthetics | Spatial Social Networks (SSN) Visualization and Metrics with R" />
  
  <meta name="twitter:description" content="This book describes the basic concepts, theories, methods, and visualizations involved to map and analyze spatial networks in R." />
  

<meta name="author" content="Xiaofan Liang, Clio Andris, Dipto Sarkar" />


<meta name="date" content="2021-11-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="vizedges.html"/>
<link rel="next" href="advanced-ssn-metrics.html"/>
<script src="libs/header-attrs-2.1/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">SSN Tutorial</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="metrics.html"><a href="metrics.html"><i class="fa fa-check"></i><b>2</b> Network Metrics</a>
<ul>
<li class="chapter" data-level="2.1" data-path="metrics.html"><a href="metrics.html#network-data-formats"><i class="fa fa-check"></i><b>2.1</b> Network Data Formats</a></li>
<li class="chapter" data-level="2.2" data-path="metrics.html"><a href="metrics.html#network-metrics"><i class="fa fa-check"></i><b>2.2</b> Network Metrics</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="metrics.html"><a href="metrics.html#network-metrics-for-nodes"><i class="fa fa-check"></i><b>2.2.1</b> Network Metrics for Nodes</a></li>
<li class="chapter" data-level="2.2.2" data-path="metrics.html"><a href="metrics.html#network-metrics-for-edges"><i class="fa fa-check"></i><b>2.2.2</b> Network Metrics for Edges</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="metrics.html"><a href="metrics.html#igraph-visualization"><i class="fa fa-check"></i><b>2.3</b> igraph Visualization</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="nodes.html"><a href="nodes.html"><i class="fa fa-check"></i><b>3</b> Visualizing Nodes</a>
<ul>
<li class="chapter" data-level="3.1" data-path="nodes.html"><a href="nodes.html#convert-coordinates-to-points"><i class="fa fa-check"></i><b>3.1</b> Convert Coordinates to Points</a></li>
<li class="chapter" data-level="3.2" data-path="nodes.html"><a href="nodes.html#visualize-nodes"><i class="fa fa-check"></i><b>3.2</b> Visualize Nodes</a></li>
<li class="chapter" data-level="3.3" data-path="nodes.html"><a href="nodes.html#visualize-nodes-by-node-color"><i class="fa fa-check"></i><b>3.3</b> Visualize Nodes by Node Color</a></li>
<li class="chapter" data-level="3.4" data-path="nodes.html"><a href="nodes.html#visualize-nodes-by-node-size"><i class="fa fa-check"></i><b>3.4</b> Visualize Nodes by Node Size</a></li>
<li class="chapter" data-level="3.5" data-path="nodes.html"><a href="nodes.html#visualize-nodes-by-size-and-color"><i class="fa fa-check"></i><b>3.5</b> Visualize Nodes by Size and Color</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="vizedges.html"><a href="vizedges.html"><i class="fa fa-check"></i><b>4</b> Visualizing Edges</a>
<ul>
<li class="chapter" data-level="4.1" data-path="vizedges.html"><a href="vizedges.html#convert-points-into-lines"><i class="fa fa-check"></i><b>4.1</b> Convert Points into Lines</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="vizedges.html"><a href="vizedges.html#method-1-group-by-lineid-and-summarize-points-into-line"><i class="fa fa-check"></i><b>4.1.1</b> Method 1: Group by lineID and Summarize Points into Line</a></li>
<li class="chapter" data-level="4.1.2" data-path="vizedges.html"><a href="vizedges.html#method-2-join-two-point-geometry-into-one-row-and-unite-into-line"><i class="fa fa-check"></i><b>4.1.2</b> Method 2: Join Two Point Geometry into One Row and Unite into Line</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="vizedges.html"><a href="vizedges.html#visualizing-edges"><i class="fa fa-check"></i><b>4.2</b> Visualizing Edges</a></li>
<li class="chapter" data-level="4.3" data-path="vizedges.html"><a href="vizedges.html#visualizing-edges-by-line-width"><i class="fa fa-check"></i><b>4.3</b> Visualizing Edges by Line Width</a></li>
<li class="chapter" data-level="4.4" data-path="vizedges.html"><a href="vizedges.html#visualizing-edges-by-color"><i class="fa fa-check"></i><b>4.4</b> Visualizing Edges by Color</a></li>
<li class="chapter" data-level="4.5" data-path="vizedges.html"><a href="vizedges.html#visualizing-edges-by-width-and-color"><i class="fa fa-check"></i><b>4.5</b> Visualizing Edges by Width and Color</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="advanced-aesthetics.html"><a href="advanced-aesthetics.html"><i class="fa fa-check"></i><b>5</b> Advanced Aesthetics</a>
<ul>
<li class="chapter" data-level="5.1" data-path="advanced-aesthetics.html"><a href="advanced-aesthetics.html#export-for-editing"><i class="fa fa-check"></i><b>5.1</b> Export for Editing</a></li>
<li class="chapter" data-level="5.2" data-path="advanced-aesthetics.html"><a href="advanced-aesthetics.html#small-multiples"><i class="fa fa-check"></i><b>5.2</b> Small Multiples</a></li>
<li class="chapter" data-level="5.3" data-path="advanced-aesthetics.html"><a href="advanced-aesthetics.html#interactive-maps"><i class="fa fa-check"></i><b>5.3</b> Interactive Maps</a></li>
<li class="chapter" data-level="5.4" data-path="advanced-aesthetics.html"><a href="advanced-aesthetics.html#base-map"><i class="fa fa-check"></i><b>5.4</b> Base Map</a></li>
<li class="chapter" data-level="5.5" data-path="advanced-aesthetics.html"><a href="advanced-aesthetics.html#inset-map"><i class="fa fa-check"></i><b>5.5</b> Inset Map</a></li>
<li class="chapter" data-level="5.6" data-path="advanced-aesthetics.html"><a href="advanced-aesthetics.html#edge-bundling"><i class="fa fa-check"></i><b>5.6</b> Edge Bundling</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="advanced-ssn-metrics.html"><a href="advanced-ssn-metrics.html"><i class="fa fa-check"></i><b>6</b> Advanced SSN Metrics</a>
<ul>
<li class="chapter" data-level="6.1" data-path="advanced-ssn-metrics.html"><a href="advanced-ssn-metrics.html#network-modularity"><i class="fa fa-check"></i><b>6.1</b> Network Modularity</a></li>
<li class="chapter" data-level="6.2" data-path="advanced-ssn-metrics.html"><a href="advanced-ssn-metrics.html#ssn-hot-spot-detection"><i class="fa fa-check"></i><b>6.2</b> SSN Hot Spot Detection</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="edges.html"><a href="edges.html"><i class="fa fa-check"></i><b>7</b> Future Development</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Social Networks (SSN) Visualization and Metrics with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="advanced-aesthetics" class="section level1" number="5">
<h1><span class="header-section-number">Chapter 5</span> Advanced Aesthetics</h1>
<style type="text/css">
.Code {
background-color: grey;
}
</style>
<p>You may need one or more of these libraries to complete the codes in this chapter.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb48-1"><a href="advanced-aesthetics.html#cb48-1"></a><span class="kw">library</span>(sf) <span class="co">#required for any functions start with`st_`</span></span>
<span id="cb48-2"><a href="advanced-aesthetics.html#cb48-2"></a><span class="kw">library</span>(tidyverse) <span class="co">#required for any process that involves `%&gt;%` </span></span>
<span id="cb48-3"><a href="advanced-aesthetics.html#cb48-3"></a><span class="kw">library</span>(tmap) <span class="co">#required for any map visualization </span></span>
<span id="cb48-4"><a href="advanced-aesthetics.html#cb48-4"></a><span class="kw">library</span>(SSNtools) <span class="co">#required for any steps that involved MafiaNodes or MafiaEdges dataset </span></span>
<span id="cb48-5"><a href="advanced-aesthetics.html#cb48-5"></a><span class="kw">library</span>(igraph) <span class="co">#required for creating network from graph_from_data_frame and calculating network metrics </span></span>
<span id="cb48-6"><a href="advanced-aesthetics.html#cb48-6"></a><span class="kw">library</span>(OpenStreetMap) <span class="co">#required for loading base map </span></span>
<span id="cb48-7"><a href="advanced-aesthetics.html#cb48-7"></a><span class="kw">library</span>(stars) <span class="co">#required for loading base map</span></span>
<span id="cb48-8"><a href="advanced-aesthetics.html#cb48-8"></a><span class="kw">library</span>(tigris) <span class="co">#required for downloading boundary shapefiles </span></span>
<span id="cb48-9"><a href="advanced-aesthetics.html#cb48-9"></a><span class="kw">library</span>(grid) <span class="co">#required for inset</span></span>
<span id="cb48-10"><a href="advanced-aesthetics.html#cb48-10"></a><span class="kw">library</span>(edgebundle) <span class="co">#required for edge bundling</span></span></code></pre></div>
<div id="export-for-editing" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Export for Editing</h2>
<p><code>tmap</code> allows users to export <code>tmap object</code> as a static map in the format of pdf, eps, svg, wmf, png, jpg, bmp, or tiff. You can define the resolution, height, and width of the export in the <code>tmap_save</code> arguments.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb49-1"><a href="advanced-aesthetics.html#cb49-1"></a><span class="kw">tmap_save</span>(<span class="dt">tm =</span> TMAP_OBJECT, <span class="dt">filename=</span><span class="st">&#39;PATH/FILENAME.png&#39;</span>)</span></code></pre></div>
<p>With these formats, you can import the tmap maps into Adobe Illustrators or Photoshop to further edit the details. You can also export the shapefiles you created in R to experiment in GIS softwares through <code>sf</code> package.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb50-1"><a href="advanced-aesthetics.html#cb50-1"></a><span class="co">#MafiaNodes is a built-in dataset from SSNtools</span></span>
<span id="cb50-2"><a href="advanced-aesthetics.html#cb50-2"></a>MafiaSpatial =<span class="st"> </span>MafiaNodes <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb50-3"><a href="advanced-aesthetics.html#cb50-3"></a><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords=</span><span class="kw">c</span>(<span class="st">&quot;LonX&quot;</span>, <span class="st">&quot;LatY&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>) </span>
<span id="cb50-4"><a href="advanced-aesthetics.html#cb50-4"></a></span>
<span id="cb50-5"><a href="advanced-aesthetics.html#cb50-5"></a><span class="kw">st_write</span>(MafiaSpatial, <span class="st">&quot;MafiaSpatial.shp&quot;</span>) </span></code></pre></div>
<p>Unfortunately, there isn’t a way to export tmap object to GIS softwares without losing the aesthetics yet (e.g., scale, size, color etc., see updates on this issue <a href="https://github.com/r-tmap/tmap/issues/510">here</a>).</p>
</div>
<div id="small-multiples" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Small Multiples</h2>
<p>In our case of the Mafia connectivity map, the power of the Mafia members can be represented by different network metrics. For example, <strong>degree centrality</strong> (i.e. degree connections) measures power as the number of connections to a Mafia member. <strong>Eigenvector centrality</strong> (i.e., PageRank centrality) measures power by not only the count of connections, but also the quality of connections so that connecting to other powerful members increases the weight of the link. <strong>Betweeness centrality</strong> measures power by the ability of a Mafia member to be the “middle-man/middle-woman” and connect groups of other members that would not be connected otherwise. (Local) <strong>Clustering coefficient</strong> measures whether a Mafia member’s friends tend to connect with each others (i.e., whether your friends are also your friends’ friends).</p>
<p>Noted that <strong>closeness centrality</strong> is also a common measure of power, but the metric is not well-defined for disconnected graphs. In our dataset, there exists small Mafia cliques that do not interact with others. Thus, we did not use this metric. To contrast these different notions of power in the Mafia map, small multiple comes in handy.</p>
<p>Small multiple is a group of charts or graphs that use the same scale or axes for easy comparison. Here we show how to create a small multiple of the Mafia member map with various network metrics through tmap <code>tm_facets</code>.</p>
<p>Before we map the small multiple, there are some pre-processing. Firstly, when we add network metrics into the <code>MafiaSpatial</code>, each metric is in one column. However, the <code>tm_facet</code> only create multiples based on a column of value. Thus, we need to convert <code>MafiaSpatial</code> into a long table using <code>gather</code> function in <code>tidyverse</code> package (more accuratly, the <code>tidyr</code> package in <code>tidyverse</code>) so that column <code>metric</code> stores the type of metrics (e.g., “degree”, “eigen”, “betweenness”, “cluster”), and the column <code>value</code> stores the metric value.</p>
<p>Secondly, we convert the <code>metric</code> column into a factor column, so that the order of the variable to be mapped is specified. Otherwise, the order of mapping for the small multiple will follow the alphebatical order of the value string in the metric column.</p>
<p>Lastly, we also retrieve the state boundary shapefile from <code>tigris</code> as the background for the map.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb51-1"><a href="advanced-aesthetics.html#cb51-1"></a><span class="kw">library</span>(sf) </span>
<span id="cb51-2"><a href="advanced-aesthetics.html#cb51-2"></a><span class="kw">library</span>(tidyverse) </span>
<span id="cb51-3"><a href="advanced-aesthetics.html#cb51-3"></a><span class="kw">library</span>(tmap) </span>
<span id="cb51-4"><a href="advanced-aesthetics.html#cb51-4"></a><span class="kw">library</span>(SSNtools) </span>
<span id="cb51-5"><a href="advanced-aesthetics.html#cb51-5"></a><span class="kw">library</span>(igraph)</span>
<span id="cb51-6"><a href="advanced-aesthetics.html#cb51-6"></a><span class="kw">library</span>(tigris)</span>
<span id="cb51-7"><a href="advanced-aesthetics.html#cb51-7"></a></span>
<span id="cb51-8"><a href="advanced-aesthetics.html#cb51-8"></a><span class="co">#MafiaNodes and MafiaEdges are built-in dataset from SSNtools </span></span>
<span id="cb51-9"><a href="advanced-aesthetics.html#cb51-9"></a>MafiaSpatial =<span class="st"> </span>MafiaNodes <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-10"><a href="advanced-aesthetics.html#cb51-10"></a><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords=</span><span class="kw">c</span>(<span class="st">&quot;LonX&quot;</span>, <span class="st">&quot;LatY&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb51-11"><a href="advanced-aesthetics.html#cb51-11"></a></span>
<span id="cb51-12"><a href="advanced-aesthetics.html#cb51-12"></a>g =<span class="st"> </span><span class="kw">graph_from_data_frame</span>(MafiaEdges, <span class="dt">directed =</span> <span class="ot">FALSE</span>, <span class="dt">vertices=</span>MafiaSpatial)</span>
<span id="cb51-13"><a href="advanced-aesthetics.html#cb51-13"></a></span>
<span id="cb51-14"><a href="advanced-aesthetics.html#cb51-14"></a><span class="co">#Calculate network metrics</span></span>
<span id="cb51-15"><a href="advanced-aesthetics.html#cb51-15"></a>MafiaSpatial<span class="op">$</span>degree =<span class="st"> </span><span class="kw">degree</span>(g)</span>
<span id="cb51-16"><a href="advanced-aesthetics.html#cb51-16"></a>MafiaSpatial<span class="op">$</span>eigen =<span class="st"> </span><span class="kw">eigen_centrality</span>(g)<span class="op">$</span>vector</span>
<span id="cb51-17"><a href="advanced-aesthetics.html#cb51-17"></a>MafiaSpatial<span class="op">$</span>betweenness =<span class="st"> </span><span class="kw">betweenness</span>(g, <span class="dt">v=</span><span class="kw">V</span>(g))</span>
<span id="cb51-18"><a href="advanced-aesthetics.html#cb51-18"></a>MafiaSpatial<span class="op">$</span>cluster =<span class="st"> </span><span class="kw">transitivity</span>(g, <span class="dt">type=</span><span class="st">&#39;local&#39;</span>)</span>
<span id="cb51-19"><a href="advanced-aesthetics.html#cb51-19"></a></span>
<span id="cb51-20"><a href="advanced-aesthetics.html#cb51-20"></a>MafiaSpatial =<span class="st"> </span>MafiaSpatial <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-21"><a href="advanced-aesthetics.html#cb51-21"></a><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key=</span><span class="st">&#39;metric&#39;</span>, <span class="dt">value=</span><span class="st">&#39;value&#39;</span>, degree<span class="op">:</span>cluster) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb51-22"><a href="advanced-aesthetics.html#cb51-22"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">metric =</span> <span class="kw">factor</span>(metric, <span class="dt">levels=</span><span class="kw">c</span>(<span class="st">&#39;degree&#39;</span>, <span class="st">&#39;eigen&#39;</span>, <span class="st">&#39;betweenness&#39;</span>, <span class="st">&#39;cluster&#39;</span>)))</span>
<span id="cb51-23"><a href="advanced-aesthetics.html#cb51-23"></a></span>
<span id="cb51-24"><a href="advanced-aesthetics.html#cb51-24"></a><span class="co">#states is a function from tigris package</span></span>
<span id="cb51-25"><a href="advanced-aesthetics.html#cb51-25"></a>us_states =<span class="st"> </span><span class="kw">states</span>(<span class="dt">cb=</span><span class="ot">TRUE</span>, <span class="dt">progress_bar =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span></span>
<span id="cb51-26"><a href="advanced-aesthetics.html#cb51-26"></a><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>STUSPS <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;PR&#39;</span>,<span class="st">&#39;AS&#39;</span>, <span class="st">&#39;AK&#39;</span>, <span class="st">&#39;GU&#39;</span>,<span class="st">&#39;MP&#39;</span>,<span class="st">&#39;VI&#39;</span>, <span class="st">&#39;HI&#39;</span>))</span></code></pre></div>
<p>Now we can map the small multiple! We specify the column <code>metric</code> in the <code>by</code> argument in <code>tm_facets</code>, which stores variables that the split will use. <code>free.scales=T</code> enables each facet (subplot) creates its own legend with its own scale. <code>free.coords = F</code> enables each map to have its own coordinate range, which is necessary if you have a multi-layer small multiple. You can specify the style of each facet in <code>tm_layout</code> with <code>panel</code> related arguments. In our example, we specify the name for each facet.</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb52-1"><a href="advanced-aesthetics.html#cb52-1"></a><span class="kw">tm_shape</span>(us_states) <span class="op">+</span><span class="st">  </span></span>
<span id="cb52-2"><a href="advanced-aesthetics.html#cb52-2"></a><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha=</span><span class="dv">0</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb52-3"><a href="advanced-aesthetics.html#cb52-3"></a><span class="st">  </span><span class="kw">tm_shape</span>(MafiaSpatial) <span class="op">+</span></span>
<span id="cb52-4"><a href="advanced-aesthetics.html#cb52-4"></a><span class="st">  </span><span class="kw">tm_facets</span>(<span class="dt">by=</span><span class="st">&#39;metric&#39;</span>, <span class="dt">free.coords=</span>F, <span class="dt">free.scales =</span> T) <span class="op">+</span><span class="st"> </span></span>
<span id="cb52-5"><a href="advanced-aesthetics.html#cb52-5"></a><span class="st">  </span><span class="kw">tm_symbols</span>(<span class="dt">size=</span><span class="st">&quot;value&quot;</span>, <span class="dt">scale=</span><span class="dv">1</span>, </span>
<span id="cb52-6"><a href="advanced-aesthetics.html#cb52-6"></a>             <span class="dt">col=</span><span class="st">&#39;lightblue&#39;</span>, <span class="dt">border.col=</span><span class="st">&#39;#6698CC&#39;</span>, </span>
<span id="cb52-7"><a href="advanced-aesthetics.html#cb52-7"></a>             <span class="dt">title.size=</span><span class="kw">c</span>(<span class="st">&#39;Measure of Power&#39;</span>)) <span class="op">+</span></span>
<span id="cb52-8"><a href="advanced-aesthetics.html#cb52-8"></a><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels =</span> <span class="kw">c</span>(<span class="st">&#39;Degree Centrality&#39;</span>, <span class="st">&#39;Eigenvector Centrality&#39;</span>,</span>
<span id="cb52-9"><a href="advanced-aesthetics.html#cb52-9"></a>                             <span class="st">&#39;Betweenness Centrality&#39;</span>, <span class="st">&#39;Clustering Coefficient&#39;</span>))</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-49-1.png" width="672" /></p>
<p>From the maps above we can see that the most powerful mafia members are located around the New York City region. They are relatively more “powerful” in eigenvector centrality and betweenness centrality measures, and less so in degree centrality and clustering coefficients. Despite the concentration of power is in the Northeast, local mafia members can still be powerful as being well-embedded in a local social network. Many of the mafia families in the isolated regions (e.g., Colorado, Midwest, Texas) are very closely connected with each other.</p>
<p>If you found the different value range across the metrics confusing or misleading (some metrics tend to follow power law), you can also standardize the metric values into respective percentile by adding the following lines before the <code>gather</code>. For example, a metric with value <code>c(4, 1, 2, 3, 5)</code> will be converted to <code>c(0.75, 0, 0.25, 0.5, 1)</code>.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb53-1"><a href="advanced-aesthetics.html#cb53-1"></a>MafiaSpatial =<span class="st"> </span>MafiaNodes <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb53-2"><a href="advanced-aesthetics.html#cb53-2"></a><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords=</span><span class="kw">c</span>(<span class="st">&quot;LonX&quot;</span>, <span class="st">&quot;LatY&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb53-3"><a href="advanced-aesthetics.html#cb53-3"></a></span>
<span id="cb53-4"><a href="advanced-aesthetics.html#cb53-4"></a>g =<span class="st"> </span><span class="kw">graph_from_data_frame</span>(MafiaEdges, <span class="dt">directed =</span> <span class="ot">FALSE</span>, <span class="dt">vertices=</span>MafiaSpatial)</span>
<span id="cb53-5"><a href="advanced-aesthetics.html#cb53-5"></a></span>
<span id="cb53-6"><a href="advanced-aesthetics.html#cb53-6"></a><span class="co">#Convert the metrics to percentile </span></span>
<span id="cb53-7"><a href="advanced-aesthetics.html#cb53-7"></a>MafiaSpatial<span class="op">$</span>degree =<span class="st"> </span><span class="kw">rank</span>(<span class="kw">degree</span>(g))<span class="op">/</span><span class="kw">length</span>(<span class="kw">degree</span>(g))</span>
<span id="cb53-8"><a href="advanced-aesthetics.html#cb53-8"></a>MafiaSpatial<span class="op">$</span>eigen =<span class="st"> </span><span class="kw">rank</span>(<span class="kw">eigen_centrality</span>(g)<span class="op">$</span>vector)<span class="op">/</span><span class="kw">length</span>(<span class="kw">eigen_centrality</span>(g)<span class="op">$</span>vector)</span>
<span id="cb53-9"><a href="advanced-aesthetics.html#cb53-9"></a>MafiaSpatial<span class="op">$</span>betweenness =<span class="st"> </span><span class="kw">rank</span>(<span class="kw">betweenness</span>(g, <span class="dt">v=</span><span class="kw">V</span>(g)))<span class="op">/</span><span class="kw">length</span>(<span class="kw">betweenness</span>(g, <span class="dt">v=</span><span class="kw">V</span>(g)))</span>
<span id="cb53-10"><a href="advanced-aesthetics.html#cb53-10"></a>MafiaSpatial<span class="op">$</span>cluster =<span class="st"> </span><span class="kw">rank</span>(<span class="kw">transitivity</span>(g, <span class="dt">type=</span><span class="st">&#39;local&#39;</span>))<span class="op">/</span><span class="kw">length</span>(<span class="kw">transitivity</span>(g, <span class="dt">type=</span><span class="st">&#39;local&#39;</span>))</span>
<span id="cb53-11"><a href="advanced-aesthetics.html#cb53-11"></a></span>
<span id="cb53-12"><a href="advanced-aesthetics.html#cb53-12"></a><span class="co">#same as above </span></span>
<span id="cb53-13"><a href="advanced-aesthetics.html#cb53-13"></a>MafiaSpatial =<span class="st"> </span>MafiaSpatial <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb53-14"><a href="advanced-aesthetics.html#cb53-14"></a><span class="st">  </span><span class="kw">gather</span>(<span class="dt">key=</span><span class="st">&#39;metric&#39;</span>, <span class="dt">value=</span><span class="st">&#39;value&#39;</span>, degree<span class="op">:</span>cluster) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb53-15"><a href="advanced-aesthetics.html#cb53-15"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">metric =</span> <span class="kw">factor</span>(metric, <span class="dt">levels=</span><span class="kw">c</span>(<span class="st">&#39;degree&#39;</span>, <span class="st">&#39;eigen&#39;</span>, <span class="st">&#39;betweenness&#39;</span>, <span class="st">&#39;cluster&#39;</span>))) </span>
<span id="cb53-16"><a href="advanced-aesthetics.html#cb53-16"></a></span>
<span id="cb53-17"><a href="advanced-aesthetics.html#cb53-17"></a><span class="kw">tm_shape</span>(us_states) <span class="op">+</span><span class="st">  </span></span>
<span id="cb53-18"><a href="advanced-aesthetics.html#cb53-18"></a><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha=</span><span class="dv">0</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb53-19"><a href="advanced-aesthetics.html#cb53-19"></a><span class="st">  </span><span class="kw">tm_shape</span>(MafiaSpatial) <span class="op">+</span></span>
<span id="cb53-20"><a href="advanced-aesthetics.html#cb53-20"></a><span class="st">  </span><span class="kw">tm_facets</span>(<span class="dt">by=</span><span class="st">&#39;metric&#39;</span>, <span class="dt">free.coords=</span>F, <span class="dt">free.scales =</span> T) <span class="op">+</span><span class="st"> </span></span>
<span id="cb53-21"><a href="advanced-aesthetics.html#cb53-21"></a><span class="st">  </span><span class="kw">tm_symbols</span>(<span class="dt">size=</span><span class="st">&quot;value&quot;</span>, <span class="dt">scale=</span><span class="dv">1</span>, </span>
<span id="cb53-22"><a href="advanced-aesthetics.html#cb53-22"></a>             <span class="dt">col=</span><span class="st">&#39;lightblue&#39;</span>, <span class="dt">border.col=</span><span class="st">&#39;#6698CC&#39;</span>, </span>
<span id="cb53-23"><a href="advanced-aesthetics.html#cb53-23"></a>             <span class="dt">title.size=</span><span class="kw">c</span>(<span class="st">&#39;Measure of Power&#39;</span>)) <span class="op">+</span></span>
<span id="cb53-24"><a href="advanced-aesthetics.html#cb53-24"></a><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">panel.labels =</span> <span class="kw">c</span>(<span class="st">&#39;Degree Centrality&#39;</span>, <span class="st">&#39;Eigenvector Centrality&#39;</span>,</span>
<span id="cb53-25"><a href="advanced-aesthetics.html#cb53-25"></a>                             <span class="st">&#39;Betweenness Centrality&#39;</span>, <span class="st">&#39;Clustering Coefficient&#39;</span>))</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-50-1.png" width="672" /></p>
</div>
<div id="interactive-maps" class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> Interactive Maps</h2>
<p><code>tmap</code> allows users to view their maps in interactive modes with pre-defined Leaflet basemap styles, such as OpenStreetMap, Esri.WorldGrayCanvas, and Esri.WorldTopoMap. This is a quick and easy way to generate preliminary maps with base maps for presentations and illustrations. The interactive mode can also help you examine your data in a spatial context by adding pop up labels or hover labels.</p>
<p>You can also publish your <code>tmap</code> interactive map to web through RPub under your account. As an example, copy and paste the following code in a <code>Rmd</code> file. You can create <code>Rmd</code> file from Rstudio File-&gt;New File-&gt;R Markdown. In R Markdown, <code>Knit</code> the file and the option to <code>Publish</code> should appear. You can select the RPub option and create a free account. See <a href="https://nceas.github.io/oss-lessons/publishing-maps-to-the-web-in-r/publishing-maps-to-the-web-in-r.html">this post</a> for more details. At the moment, the interactive map from <code>tmap</code> did not have the function to adapt the node size with the zoom level. This function exists in <code>Leaflet</code> package with <code>addCircleMarkers()</code> function (more details see this <a href="https://rstudio.github.io/leaflet/markers.html">tutorial</a>)</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb54-1"><a href="advanced-aesthetics.html#cb54-1"></a><span class="co">#### ---- Uncomment the commented lines below in R markdown ----- #### </span></span>
<span id="cb54-2"><a href="advanced-aesthetics.html#cb54-2"></a></span>
<span id="cb54-3"><a href="advanced-aesthetics.html#cb54-3"></a><span class="co">#---</span></span>
<span id="cb54-4"><a href="advanced-aesthetics.html#cb54-4"></a><span class="co">#output: html_document</span></span>
<span id="cb54-5"><a href="advanced-aesthetics.html#cb54-5"></a><span class="co">#---</span></span>
<span id="cb54-6"><a href="advanced-aesthetics.html#cb54-6"></a></span>
<span id="cb54-7"><a href="advanced-aesthetics.html#cb54-7"></a><span class="co">#```{r warning=FALSE, message=FALSE, echo=TRUE, eval=FALSE}</span></span>
<span id="cb54-8"><a href="advanced-aesthetics.html#cb54-8"></a></span>
<span id="cb54-9"><a href="advanced-aesthetics.html#cb54-9"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb54-10"><a href="advanced-aesthetics.html#cb54-10"></a><span class="kw">library</span>(sf)</span>
<span id="cb54-11"><a href="advanced-aesthetics.html#cb54-11"></a><span class="kw">library</span>(tmap)</span>
<span id="cb54-12"><a href="advanced-aesthetics.html#cb54-12"></a><span class="kw">library</span>(SSNtools)</span>
<span id="cb54-13"><a href="advanced-aesthetics.html#cb54-13"></a><span class="kw">library</span>(igraph)</span>
<span id="cb54-14"><a href="advanced-aesthetics.html#cb54-14"></a></span>
<span id="cb54-15"><a href="advanced-aesthetics.html#cb54-15"></a>MafiaSpatial =<span class="st"> </span>MafiaNodes <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb54-16"><a href="advanced-aesthetics.html#cb54-16"></a><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords=</span><span class="kw">c</span>(<span class="st">&quot;LonX&quot;</span>, <span class="st">&quot;LatY&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>) </span>
<span id="cb54-17"><a href="advanced-aesthetics.html#cb54-17"></a>g =<span class="st"> </span><span class="kw">graph_from_data_frame</span>(MafiaEdges, <span class="dt">directed =</span> <span class="ot">FALSE</span>, <span class="dt">vertices=</span>MafiaSpatial)</span>
<span id="cb54-18"><a href="advanced-aesthetics.html#cb54-18"></a>MafiaSpatial<span class="op">$</span>degree =<span class="st"> </span><span class="kw">degree</span>(g)</span>
<span id="cb54-19"><a href="advanced-aesthetics.html#cb54-19"></a></span>
<span id="cb54-20"><a href="advanced-aesthetics.html#cb54-20"></a><span class="co">#set tmap_mode to &#39;view&#39; will enable interactive mode in Rstudio Plots window</span></span>
<span id="cb54-21"><a href="advanced-aesthetics.html#cb54-21"></a><span class="kw">tmap_mode</span>(<span class="st">&#39;view&#39;</span>)</span>
<span id="cb54-22"><a href="advanced-aesthetics.html#cb54-22"></a><span class="kw">tm_shape</span>(MafiaSpatial) <span class="op">+</span></span>
<span id="cb54-23"><a href="advanced-aesthetics.html#cb54-23"></a><span class="st">  </span><span class="kw">tm_symbols</span>(<span class="dt">size=</span><span class="st">&quot;degree&quot;</span>, <span class="dt">scale=</span><span class="dv">5</span>, </span>
<span id="cb54-24"><a href="advanced-aesthetics.html#cb54-24"></a>             <span class="dt">col=</span><span class="st">&#39;lightblue&#39;</span>, <span class="dt">border.col=</span><span class="st">&#39;#6698CC&#39;</span>, </span>
<span id="cb54-25"><a href="advanced-aesthetics.html#cb54-25"></a>             <span class="dt">title.size=</span><span class="kw">c</span>(<span class="st">&#39;Degree of Connections&#39;</span>), </span>
<span id="cb54-26"><a href="advanced-aesthetics.html#cb54-26"></a>             <span class="co">#determine the hover label</span></span>
<span id="cb54-27"><a href="advanced-aesthetics.html#cb54-27"></a>             <span class="dt">id =</span> <span class="st">&#39;NiceLabel&#39;</span>,  </span>
<span id="cb54-28"><a href="advanced-aesthetics.html#cb54-28"></a>             <span class="co">#determine the pop up contents</span></span>
<span id="cb54-29"><a href="advanced-aesthetics.html#cb54-29"></a>             <span class="dt">popup.vars =</span> <span class="kw">c</span>(<span class="st">&#39;Name: &#39;</span>=<span class="st">&#39;NiceLabel&#39;</span>, <span class="st">&#39;Mafia Family: &#39;</span>=<span class="st">&#39;Family&#39;</span>, </span>
<span id="cb54-30"><a href="advanced-aesthetics.html#cb54-30"></a>                            <span class="st">&#39;Degree of Connections: &#39;</span>=<span class="st">&#39;degree&#39;</span>)) <span class="op">+</span></span>
<span id="cb54-31"><a href="advanced-aesthetics.html#cb54-31"></a><span class="st">  </span><span class="co">#add a function where you can see coordinates on mouseover</span></span>
<span id="cb54-32"><a href="advanced-aesthetics.html#cb54-32"></a><span class="st">  </span><span class="kw">tm_mouse_coordinates</span>()</span>
<span id="cb54-33"><a href="advanced-aesthetics.html#cb54-33"></a></span>
<span id="cb54-34"><a href="advanced-aesthetics.html#cb54-34"></a><span class="co">#```</span></span></code></pre></div>
<p>This is an <a href="https://rpubs.com/xiaofanliang/831192">example publish</a> to RPub and what the output will look like. Click and hover your mouse in the map to explore the pop up labels and see the changing coordinates on the top left corner. You can also switch the base map style in the box below the zoom functions.
<iframe src="Interactive/interactive_tmap_to_web.html" width="100%" height="400vh"></iframe></p>
<p>You may notice in the tmap interactive map above that when you zoom in, the node size did not change, which makes it difficult to exam areas with clustered nodes (e.g., New York City). For more advanced interactive map functions, we suggest users swtich to <code>Leaflet</code>, which is an open-source library for web-based interactive maps. The following codes generate an interactive map in R and allows users to see the name of the Mafia members when hover over the nodes. The node size dynamically adjusts when you zoom and out of the map. For ideas to reduce node cluttering in the static map, refer to <a href="advanced-aesthetics.html#inset-map">Inset Map</a>.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb55-1"><a href="advanced-aesthetics.html#cb55-1"></a><span class="kw">library</span>(leaflet)</span>
<span id="cb55-2"><a href="advanced-aesthetics.html#cb55-2"></a></span>
<span id="cb55-3"><a href="advanced-aesthetics.html#cb55-3"></a><span class="kw">leaflet</span>(MafiaSpatial) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">addTiles</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb55-4"><a href="advanced-aesthetics.html#cb55-4"></a><span class="st">  </span><span class="kw">addCircleMarkers</span>(<span class="dt">radius =</span> <span class="op">~</span><span class="st"> </span><span class="kw">sqrt</span>(degree), <span class="dt">fillColor=</span><span class="st">&#39;#6698CC&#39;</span>, <span class="dt">fillOpacity =</span> <span class="fl">0.8</span>, <span class="dt">label=</span><span class="op">~</span><span class="kw">htmlEscape</span>(NiceLabel)) </span></code></pre></div>
<iframe src="Interactive/Leaflet.html" width="100%" height="400vh"></iframe>
</div>
<div id="base-map" class="section level2" number="5.4">
<h2><span class="header-section-number">5.4</span> Base Map</h2>
<p>While interactive map comes with base maps, you can manually add base map into static maps in <code>tmap</code>. This section shows you how to add <strong>Mapbox base map</strong> to <code>tmap</code> map in the plot mode. To use Mapbox base map, you need to create a token on Mapbox. Follow the instructions on <a href="https://docs.mapbox.com/help/getting-started/access-tokens/">Mapbox Docs</a> to create your access token. You should keep this token private.</p>
<p>We use <code>st_bbox</code> to find the bounding box of U.S. states and use the <code>get_Mapbox</code> function to retrieve Mapbox base map based on the input bounding box information. This base map raster can be visualized by <code>tmap</code> through <code>tm_rgb()</code>.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb56-1"><a href="advanced-aesthetics.html#cb56-1"></a><span class="kw">library</span>(tigris)</span>
<span id="cb56-2"><a href="advanced-aesthetics.html#cb56-2"></a><span class="kw">library</span>(OpenStreetMap)</span>
<span id="cb56-3"><a href="advanced-aesthetics.html#cb56-3"></a><span class="kw">library</span>(stars)</span>
<span id="cb56-4"><a href="advanced-aesthetics.html#cb56-4"></a><span class="kw">library</span>(sf)</span>
<span id="cb56-5"><a href="advanced-aesthetics.html#cb56-5"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb56-6"><a href="advanced-aesthetics.html#cb56-6"></a></span>
<span id="cb56-7"><a href="advanced-aesthetics.html#cb56-7"></a><span class="co">#bb: bounding box in st_bbox format. </span></span>
<span id="cb56-8"><a href="advanced-aesthetics.html#cb56-8"></a><span class="co">#token: your Mapbox token </span></span>
<span id="cb56-9"><a href="advanced-aesthetics.html#cb56-9"></a><span class="co">#style: Mapbox base map style. You can also insert customized style from Mapbox. </span></span>
<span id="cb56-10"><a href="advanced-aesthetics.html#cb56-10"></a></span>
<span id="cb56-11"><a href="advanced-aesthetics.html#cb56-11"></a>token =<span class="st"> &#39;YOUR MAPBOX TOKEN&#39;</span></span>
<span id="cb56-12"><a href="advanced-aesthetics.html#cb56-12"></a></span>
<span id="cb56-13"><a href="advanced-aesthetics.html#cb56-13"></a>get_Mapbox =<span class="st"> </span><span class="cf">function</span>(bb, token, style) {</span>
<span id="cb56-14"><a href="advanced-aesthetics.html#cb56-14"></a>  apiKey &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;?access_token=&quot;</span>, token)</span>
<span id="cb56-15"><a href="advanced-aesthetics.html#cb56-15"></a>  baseUrl &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;https://api.mapbox.com/styles/v1/mapbox/&quot;</span>, style,</span>
<span id="cb56-16"><a href="advanced-aesthetics.html#cb56-16"></a>                    <span class="st">&quot;/tiles/256/{z}/{x}/{y}&quot;</span>)</span>
<span id="cb56-17"><a href="advanced-aesthetics.html#cb56-17"></a>  <span class="co">#coordinate for upper left</span></span>
<span id="cb56-18"><a href="advanced-aesthetics.html#cb56-18"></a>  ul  &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">attributes</span>(bb)<span class="op">$</span>bbox<span class="op">$</span>ymax,<span class="kw">attributes</span>(bb)<span class="op">$</span>bbox<span class="op">$</span>xmin) </span>
<span id="cb56-19"><a href="advanced-aesthetics.html#cb56-19"></a>  <span class="co">#coordinate for lower right </span></span>
<span id="cb56-20"><a href="advanced-aesthetics.html#cb56-20"></a>  lr &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">attributes</span>(bb)<span class="op">$</span>bbox<span class="op">$</span>ymin,<span class="kw">attributes</span>(bb)<span class="op">$</span>bbox<span class="op">$</span>xmax) </span>
<span id="cb56-21"><a href="advanced-aesthetics.html#cb56-21"></a>  map &lt;-<span class="st"> </span><span class="kw">openmap</span>(ul,lr, <span class="dt">minNumTiles=</span><span class="dv">10</span>, <span class="dt">type=</span><span class="kw">paste0</span>(baseUrl,apiKey))</span>
<span id="cb56-22"><a href="advanced-aesthetics.html#cb56-22"></a>  <span class="co">#process map into stars to be mapped in tmap </span></span>
<span id="cb56-23"><a href="advanced-aesthetics.html#cb56-23"></a>  map =<span class="st"> </span><span class="kw">st_as_stars</span>(map)</span>
<span id="cb56-24"><a href="advanced-aesthetics.html#cb56-24"></a>  <span class="kw">return</span>(map)</span>
<span id="cb56-25"><a href="advanced-aesthetics.html#cb56-25"></a>}</span>
<span id="cb56-26"><a href="advanced-aesthetics.html#cb56-26"></a></span>
<span id="cb56-27"><a href="advanced-aesthetics.html#cb56-27"></a><span class="co">#states is a function in tigris to download U.S. state boundary shapefile</span></span>
<span id="cb56-28"><a href="advanced-aesthetics.html#cb56-28"></a>us_states =<span class="st"> </span><span class="kw">states</span>(<span class="dt">cb=</span><span class="ot">TRUE</span>, <span class="dt">progress_bar =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span></span>
<span id="cb56-29"><a href="advanced-aesthetics.html#cb56-29"></a><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>STUSPS <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;PR&#39;</span>,<span class="st">&#39;AS&#39;</span>, <span class="st">&#39;AK&#39;</span>, <span class="st">&#39;GU&#39;</span>,<span class="st">&#39;MP&#39;</span>,<span class="st">&#39;VI&#39;</span>, <span class="st">&#39;HI&#39;</span>)) </span>
<span id="cb56-30"><a href="advanced-aesthetics.html#cb56-30"></a></span>
<span id="cb56-31"><a href="advanced-aesthetics.html#cb56-31"></a>box =<span class="st"> </span><span class="kw">st_bbox</span>(us_states, <span class="dt">crs=</span><span class="dv">4326</span>) </span>
<span id="cb56-32"><a href="advanced-aesthetics.html#cb56-32"></a>bg =<span class="st"> </span><span class="kw">get_Mapbox</span>(box <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sfc</span>(), token, <span class="st">&#39;light-v10&#39;</span>)</span>
<span id="cb56-33"><a href="advanced-aesthetics.html#cb56-33"></a></span>
<span id="cb56-34"><a href="advanced-aesthetics.html#cb56-34"></a><span class="kw">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb56-35"><a href="advanced-aesthetics.html#cb56-35"></a>map =<span class="st"> </span><span class="kw">tm_shape</span>(bg) <span class="op">+</span><span class="st"> </span></span>
<span id="cb56-36"><a href="advanced-aesthetics.html#cb56-36"></a><span class="st">  </span><span class="kw">tm_rgb</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb56-37"><a href="advanced-aesthetics.html#cb56-37"></a><span class="st">  </span><span class="kw">tm_shape</span>(us_states) <span class="op">+</span><span class="st"> </span></span>
<span id="cb56-38"><a href="advanced-aesthetics.html#cb56-38"></a><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha=</span><span class="dv">0</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb56-39"><a href="advanced-aesthetics.html#cb56-39"></a><span class="st">  </span><span class="kw">tm_shape</span>(MafiaSpatial) <span class="op">+</span></span>
<span id="cb56-40"><a href="advanced-aesthetics.html#cb56-40"></a><span class="st">  </span><span class="kw">tm_symbols</span>(<span class="dt">size=</span><span class="st">&quot;degree&quot;</span>, <span class="dt">scale=</span><span class="dv">5</span>, </span>
<span id="cb56-41"><a href="advanced-aesthetics.html#cb56-41"></a>             <span class="dt">col=</span><span class="st">&#39;lightblue&#39;</span>, <span class="dt">border.col=</span><span class="st">&#39;#6698CC&#39;</span>, </span>
<span id="cb56-42"><a href="advanced-aesthetics.html#cb56-42"></a>             <span class="dt">title.size=</span><span class="kw">c</span>(<span class="st">&#39;Degree of Connections&#39;</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb56-43"><a href="advanced-aesthetics.html#cb56-43"></a><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="st">&#39;left&#39;</span>, <span class="st">&#39;bottom&#39;</span>))</span>
<span id="cb56-44"><a href="advanced-aesthetics.html#cb56-44"></a></span>
<span id="cb56-45"><a href="advanced-aesthetics.html#cb56-45"></a>map</span></code></pre></div>
<p>You can find all the available Mapbox style <a href="https://docs.mapbox.com/api/maps/styles/">here</a>. You can also customize your Mapbox basemap in <a href="https://studio.mapbox.com/">Mapbox Studio</a>. To use the customized base map, replace the baseUrl in the function with your customized style URL (only replace path after <a href="https://api.mapbox.com/styles/" class="uri">https://api.mapbox.com/styles/</a>), which you can find if you click “share” button for your customized style. This shows the output of the code above with Mapbox style: <code>light-v10</code> (top left), <code>dark-v10</code> (top right), <code>outdoors-v11</code> (bottom left), <code>satellite-v9</code> (bottom right).</p>
<p><img src="Figs/05-aesthetics-1.png" width="50%" /><img src="Figs/05-aesthetics-2.png" width="50%" /><img src="Figs/05-aesthetics-3.png" width="50%" /><img src="Figs/05-aesthetics-4.png" width="50%" /></p>
<p>Sometimes you may want a customized bounding box that is not based on data layer. A helpful tool to find the coordinates around your data is to visualize your data in the interactive mode with <code>tm_mouse_coordinates()</code> (see example above). You can also specify the bounding box of your base map using the following code:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb57-1"><a href="advanced-aesthetics.html#cb57-1"></a><span class="co">#remember to add crs argument for specialized coordinates</span></span>
<span id="cb57-2"><a href="advanced-aesthetics.html#cb57-2"></a>box =<span class="st"> </span><span class="kw">st_bbox</span>(<span class="kw">c</span>(<span class="dt">xmin=</span><span class="op">-</span><span class="fl">77.25586</span>, <span class="dt">xmax=</span><span class="fl">41.82353</span>, <span class="dt">ymin=</span><span class="op">-</span><span class="fl">71.10352</span>, <span class="dt">ymax=</span><span class="fl">38.94553</span>), <span class="dt">crs=</span><span class="dv">4326</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sfc</span>()</span></code></pre></div>
</div>
<div id="inset-map" class="section level2" number="5.5">
<h2><span class="header-section-number">5.5</span> Inset Map</h2>
<p>From the current mafia member map we can see that a lot of the mafia members cluster around the New York City region. We are not able to see the details in that areas due to cluttered nodes. This is a common problem at mapping spatial social networks when you have a both regional and local social connections.</p>
<p>To decide on the Inset Map bounding box, you can either use the measurement from other shapefiles (e.g., NYC five boroughs) or use <code>tm_mouse_coordinates()</code> (see example in Interactive Map) to identify ideal bounding box. The example below uses information picked up by the <code>tm_mouse_coordinates()</code>.</p>
<p>First, we need to create the inset map. We pick a bounding box around the central New York City including where the most connected mafia member (in degree of connections) locates. We also calculate <em>aspect_ratio</em> for the inset map so that when plugged into the background map, we can preserve the inset map’s natural ratio of height and width.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb58-1"><a href="advanced-aesthetics.html#cb58-1"></a><span class="co">#Create the bounding box for the inset map and retrieve corresponding base map </span></span>
<span id="cb58-2"><a href="advanced-aesthetics.html#cb58-2"></a>bgbox =<span class="st"> </span><span class="kw">st_bbox</span>(<span class="kw">c</span>(<span class="dt">xmin=</span><span class="op">-</span><span class="fl">74.065141</span>, <span class="dt">xmax=</span><span class="op">-</span><span class="fl">73.537727</span>, <span class="dt">ymin=</span><span class="fl">40.558198</span>, <span class="dt">ymax=</span><span class="fl">40.882353</span>), <span class="dt">crs=</span><span class="dv">4326</span>) </span>
<span id="cb58-3"><a href="advanced-aesthetics.html#cb58-3"></a>inset_bg =<span class="st"> </span><span class="kw">get_Mapbox</span>(bgbox <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sfc</span>(), token, <span class="st">&#39;light-v10&#39;</span>)</span>
<span id="cb58-4"><a href="advanced-aesthetics.html#cb58-4"></a></span>
<span id="cb58-5"><a href="advanced-aesthetics.html#cb58-5"></a><span class="co">#Calculate aspect ratio.  </span></span>
<span id="cb58-6"><a href="advanced-aesthetics.html#cb58-6"></a>aspect_ratio =<span class="st"> </span><span class="kw">unname</span>((bgbox<span class="op">$</span>ymax <span class="op">-</span><span class="st"> </span>bgbox<span class="op">$</span>ymin)<span class="op">/</span>(bgbox<span class="op">$</span>xmax <span class="op">-</span><span class="st"> </span>bgbox<span class="op">$</span>xmin))</span>
<span id="cb58-7"><a href="advanced-aesthetics.html#cb58-7"></a></span>
<span id="cb58-8"><a href="advanced-aesthetics.html#cb58-8"></a><span class="co">#putting base map as the first layer restricts the bounding box of the map, so no additional filtering for MafiaSpatial is needed.</span></span>
<span id="cb58-9"><a href="advanced-aesthetics.html#cb58-9"></a><span class="kw">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb58-10"><a href="advanced-aesthetics.html#cb58-10"></a>inset =<span class="st"> </span><span class="kw">tm_shape</span>(inset_bg) <span class="op">+</span></span>
<span id="cb58-11"><a href="advanced-aesthetics.html#cb58-11"></a><span class="st">  </span><span class="kw">tm_rgb</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb58-12"><a href="advanced-aesthetics.html#cb58-12"></a><span class="st">  </span><span class="kw">tm_shape</span>(MafiaSpatial) <span class="op">+</span><span class="st"> </span></span>
<span id="cb58-13"><a href="advanced-aesthetics.html#cb58-13"></a><span class="st">  </span><span class="kw">tm_symbols</span>(<span class="dt">size=</span><span class="st">&quot;degree&quot;</span>, <span class="dt">scale=</span><span class="dv">2</span>, </span>
<span id="cb58-14"><a href="advanced-aesthetics.html#cb58-14"></a>             <span class="dt">col=</span><span class="st">&#39;lightblue&#39;</span>, <span class="dt">border.col=</span><span class="st">&#39;#6698CC&#39;</span>, </span>
<span id="cb58-15"><a href="advanced-aesthetics.html#cb58-15"></a>             <span class="dt">title.size=</span><span class="kw">c</span>(<span class="st">&#39;Degree of Connections&#39;</span>),</span>
<span id="cb58-16"><a href="advanced-aesthetics.html#cb58-16"></a>             <span class="dt">legend.size.show =</span> <span class="ot">FALSE</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb58-17"><a href="advanced-aesthetics.html#cb58-17"></a><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">main.title=</span><span class="st">&#39;Inset of New York&#39;</span>,</span>
<span id="cb58-18"><a href="advanced-aesthetics.html#cb58-18"></a>            <span class="dt">main.title.fontface =</span> <span class="dv">2</span>,</span>
<span id="cb58-19"><a href="advanced-aesthetics.html#cb58-19"></a>            <span class="dt">main.title.position =</span> <span class="kw">c</span>(<span class="st">&#39;center&#39;</span>, <span class="st">&#39;top&#39;</span>))</span></code></pre></div>
<p>Then, we use <code>tmap_save</code> to export the background map <code>map</code> created in the <a href="advanced-aesthetics.html#base-map">Base Map</a> section with the inset map. <code>viewport</code> function comes from the <code>grid</code> package and can be used to position the inset map on the background map. We set an arbitrary value for width and adjust the height according to the aspect ratio of the inset map to preserve its shape. You also can create multiple inset maps and pass to the <code>insets_tm</code> argument as a list (e.g., <code>insets_tm = list(inset1, inset2)</code>). Same for <code>insets_vp</code>. You can pass a list of viewport (e.g., <code>insets_vp = list(viewport(X), viewport(Y))</code>).</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb59-1"><a href="advanced-aesthetics.html#cb59-1"></a><span class="co">#library(grid)</span></span>
<span id="cb59-2"><a href="advanced-aesthetics.html#cb59-2"></a><span class="kw">tmap_save</span>(map, <span class="dt">insets_tm=</span>inset, </span>
<span id="cb59-3"><a href="advanced-aesthetics.html#cb59-3"></a>          <span class="dt">insets_vp =</span> <span class="kw">viewport</span>(<span class="fl">0.17</span>, <span class="fl">0.75</span>, <span class="dt">width =</span> <span class="dv">1</span>, <span class="dt">height =</span> aspect_ratio<span class="op">*</span><span class="fl">0.75</span>),</span>
<span id="cb59-4"><a href="advanced-aesthetics.html#cb59-4"></a>          <span class="dt">filename=</span><span class="st">&#39;PATH&#39;</span>, <span class="dt">dpi=</span><span class="dv">600</span>)</span></code></pre></div>
<p><img src="Figs/05-aesthetics-inset.png" width="100%" /></p>
<p>We can also add a small black bounding box on the background map to indicate where the inset map locates. We also increase the line width of the frame of the inset map to visually match with the aesthetic of the bounding box.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb60-1"><a href="advanced-aesthetics.html#cb60-1"></a>inset =<span class="st"> </span>inset <span class="op">+</span><span class="st"> </span><span class="kw">tm_layout</span>(<span class="dt">frame=</span><span class="ot">TRUE</span>, <span class="dt">frame.lwd =</span> <span class="dv">2</span>)</span>
<span id="cb60-2"><a href="advanced-aesthetics.html#cb60-2"></a></span>
<span id="cb60-3"><a href="advanced-aesthetics.html#cb60-3"></a>map =<span class="st"> </span>map <span class="op">+</span><span class="st"> </span><span class="kw">tm_shape</span>(<span class="kw">st_bbox</span>(inset_bg) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sfc</span>()) <span class="op">+</span><span class="st"> </span></span>
<span id="cb60-4"><a href="advanced-aesthetics.html#cb60-4"></a><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha=</span><span class="dv">0</span>, <span class="dt">border.col =</span> <span class="st">&#39;black&#39;</span>, <span class="dt">lwd=</span><span class="dv">2</span>)</span>
<span id="cb60-5"><a href="advanced-aesthetics.html#cb60-5"></a></span>
<span id="cb60-6"><a href="advanced-aesthetics.html#cb60-6"></a><span class="kw">tmap_save</span>(map, <span class="dt">insets_tm=</span>inset, </span>
<span id="cb60-7"><a href="advanced-aesthetics.html#cb60-7"></a>          <span class="dt">insets_vp =</span> <span class="kw">viewport</span>(<span class="fl">0.17</span>, <span class="fl">0.75</span>, <span class="dt">width =</span> <span class="dv">1</span>, <span class="dt">height =</span> aspect_ratio<span class="op">*</span><span class="fl">0.75</span>),</span>
<span id="cb60-8"><a href="advanced-aesthetics.html#cb60-8"></a>          <span class="dt">filename=</span><span class="st">&#39;PATH&#39;</span>, <span class="dt">dpi=</span><span class="dv">600</span>)</span></code></pre></div>
<p><img src="Figs/05-aesthetics-inset_w_box.png" width="100%" /></p>
</div>
<div id="edge-bundling" class="section level2" number="5.6">
<h2><span class="header-section-number">5.6</span> Edge Bundling</h2>
<p>Edge bundling is a technique to reduce visual cluttering of the edges. The algorithm behind edge bundling essentially <strong>bundles</strong> edges that go in the same direction and <strong>split</strong> them apart when they are close to their destinations. The algorithm of a complete edge bundling technique has three steps: first, it clusters edges based on their origin and destination; second, it calculates how to bend the geometry of a straight line given the user input of how “strong” you want the bundle to be. A stronger bundle means that you want more edges and edges far from the bundle to be bundled together; third, the algorithm may summarise the weights of the bundled edges so that the weight of the resultant bundle is larger (and thus visually thicker). You can implement edge bundling in <a href="https://anitagraser.com/2017/10/08/movement-data-in-gis-8-edge-bundling-for-flow-maps/">QGIS2</a> or <a href="https://bl.ocks.org/sjengle/2e58e83685f6d854aa40c7bc546aeb24">D3</a> or <a href="https://github.com/ait-energy/qgis-edge-bundling">Python</a>.</p>
<p>This technique may help reveal structures in your edges when there are many lines, especially if you believe your edges follow a hierarchical structure, yet <strong>it is not a savior to your flow map</strong>. You should use this technique with caution because it has the following drawbacks:</p>
<ul>
<li>It takes a long time to do edge bundling. We recommend running our codes on a network with 1000-3000 edges to get quick feedback on the visual output.</li>
<li>It may bend the edges in unnatural ways.</li>
<li>It may be difficult to tell exactly where the edge come from and go to after you bend the edges.</li>
<li>It may be difficult to visualize directionality in the flow map.</li>
<li>You have to manually tune the parameters (<code>thres</code> in our case) to find the best visual outcome. There is no shortcut to find the optimized parameters at once.</li>
<li>Some edge bundling package may only be able to bend the lines, but not summarise the edge weights. It means that it is difficult to visualize the edge weight of the bundle.</li>
</ul>
<p>The <code>edgebundle</code> package we used is still in development. We showed an example of applying the edgebundle package on the mafia map. To reduce the processing time, we filtered mafia connections to those that have more than 50km in euclidean distance, which results in 1668 edges. To filter by distance, we have to convert the coordinate system to <strong>North America Equidistant Conic</strong> (crs=102010), use <code>st_distance</code> to compute the distance between two point geometry, and lastly convert the <code>meter object</code> from <code>st_distance</code> into numeric numbers for filtering. <strong>It is important to note that you set <code>by_element=TRUE</code> in <code>st_distance</code> so that the output of the function is a vector rather than a matrix. The unit of the distance also follows the coordinate projection system you use</strong>.</p>
<p>This is a mafia connectivity map without the edge bundling.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb61-1"><a href="advanced-aesthetics.html#cb61-1"></a><span class="co">#MafiaEdges and MafiaNodes is a built-in dataset of SSNtools package </span></span>
<span id="cb61-2"><a href="advanced-aesthetics.html#cb61-2"></a></span>
<span id="cb61-3"><a href="advanced-aesthetics.html#cb61-3"></a>MafiaSpatial =<span class="st"> </span>MafiaNodes <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb61-4"><a href="advanced-aesthetics.html#cb61-4"></a><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords=</span><span class="kw">c</span>(<span class="st">&quot;LonX&quot;</span>, <span class="st">&quot;LatY&quot;</span>), <span class="dt">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb61-5"><a href="advanced-aesthetics.html#cb61-5"></a></span>
<span id="cb61-6"><a href="advanced-aesthetics.html#cb61-6"></a><span class="co">#Filter MafiaEdges to edges that have more than 50km. </span></span>
<span id="cb61-7"><a href="advanced-aesthetics.html#cb61-7"></a>FilteredEdges =<span class="st"> </span>MafiaEdges <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb61-8"><a href="advanced-aesthetics.html#cb61-8"></a><span class="st">  </span><span class="kw">left_join</span>(MafiaSpatial <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">c</span>(NODE, geometry)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="dt">crs=</span><span class="dv">102010</span>), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;Source&#39;</span> =<span class="st"> &#39;NODE&#39;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb61-9"><a href="advanced-aesthetics.html#cb61-9"></a><span class="st">  </span><span class="kw">left_join</span>(MafiaSpatial <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">c</span>(NODE, geometry)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_transform</span>(<span class="dt">crs=</span><span class="dv">102010</span>), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;Target&#39;</span> =<span class="st"> &#39;NODE&#39;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb61-10"><a href="advanced-aesthetics.html#cb61-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">distance =</span> <span class="kw">st_distance</span>(geometry.x, geometry.y, <span class="dt">by_element=</span><span class="ot">TRUE</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb61-11"><a href="advanced-aesthetics.html#cb61-11"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(geometry.x, geometry.y)) <span class="op">%&gt;%</span></span>
<span id="cb61-12"><a href="advanced-aesthetics.html#cb61-12"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">distance =</span> <span class="kw">as.numeric</span>(distance)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb61-13"><a href="advanced-aesthetics.html#cb61-13"></a><span class="st">  </span><span class="kw">filter</span>(distance <span class="op">&gt;</span><span class="st"> </span><span class="dv">50000</span>)</span>
<span id="cb61-14"><a href="advanced-aesthetics.html#cb61-14"></a></span>
<span id="cb61-15"><a href="advanced-aesthetics.html#cb61-15"></a>g =<span class="st"> </span><span class="kw">graph_from_data_frame</span>(MafiaEdges, <span class="dt">directed =</span> <span class="ot">FALSE</span>)</span>
<span id="cb61-16"><a href="advanced-aesthetics.html#cb61-16"></a>MafiaSpatial<span class="op">$</span>degree =<span class="st"> </span><span class="kw">degree</span>(g)</span>
<span id="cb61-17"><a href="advanced-aesthetics.html#cb61-17"></a></span>
<span id="cb61-18"><a href="advanced-aesthetics.html#cb61-18"></a><span class="co">#Convert FilteredEdges dataframe to line geometry. </span></span>
<span id="cb61-19"><a href="advanced-aesthetics.html#cb61-19"></a>EdgeSpatial =<span class="st"> </span>FilteredEdges <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb61-20"><a href="advanced-aesthetics.html#cb61-20"></a><span class="st">  </span><span class="kw">left_join</span>(MafiaSpatial <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">c</span>(NODE, geometry)), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;Source&#39;</span> =<span class="st"> &#39;NODE&#39;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb61-21"><a href="advanced-aesthetics.html#cb61-21"></a><span class="st">  </span><span class="kw">left_join</span>(MafiaSpatial <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">c</span>(NODE, geometry)), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&#39;Target&#39;</span> =<span class="st"> &#39;NODE&#39;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb61-22"><a href="advanced-aesthetics.html#cb61-22"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">geometry =</span> <span class="kw">st_cast</span>(<span class="kw">st_union</span>(geometry.x, geometry.y), <span class="st">&quot;LINESTRING&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb61-23"><a href="advanced-aesthetics.html#cb61-23"></a><span class="st">  </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(geometry.x, geometry.y)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_as_sf</span>()</span>
<span id="cb61-24"><a href="advanced-aesthetics.html#cb61-24"></a></span>
<span id="cb61-25"><a href="advanced-aesthetics.html#cb61-25"></a><span class="kw">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb61-26"><a href="advanced-aesthetics.html#cb61-26"></a>map =<span class="st"> </span><span class="kw">tm_shape</span>(bg) <span class="op">+</span><span class="st"> </span></span>
<span id="cb61-27"><a href="advanced-aesthetics.html#cb61-27"></a><span class="st">  </span><span class="kw">tm_rgb</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb61-28"><a href="advanced-aesthetics.html#cb61-28"></a><span class="st">  </span><span class="kw">tm_shape</span>(us_states) <span class="op">+</span><span class="st"> </span></span>
<span id="cb61-29"><a href="advanced-aesthetics.html#cb61-29"></a><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha=</span><span class="dv">0</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb61-30"><a href="advanced-aesthetics.html#cb61-30"></a><span class="st">  </span><span class="kw">tm_shape</span>(EdgeSpatial) <span class="op">+</span><span class="st"> </span></span>
<span id="cb61-31"><a href="advanced-aesthetics.html#cb61-31"></a><span class="st">  </span><span class="kw">tm_lines</span>(<span class="dt">lwd=</span><span class="fl">0.5</span>, <span class="dt">alpha=</span><span class="fl">0.3</span>, <span class="dt">col=</span><span class="st">&#39;#1B665D&#39;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb61-32"><a href="advanced-aesthetics.html#cb61-32"></a><span class="st">  </span><span class="kw">tm_shape</span>(MafiaSpatial) <span class="op">+</span></span>
<span id="cb61-33"><a href="advanced-aesthetics.html#cb61-33"></a><span class="st">  </span><span class="kw">tm_symbols</span>(<span class="dt">size=</span><span class="st">&quot;degree&quot;</span>, <span class="dt">scale=</span><span class="dv">2</span>, </span>
<span id="cb61-34"><a href="advanced-aesthetics.html#cb61-34"></a>             <span class="dt">col=</span><span class="st">&#39;lightblue&#39;</span>, <span class="dt">border.col=</span><span class="st">&#39;#6698CC&#39;</span>, </span>
<span id="cb61-35"><a href="advanced-aesthetics.html#cb61-35"></a>             <span class="dt">title.size=</span><span class="kw">c</span>(<span class="st">&#39;Degree of Connections&#39;</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb61-36"><a href="advanced-aesthetics.html#cb61-36"></a><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="st">&#39;left&#39;</span>, <span class="st">&#39;bottom&#39;</span>))</span>
<span id="cb61-37"><a href="advanced-aesthetics.html#cb61-37"></a></span>
<span id="cb61-38"><a href="advanced-aesthetics.html#cb61-38"></a>map</span></code></pre></div>
<p><img src="Figs/05-aesthetics-beforeBundle.png" width="100%" /></p>
<p>The map shows clearly that many of the connections are going to New York City. There are also a lot of connections that go stragith from west coast to east coast. Let’s try edge bundling and see if it makes the map better.</p>
<p>The <code>edge_bundle_force</code> function from the <code>edgebundle</code> pacakage takes into three arguments: 1) <code>g</code> which is the network constructed through <code>igraph</code>, 2) <code>xy</code> which is the longitude and latitude of all the nodes in the network, and 3) <code>compatibility_threshold</code> which indicates the strength of the bundling. A higher value means that the bending and the bundling will be less intense. This package <strong>can only bend the edges into bundles</strong> but not beyond that.</p>
<p>The result of the <code>edge_bundle_force</code> returns four columns. <code>x</code> and <code>y</code> are the coordinates of the points that consist of a bundled edge. <code>group</code> indicates that coordinates in the same group are for one bundled edge and <code>index</code> indicates the order of points for that particular bundled edge. We can see that for group 1, the fbundle result starts with the first name in the <code>Source</code> of <code>FilteredEdges</code>, BLANDA-CHARLES (-104.6270, 38.2476), and after 34 points, it will end with the <code>Target</code>, SMALDONE-EUGENE (-104.9479, 39.7681).</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb62-1"><a href="advanced-aesthetics.html#cb62-1"></a><span class="kw">library</span>(edgebundle)</span>
<span id="cb62-2"><a href="advanced-aesthetics.html#cb62-2"></a><span class="co">#FilteredEdges %&gt;% slice(1:3)</span></span>
<span id="cb62-3"><a href="advanced-aesthetics.html#cb62-3"></a><span class="co">#               Source             Target   distance</span></span>
<span id="cb62-4"><a href="advanced-aesthetics.html#cb62-4"></a><span class="co"># 1     BLANDA-CHARLES    SMALDONE-EUGENE   97252.56</span></span>
<span id="cb62-5"><a href="advanced-aesthetics.html#cb62-5"></a><span class="co"># 2     DIVARCO-JOSEPH        SICA-JOSEPH 6054967.18</span></span>
<span id="cb62-6"><a href="advanced-aesthetics.html#cb62-6"></a><span class="co"># 3 DEMARTINO-BENJAMIN DEMARTINO-THEODORE  182989.39</span></span>
<span id="cb62-7"><a href="advanced-aesthetics.html#cb62-7"></a></span>
<span id="cb62-8"><a href="advanced-aesthetics.html#cb62-8"></a><span class="co">#The current EdgeSpatial is line geometry </span></span>
<span id="cb62-9"><a href="advanced-aesthetics.html#cb62-9"></a>bundle_g =<span class="st"> </span><span class="kw">graph_from_data_frame</span>(FilteredEdges, <span class="dt">directed=</span><span class="ot">FALSE</span>)</span>
<span id="cb62-10"><a href="advanced-aesthetics.html#cb62-10"></a>node =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">id =</span> <span class="kw">V</span>(bundle_g)<span class="op">$</span>name) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">id =</span> <span class="kw">as.character</span>(id))</span>
<span id="cb62-11"><a href="advanced-aesthetics.html#cb62-11"></a><span class="co">#&gt;                   id</span></span>
<span id="cb62-12"><a href="advanced-aesthetics.html#cb62-12"></a><span class="co">#&gt; 1     BLANDA-CHARLES</span></span>
<span id="cb62-13"><a href="advanced-aesthetics.html#cb62-13"></a><span class="co">#&gt; 2     DIVARCO-JOSEPH</span></span>
<span id="cb62-14"><a href="advanced-aesthetics.html#cb62-14"></a><span class="co">#&gt; 3 DEMARTINO-BENJAMIN</span></span>
<span id="cb62-15"><a href="advanced-aesthetics.html#cb62-15"></a></span>
<span id="cb62-16"><a href="advanced-aesthetics.html#cb62-16"></a>node =<span class="st"> </span>node <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb62-17"><a href="advanced-aesthetics.html#cb62-17"></a><span class="st">  </span><span class="kw">left_join</span>(MafiaNodes <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">c</span>(NODE, LonX, LatY)), <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;id&#39;</span> =<span class="st"> &#39;NODE&#39;</span>), <span class="dt">copy=</span><span class="ot">FALSE</span>)</span>
<span id="cb62-18"><a href="advanced-aesthetics.html#cb62-18"></a></span>
<span id="cb62-19"><a href="advanced-aesthetics.html#cb62-19"></a><span class="co">#&gt;                   id      LonX    LatY</span></span>
<span id="cb62-20"><a href="advanced-aesthetics.html#cb62-20"></a><span class="co">#&gt; 1     BLANDA-CHARLES -104.6270 38.2476</span></span>
<span id="cb62-21"><a href="advanced-aesthetics.html#cb62-21"></a><span class="co">#&gt; 2     DIVARCO-JOSEPH  -87.7354 42.0154</span></span>
<span id="cb62-22"><a href="advanced-aesthetics.html#cb62-22"></a><span class="co">#&gt; 3 DEMARTINO-BENJAMIN  -72.9263 40.9530</span></span>
<span id="cb62-23"><a href="advanced-aesthetics.html#cb62-23"></a></span>
<span id="cb62-24"><a href="advanced-aesthetics.html#cb62-24"></a>xy =<span class="st"> </span><span class="kw">cbind</span>(node<span class="op">$</span>LonX, node<span class="op">$</span>LatY)</span>
<span id="cb62-25"><a href="advanced-aesthetics.html#cb62-25"></a>fbundle =<span class="st"> </span><span class="kw">edge_bundle_force</span>(bundle_g,xy,<span class="dt">compatibility_threshold =</span> <span class="fl">0.85</span>)</span>
<span id="cb62-26"><a href="advanced-aesthetics.html#cb62-26"></a></span>
<span id="cb62-27"><a href="advanced-aesthetics.html#cb62-27"></a><span class="co">#&gt;           x        y      index group</span></span>
<span id="cb62-28"><a href="advanced-aesthetics.html#cb62-28"></a><span class="co">#&gt; 1 -104.6270 38.24760 0.00000000     1</span></span>
<span id="cb62-29"><a href="advanced-aesthetics.html#cb62-29"></a><span class="co">#&gt; 2 -104.6506 38.30726 0.03030303     1</span></span>
<span id="cb62-30"><a href="advanced-aesthetics.html#cb62-30"></a><span class="co">#&gt; 3 -104.6641 38.33735 0.06060606     1</span></span></code></pre></div>
<p>Thus, to create lines acceptable to <code>tmap</code> from the fbundle result, we need to convert coordinates to points, group by the <code>group</code> column, and summarise the points into lines. It is important that <code>do_union=FALSE</code> argument is set in the <code>summarise()</code> to preserve the order of points (otherwise summarise will rearrange the point order).</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb63-1"><a href="advanced-aesthetics.html#cb63-1"></a>fbundle2 =<span class="st"> </span>fbundle <span class="op">%&gt;%</span></span>
<span id="cb63-2"><a href="advanced-aesthetics.html#cb63-2"></a><span class="st">  </span><span class="kw">st_as_sf</span>(<span class="dt">coords=</span><span class="kw">c</span>(<span class="st">&#39;x&#39;</span>, <span class="st">&#39;y&#39;</span>), <span class="dt">crs=</span><span class="dv">4326</span>) <span class="op">%&gt;%</span></span>
<span id="cb63-3"><a href="advanced-aesthetics.html#cb63-3"></a><span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span></span>
<span id="cb63-4"><a href="advanced-aesthetics.html#cb63-4"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">do_union=</span><span class="ot">FALSE</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">st_cast</span>(<span class="st">&quot;LINESTRING&quot;</span>)</span>
<span id="cb63-5"><a href="advanced-aesthetics.html#cb63-5"></a></span>
<span id="cb63-6"><a href="advanced-aesthetics.html#cb63-6"></a><span class="co">#&gt;   group geometry</span></span>
<span id="cb63-7"><a href="advanced-aesthetics.html#cb63-7"></a><span class="co">#&gt;   &lt;dbl&gt; &lt;LINESTRING [°]&gt;</span></span>
<span id="cb63-8"><a href="advanced-aesthetics.html#cb63-8"></a><span class="co">#&gt; 1     1 (-104.627 38.2476, -104.6506 38.30726, -104.6641 38.33735...)</span></span>
<span id="cb63-9"><a href="advanced-aesthetics.html#cb63-9"></a><span class="co">#&gt; 2     2 (-87.7354 42.0154, -88.8135 41.62707, -89.64513 41.35496 ...)</span></span>
<span id="cb63-10"><a href="advanced-aesthetics.html#cb63-10"></a><span class="co">#&gt; 3     3 (-72.9263 40.953, -72.95451 40.95169, -72.98361 40.94916 ...)</span></span></code></pre></div>
<p>Now the <code>fbundle2</code> is a line shapefile! We can either export to GIS for further editing or map it using <code>tmap</code> package. See <a href="advanced-aesthetics.html#base-map">Base Map</a> on how to create <code>bg</code> background base map and <code>us_states</code> boundary shapefiles.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r Code"><code class="sourceCode r"><span id="cb64-1"><a href="advanced-aesthetics.html#cb64-1"></a><span class="kw">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb64-2"><a href="advanced-aesthetics.html#cb64-2"></a><span class="kw">tm_shape</span>(bg) <span class="op">+</span><span class="st"> </span></span>
<span id="cb64-3"><a href="advanced-aesthetics.html#cb64-3"></a><span class="st">  </span><span class="kw">tm_rgb</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb64-4"><a href="advanced-aesthetics.html#cb64-4"></a><span class="st">  </span><span class="kw">tm_shape</span>(us_states) <span class="op">+</span><span class="st"> </span></span>
<span id="cb64-5"><a href="advanced-aesthetics.html#cb64-5"></a><span class="st">  </span><span class="kw">tm_polygons</span>(<span class="dt">alpha=</span><span class="dv">0</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb64-6"><a href="advanced-aesthetics.html#cb64-6"></a><span class="st">  </span><span class="kw">tm_shape</span>(fbundle2) <span class="op">+</span><span class="st"> </span></span>
<span id="cb64-7"><a href="advanced-aesthetics.html#cb64-7"></a><span class="st">  </span><span class="kw">tm_lines</span>(<span class="dt">lwd=</span><span class="fl">0.5</span>, <span class="dt">alpha=</span><span class="fl">0.3</span>, <span class="dt">col=</span><span class="st">&#39;#1B665D&#39;</span>) <span class="op">+</span><span class="st"> </span></span>
<span id="cb64-8"><a href="advanced-aesthetics.html#cb64-8"></a><span class="st">  </span><span class="kw">tm_shape</span>(MafiaSpatial <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(degree))) <span class="op">+</span></span>
<span id="cb64-9"><a href="advanced-aesthetics.html#cb64-9"></a><span class="st">  </span><span class="kw">tm_symbols</span>(<span class="dt">size=</span><span class="st">&quot;degree&quot;</span>, <span class="dt">scale=</span><span class="dv">2</span>, </span>
<span id="cb64-10"><a href="advanced-aesthetics.html#cb64-10"></a>             <span class="dt">col=</span><span class="st">&#39;lightblue&#39;</span>, <span class="dt">border.col=</span><span class="st">&#39;#6698CC&#39;</span>, </span>
<span id="cb64-11"><a href="advanced-aesthetics.html#cb64-11"></a>             <span class="dt">title.size=</span><span class="kw">c</span>(<span class="st">&#39;Degree of Connections&#39;</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb64-12"><a href="advanced-aesthetics.html#cb64-12"></a><span class="st">  </span><span class="kw">tm_layout</span>(<span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="st">&#39;left&#39;</span>, <span class="st">&#39;bottom&#39;</span>))</span></code></pre></div>
<p><img src="Figs/05-aesthetics-afterBundle.png" width="100%" />
The bundling effect is most obvious when you contrast lines going from Florida to New York. Several edges have been bundled together. However, you can also see some unnatural bends from lines going from Florida to New York City. That is because the lines were bended halfway. In our case of the mafia map, we are not sure the edge bundling improves the visual. Again, edge bundling should be applied with cautions and experiments.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="vizedges.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="advanced-ssn-metrics.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["SSN_tutorial.pdf", "SSN_tutorial.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
