<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Advanced SSN Metrics | Spatial Social Networks (SSN) Visualization and Metrics with R</title>
  <meta name="description" content="This book describes the basic concepts, theories, methods, and visualizations involved to map and analyze spatial networks in R." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Advanced SSN Metrics | Spatial Social Networks (SSN) Visualization and Metrics with R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book describes the basic concepts, theories, methods, and visualizations involved to map and analyze spatial networks in R." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Advanced SSN Metrics | Spatial Social Networks (SSN) Visualization and Metrics with R" />
  
  <meta name="twitter:description" content="This book describes the basic concepts, theories, methods, and visualizations involved to map and analyze spatial networks in R." />
  

<meta name="author" content="Xiaofan Liang, Clio Andris, Dipto Sarkar" />


<meta name="date" content="2023-05-01" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="advanced-aesthetics.html"/>
<link rel="next" href="development.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">SSN Tutorial</a></li>

<li class="divider"></li>
<li><a href="index.html#introduction" id="toc-introduction"><span class="toc-section-number">1</span> Introduction</a></li>
<li><a href="metrics.html#metrics" id="toc-metrics"><span class="toc-section-number">2</span> Network Metrics</a>
<ul>
<li><a href="metrics.html#network-data-formats" id="toc-network-data-formats"><span class="toc-section-number">2.1</span> Network Data Formats</a></li>
<li><a href="metrics.html#network-metrics" id="toc-network-metrics"><span class="toc-section-number">2.2</span> Network Metrics</a>
<ul>
<li><a href="metrics.html#network-metrics-for-nodes" id="toc-network-metrics-for-nodes"><span class="toc-section-number">2.2.1</span> Network Metrics for Nodes</a></li>
<li><a href="metrics.html#network-metrics-for-edges" id="toc-network-metrics-for-edges"><span class="toc-section-number">2.2.2</span> Network Metrics for Edges</a></li>
</ul></li>
<li><a href="metrics.html#igraph-visualization" id="toc-igraph-visualization"><span class="toc-section-number">2.3</span> igraph Visualization</a></li>
</ul></li>
<li><a href="nodes.html#nodes" id="toc-nodes"><span class="toc-section-number">3</span> Visualizing Nodes</a>
<ul>
<li><a href="nodes.html#convert-coordinates-to-points" id="toc-convert-coordinates-to-points"><span class="toc-section-number">3.1</span> Convert Coordinates to Points</a></li>
<li><a href="nodes.html#visualize-nodes" id="toc-visualize-nodes"><span class="toc-section-number">3.2</span> Visualize Nodes</a></li>
<li><a href="nodes.html#visualize-nodes-by-node-color" id="toc-visualize-nodes-by-node-color"><span class="toc-section-number">3.3</span> Visualize Nodes by Node Color</a></li>
<li><a href="nodes.html#visualize-nodes-by-node-size" id="toc-visualize-nodes-by-node-size"><span class="toc-section-number">3.4</span> Visualize Nodes by Node Size</a></li>
<li><a href="nodes.html#visualize-nodes-by-size-and-color" id="toc-visualize-nodes-by-size-and-color"><span class="toc-section-number">3.5</span> Visualize Nodes by Size and Color</a></li>
</ul></li>
<li><a href="vizedges.html#vizedges" id="toc-vizedges"><span class="toc-section-number">4</span> Visualizing Edges</a>
<ul>
<li><a href="vizedges.html#convert-points-into-lines" id="toc-convert-points-into-lines"><span class="toc-section-number">4.1</span> Convert Points into Lines</a>
<ul>
<li><a href="vizedges.html#method-1-use-od2line-function-in-stplanr-package." id="toc-method-1-use-od2line-function-in-stplanr-package."><span class="toc-section-number">4.1.1</span> Method 1: Use <code>od2line</code> function in <code>stplanr</code> package.</a></li>
<li><a href="vizedges.html#method-2-group-by-lineid-and-summarize-points-into-line" id="toc-method-2-group-by-lineid-and-summarize-points-into-line"><span class="toc-section-number">4.1.2</span> Method 2: Group by lineID and Summarize Points into Line</a></li>
<li><a href="vizedges.html#method-3-join-two-point-geometry-into-one-row-and-unite-into-line" id="toc-method-3-join-two-point-geometry-into-one-row-and-unite-into-line"><span class="toc-section-number">4.1.3</span> Method 3: Join Two Point Geometry into One Row and Unite into Line</a></li>
</ul></li>
<li><a href="vizedges.html#visualizing-edges" id="toc-visualizing-edges"><span class="toc-section-number">4.2</span> Visualizing Edges</a></li>
<li><a href="vizedges.html#visualizing-edges-by-color" id="toc-visualizing-edges-by-color"><span class="toc-section-number">4.3</span> Visualizing Edges by Color</a></li>
<li><a href="vizedges.html#visualizing-edges-by-line-width" id="toc-visualizing-edges-by-line-width"><span class="toc-section-number">4.4</span> Visualizing Edges by Line Width</a></li>
<li><a href="vizedges.html#visualizing-edges-by-color-and-width" id="toc-visualizing-edges-by-color-and-width"><span class="toc-section-number">4.5</span> Visualizing Edges by Color and Width</a></li>
</ul></li>
<li><a href="advanced-aesthetics.html#advanced-aesthetics" id="toc-advanced-aesthetics"><span class="toc-section-number">5</span> Advanced Aesthetics</a>
<ul>
<li><a href="advanced-aesthetics.html#export-maps" id="toc-export-maps"><span class="toc-section-number">5.1</span> Export Maps</a></li>
<li><a href="advanced-aesthetics.html#small-multiples" id="toc-small-multiples"><span class="toc-section-number">5.2</span> Small Multiples</a></li>
<li><a href="advanced-aesthetics.html#interactive-maps" id="toc-interactive-maps"><span class="toc-section-number">5.3</span> Interactive Maps</a></li>
<li><a href="advanced-aesthetics.html#base-map" id="toc-base-map"><span class="toc-section-number">5.4</span> Base Map</a></li>
<li><a href="advanced-aesthetics.html#inset-map" id="toc-inset-map"><span class="toc-section-number">5.5</span> Inset Map</a></li>
<li><a href="advanced-aesthetics.html#edge-bundling" id="toc-edge-bundling"><span class="toc-section-number">5.6</span> Edge Bundling</a></li>
</ul></li>
<li><a href="advanced-ssn-metrics.html#advanced-ssn-metrics" id="toc-advanced-ssn-metrics"><span class="toc-section-number">6</span> Advanced SSN Metrics</a>
<ul>
<li><a href="advanced-ssn-metrics.html#ssn-hotspots-detection" id="toc-ssn-hotspots-detection"><span class="toc-section-number">6.1</span> SSN Hotspots Detection</a>
<ul>
<li><a href="advanced-ssn-metrics.html#calculate-ssn-hotspots-using-radius-or-k-nearest-neighbor-window-sizes" id="toc-calculate-ssn-hotspots-using-radius-or-k-nearest-neighbor-window-sizes"><span class="toc-section-number">6.1.1</span> Calculate SSN hotspots using radius or K-nearest neighbor window sizes</a></li>
<li><a href="advanced-ssn-metrics.html#visualize-ssn-hotspots" id="toc-visualize-ssn-hotspots"><span class="toc-section-number">6.1.2</span> Visualize SSN hotspots</a></li>
<li><a href="advanced-ssn-metrics.html#find-optimal-window-sizes-for-ssn-hotspots" id="toc-find-optimal-window-sizes-for-ssn-hotspots"><span class="toc-section-number">6.1.3</span> Find optimal window sizes for SSN hotspots</a></li>
<li><a href="advanced-ssn-metrics.html#calculate-ssn-hotspots-using-a-user-defined-walking-distance-matrix-extracted-from-osm" id="toc-calculate-ssn-hotspots-using-a-user-defined-walking-distance-matrix-extracted-from-osm"><span class="toc-section-number">6.1.4</span> Calculate SSN hotspots using a user-defined walking distance matrix extracted from OSM</a></li>
<li><a href="advanced-ssn-metrics.html#application-to-a-weighted-and-bipartite-network" id="toc-application-to-a-weighted-and-bipartite-network"><span class="toc-section-number">6.1.5</span> Application to a weighted and bipartite network</a></li>
</ul></li>
<li><a href="advanced-ssn-metrics.html#k-fullfillment" id="toc-k-fullfillment"><span class="toc-section-number">6.2</span> K-fullfillment</a>
<ul>
<li><a href="advanced-ssn-metrics.html#calculate-k-fullfillment-values" id="toc-calculate-k-fullfillment-values"><span class="toc-section-number">6.2.1</span> Calculate K-fullfillment values</a></li>
<li><a href="advanced-ssn-metrics.html#visualize-k-fullfillment" id="toc-visualize-k-fullfillment"><span class="toc-section-number">6.2.2</span> Visualize K-fullfillment</a></li>
<li><a href="advanced-ssn-metrics.html#application-to-a-bipartite-network" id="toc-application-to-a-bipartite-network"><span class="toc-section-number">6.2.3</span> Application to a bipartite network</a></li>
</ul></li>
<li><a href="advanced-ssn-metrics.html#flattening-ratio" id="toc-flattening-ratio"><span class="toc-section-number">6.3</span> Flattening Ratio</a>
<ul>
<li><a href="advanced-ssn-metrics.html#calculate-global-flattening-ratio" id="toc-calculate-global-flattening-ratio"><span class="toc-section-number">6.3.1</span> Calculate Global Flattening Ratio</a></li>
<li><a href="advanced-ssn-metrics.html#calculate-local-flattening-ratio" id="toc-calculate-local-flattening-ratio"><span class="toc-section-number">6.3.2</span> Calculate Local Flattening Ratio</a></li>
<li><a href="advanced-ssn-metrics.html#visualize-local-flattening-ratio" id="toc-visualize-local-flattening-ratio"><span class="toc-section-number">6.3.3</span> Visualize Local Flattening Ratio</a></li>
<li><a href="advanced-ssn-metrics.html#application-to-a-bipartite-network-1" id="toc-application-to-a-bipartite-network-1"><span class="toc-section-number">6.3.4</span> Application to a bipartite network</a></li>
</ul></li>
<li><a href="advanced-ssn-metrics.html#linked-activity-spaces" id="toc-linked-activity-spaces"><span class="toc-section-number">6.4</span> Linked Activity Spaces</a>
<ul>
<li><a href="advanced-ssn-metrics.html#visualize-linked-activity-spaces" id="toc-visualize-linked-activity-spaces"><span class="toc-section-number">6.4.1</span> Visualize Linked Activity Spaces</a></li>
<li><a href="advanced-ssn-metrics.html#quantify-linked-activity-spaces" id="toc-quantify-linked-activity-spaces"><span class="toc-section-number">6.4.2</span> Quantify Linked Activity Spaces</a></li>
</ul></li>
</ul></li>
<li><a href="development.html#development" id="toc-development"><span class="toc-section-number">7</span> Future Development</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Social Networks (SSN) Visualization and Metrics with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="advanced-ssn-metrics" class="section level1" number="6">
<h1><span class="header-section-number">Chapter 6</span> Advanced SSN Metrics</h1>
<p>The following subchapters will introduce advanced SSN metrics. <strong>Spatial Social Network (SSN)</strong> refers to social networks where the nodes are also geolocated. They can be collaborations between organizations, economic hiring between individuals, trades between companies, and friendships. Different from social network metrics or spatial methods, these metrics tend to focus on the interaction between the networks and geographic space. While the metrics are designed for small-scale SSNs, some can also be applied to analyze origin-destination flows, POI visits, and mobility data.</p>
<p>You can download the R codes for the following subchapters from GitHub here (go to :
*</p>
<div id="ssn-hotspots-detection" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> SSN Hotspots Detection</h2>
<p>In this chapter we show two GIS methods, <strong>EdgeScan</strong> and <strong>NDScan</strong>, for capturing areas with high and low levels of number of edges or network density respectively. Both methods are moving window processes that count the number of edges and network density, respectively, for each node in a given focal area (window area). It is important to note that while our functions report <strong>EdgeScan</strong> and <strong>NDScan</strong> values on the node level, <strong>these values represent local social connections in the moving window area centered by that node</strong>. Thus, it is possible that a node can have high <strong>EdgeScan</strong> and <strong>NDScan</strong> values, but are not connected with others locally. The contents below come from this paper published in <em>Transactions in GIS</em>: <a href="https://onlinelibrary.wiley.com/doi/10.1111/tgis.13050">Is Your Neighbor Your Friend? Scan Methods for Spatial Social Network (SSN) Hotspot Detection (Liang et al., 2023)</a>.</p>
<p>Here are some example research questions that will benefit from <strong>EdgeScan</strong> and <strong>NDScan</strong> metrics:</p>
<ul>
<li>(Mafia members SSN) Where do mafia members both cluster in geographic proximity and connect in network space?</li>
<li>(Restaurant POI visits SSN) Where do restaurants cluster and serve local clientele (i.e., heavy-weighted connections to nearby census block groups)?</li>
<li>(Food sharing SSN) Where are organizations that locate close-by but do not collaborate or share resources with each other?</li>
</ul>
<p>Our tutorial will cover the following topics:</p>
<ul>
<li>How to calculate SSN hotspots using <code>edgeScanRadius()</code>, <code>edgeScanManhattan()</code>, <code>edgeScanKNearest()</code>, <code>NDScanRadius()</code>, <code>NDScanManhattan</code>, and <code>NDScanKNearest()</code> in <code>SSNtools</code>.</li>
<li>How to visualize SSN hotspots</li>
<li>(Advanced) How to find optimal window sizes for SSN hotspots</li>
<li>(Advanced) How to calculate SSN hotspots within a walking distance radius, using <code>NDScanMatrix()</code> and <code>edgeScanMatrix()</code> in <code>SSNtools</code>, with OSM (OpenStreetMap) data as an input matrix.</li>
<li>(Advanced) Application to a weighted and bipartite network (POI visits)</li>
</ul>
<p>To begin, let us introduce the basic ideas behind the <strong>EdgeScan</strong> and <strong>NDScan</strong> methods. Both methods are based on spatial scan approaches, which summarised statistics in a moving window for a focal node. Therefore, for each node in the network, EdgeScan and NDScan calculate <strong>the number of edges</strong> and <strong>network density</strong> in the area centered by the focal node. Network density is the ratio of actual number of edges and the potential number of edges. A high network density (=1) means that nodes in the moving window have maximize all the possible combinations of connections.</p>
<p>Our EdgeScan and NDScan methods provide four different <strong>neighborhood definitions</strong>:</p>
<ul>
<li>Euclidean distance</li>
<li>Manhattan distance</li>
<li>User-defined distance (e.g., walking distance)</li>
<li>K-nearest neighbors</li>
</ul>
<p>The users can input the following <strong>window size</strong></p>
<ul>
<li>distance in the unit of coordinate systems (meter in our example)</li>
<li>a user-defined distance matrix</li>
<li>the number of nearest neighbors.</li>
</ul>
<p>The graphic below shows a schematic diagram of how the EdgeScan and NDScan value for a focal node is calculated. The window in the first circle simultaneously represents a potential window size of Euclidean distance of 400m, Manhattan distance of 500m, and 7-nearest neighbors.</p>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-71"></span>
<img src="Figs/06-metrics-hotspot-schema.png" alt="Schematic Diagram of EdgeScan and NDScan Values Calculation" width="100%" />
<p class="caption">
Figure 6.1: Schematic Diagram of EdgeScan and NDScan Values Calculation
</p>
</div>
<p>We will continue to use sample datasets <strong>NYCMafiaNodes</strong>, <strong>NYCMafiaEdges</strong>, <strong>POINodes</strong>, and <strong>POIEdges</strong> and in <code>SSNtools</code> to illustrate examples. To load the sample datasets and the functions, go to GitHub <a href="https://github.com/friendlycities-gatech/SSNtools">SSNtool</a> to download the development R package, or type the following lines in your R console. Click the GitHub page for more detailed description of all the functions available in the package and the input formats for each function.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="advanced-ssn-metrics.html#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;devtools&quot;)</span></span>
<span id="cb74-2"><a href="advanced-ssn-metrics.html#cb74-2" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;friendlycities-gatech/SSNtools&quot;</span>)</span></code></pre></div>
<p><strong>NYCMafiaNodes</strong> is a node table with label and spatial coordinates for each node (a mafia member). <strong>NYCMafiaeEdges</strong> contains pairs of node labels (corresponding to node table label), representing mafia criminal associations. This is a unweighted and undirected network. The coordinate system crs is 32118, in the unit of meters. Data in <strong>POINodes</strong> and <strong>POIEdges</strong> are processed from SafeGraph with extra filters and coding to hide sensitive information. The dataset is meant to be educational and thus can be inaccurate for real implications. The nodes in the dataset are restaurants in Atlanta (set 0) and centroids of census block group (set 1). The edges in the dataset are visits from the census block group to restaurants. The weight of the edges represent the percentage of total visits coming from a particular census block group. You can call <strong>POINodes</strong> (n=1356) and <strong>POIEdges</strong> (n=7926) to directly access the sample dataset. The coordinates system is transformed with crs=26967 (unit meter).</p>
<p>Functions in <code>SSNtools</code> run on base R syntax, though wrangling data may require additional package dependencies. Based on the definitions of EdgeScan and NDScan, <code>directed</code> argument is only implemented for ND-functions, while <code>weighted</code> argument is only implemented for the Edge-functions.</p>
<div id="calculate-ssn-hotspots-using-radius-or-k-nearest-neighbor-window-sizes" class="section level3" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Calculate SSN hotspots using radius or K-nearest neighbor window sizes</h3>
<p>To get EdgeScan and NDScan value for each node, you just need to run your node and edge tables through the following codes:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb75-1"><a href="advanced-ssn-metrics.html#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SSNtools)</span>
<span id="cb75-2"><a href="advanced-ssn-metrics.html#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="advanced-ssn-metrics.html#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(NYCMafiaNodes)</span>
<span id="cb75-4"><a href="advanced-ssn-metrics.html#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(NYCMafiaEdges)</span>
<span id="cb75-5"><a href="advanced-ssn-metrics.html#cb75-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-6"><a href="advanced-ssn-metrics.html#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ----process dataframe into a list of lists </span></span>
<span id="cb75-7"><a href="advanced-ssn-metrics.html#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb75-8"><a href="advanced-ssn-metrics.html#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     data - a R dataframe containing node label, longitude, and latitude</span></span>
<span id="cb75-9"><a href="advanced-ssn-metrics.html#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     label_name - the name of the column for node label</span></span>
<span id="cb75-10"><a href="advanced-ssn-metrics.html#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     lon_name - the name of the column for node longitude </span></span>
<span id="cb75-11"><a href="advanced-ssn-metrics.html#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     lat_name - the name of the column for node latitude</span></span>
<span id="cb75-12"><a href="advanced-ssn-metrics.html#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     bipartite_name - (optional) the name of the column that indicates the bipartite set of the nodes. The set of nodes that EdgeScan or NDScan should report on should be coded as 1 in the biparite column, and 0 otherwise.  </span></span>
<span id="cb75-13"><a href="advanced-ssn-metrics.html#cb75-13" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> <span class="fu">processNode</span>(NYCMafiaNodes, <span class="st">&#39;label&#39;</span>, <span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>)</span>
<span id="cb75-14"><a href="advanced-ssn-metrics.html#cb75-14" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb75-15"><a href="advanced-ssn-metrics.html#cb75-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     data - a R dataframe containing source node label and target node label</span></span>
<span id="cb75-16"><a href="advanced-ssn-metrics.html#cb75-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     source_name - the name of the column for source node label</span></span>
<span id="cb75-17"><a href="advanced-ssn-metrics.html#cb75-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     target_name - the name of the column for target node label</span></span>
<span id="cb75-18"><a href="advanced-ssn-metrics.html#cb75-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     weight_name - (optional) the name of the column for edge weight </span></span>
<span id="cb75-19"><a href="advanced-ssn-metrics.html#cb75-19" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> <span class="fu">processEdge</span>(NYCMafiaEdges, <span class="st">&#39;Source&#39;</span>, <span class="st">&#39;Target&#39;</span>)</span>
<span id="cb75-20"><a href="advanced-ssn-metrics.html#cb75-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-21"><a href="advanced-ssn-metrics.html#cb75-21" aria-hidden="true" tabindex="-1"></a><span class="co">#----calculate the density of edges within a radius (500 meters - Euclidean distance) of every node in a graph</span></span>
<span id="cb75-22"><a href="advanced-ssn-metrics.html#cb75-22" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb75-23"><a href="advanced-ssn-metrics.html#cb75-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     nodes - a list of named lists. Each sublist contains a node.</span></span>
<span id="cb75-24"><a href="advanced-ssn-metrics.html#cb75-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     edges - a list of list. Each sublist contains an edge.</span></span>
<span id="cb75-25"><a href="advanced-ssn-metrics.html#cb75-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     radius - radius (in the coordinate unit) of the scanning window. </span></span>
<span id="cb75-26"><a href="advanced-ssn-metrics.html#cb75-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     (optional) min - minimum number of points required to be in the search window. Default to 3.</span></span>
<span id="cb75-27"><a href="advanced-ssn-metrics.html#cb75-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     (optional) weighted - whether the result, number of edges, will be weighted (as sum of edge weights). Default to FALSE.</span></span>
<span id="cb75-28"><a href="advanced-ssn-metrics.html#cb75-28" aria-hidden="true" tabindex="-1"></a><span class="co">#     (optional) bipartite - whether the result will be calculated as a bipartite network. Default to FALSE.</span></span>
<span id="cb75-29"><a href="advanced-ssn-metrics.html#cb75-29" aria-hidden="true" tabindex="-1"></a><span class="co"># return:</span></span>
<span id="cb75-30"><a href="advanced-ssn-metrics.html#cb75-30" aria-hidden="true" tabindex="-1"></a><span class="co">#     list(heat, edgeWithin) - a list of two dataframe for node and edge table. </span></span>
<span id="cb75-31"><a href="advanced-ssn-metrics.html#cb75-31" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">edgeScanRadius</span>(nodes, edges, <span class="dv">500</span>)</span>
<span id="cb75-32"><a href="advanced-ssn-metrics.html#cb75-32" aria-hidden="true" tabindex="-1"></a>heat <span class="ot">=</span> result[[<span class="dv">1</span>]]</span>
<span id="cb75-33"><a href="advanced-ssn-metrics.html#cb75-33" aria-hidden="true" tabindex="-1"></a>edgeWithin <span class="ot">=</span> result[[<span class="dv">2</span>]]</span>
<span id="cb75-34"><a href="advanced-ssn-metrics.html#cb75-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-35"><a href="advanced-ssn-metrics.html#cb75-35" aria-hidden="true" tabindex="-1"></a><span class="co">#-----calculates network density within a radius (500 meters - Euclidean distance) of each node in a network</span></span>
<span id="cb75-36"><a href="advanced-ssn-metrics.html#cb75-36" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb75-37"><a href="advanced-ssn-metrics.html#cb75-37" aria-hidden="true" tabindex="-1"></a><span class="co">#     nodes - a list of named lists. Each sublist contains a node.</span></span>
<span id="cb75-38"><a href="advanced-ssn-metrics.html#cb75-38" aria-hidden="true" tabindex="-1"></a><span class="co">#     edges - a list of list. Each sublist contains an edge.</span></span>
<span id="cb75-39"><a href="advanced-ssn-metrics.html#cb75-39" aria-hidden="true" tabindex="-1"></a><span class="co">#     radius - radius (in the coordinate unit) of the scanning window. </span></span>
<span id="cb75-40"><a href="advanced-ssn-metrics.html#cb75-40" aria-hidden="true" tabindex="-1"></a><span class="co">#     (optional) min - minimum number of points required to be in the search window. Default to 3.</span></span>
<span id="cb75-41"><a href="advanced-ssn-metrics.html#cb75-41" aria-hidden="true" tabindex="-1"></a><span class="co">#     (optional) directed - whether the result, network density, will be calculated as a directed network. Default to FALSE.</span></span>
<span id="cb75-42"><a href="advanced-ssn-metrics.html#cb75-42" aria-hidden="true" tabindex="-1"></a><span class="co">#     (optional) bipartite - whether the results will be calculated as a bipartite network. Default to FALSE.</span></span>
<span id="cb75-43"><a href="advanced-ssn-metrics.html#cb75-43" aria-hidden="true" tabindex="-1"></a><span class="co"># return:</span></span>
<span id="cb75-44"><a href="advanced-ssn-metrics.html#cb75-44" aria-hidden="true" tabindex="-1"></a><span class="co">#     list(heat, edgeWithin) - a list of two dataframe for node and edge table. </span></span>
<span id="cb75-45"><a href="advanced-ssn-metrics.html#cb75-45" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">NDScanRadius</span>(nodes, edges, <span class="dv">500</span>)</span>
<span id="cb75-46"><a href="advanced-ssn-metrics.html#cb75-46" aria-hidden="true" tabindex="-1"></a>heat <span class="ot">=</span> result[[<span class="dv">1</span>]]</span>
<span id="cb75-47"><a href="advanced-ssn-metrics.html#cb75-47" aria-hidden="true" tabindex="-1"></a>edgeWithin <span class="ot">=</span> result[[<span class="dv">2</span>]]</span></code></pre></div>
<p><strong>Interpret Outputs</strong></p>
<p>All the SSNhotspot main functions (e.g, edgeScanRadius and NDScanRadius) will return a list of two dataframes. The first dataframe is a node table wtih two columns:</p>
<ul>
<li><code>label</code>: the node label</li>
<li><code>heat</code>: the number of edges in EdgeScan and network density in NDScan respectively.</li>
</ul>
<p>The second dataframe is an edge table that has three columns:</p>
<ul>
<li><code>Source</code>: source node label</li>
<li><code>Target</code>: target node label</li>
<li><code>WithinWindow</code>: binary value (1 or 0) indicating whether the edge is within the scanning window.</li>
</ul>
<p>Below are example outputs of the <strong>heat</strong> and <strong>edgeWithin</strong> dataframes. If the nodes (e.g., AMAROSA-ALEXANDER) do not meet the <strong>min</strong> argument requirement (in this case, min=3 and thus three nodes in the moving window), the <strong>heat</strong> value will be NA. Zero has practical meaning in the outputs: it means that there are no connections within the center node’s searching window despite having at least three nodes.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="advanced-ssn-metrics.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">#----- print example NDSCanRadius outputs at selected rows ------</span></span>
<span id="cb76-2"><a href="advanced-ssn-metrics.html#cb76-2" aria-hidden="true" tabindex="-1"></a>heat[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">93</span>,<span class="dv">102</span>), ]</span></code></pre></div>
<pre><code>##                 label heat
## 1   AMAROSA-ALEXANDER   NA
## 93        SIANO-FIORE  0.0
## 102   POLIZZANO-RALPH  0.6</code></pre>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="advanced-ssn-metrics.html#cb78-1" aria-hidden="true" tabindex="-1"></a>edgeWithin[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">254</span>,<span class="dv">259</span>), ]</span></code></pre></div>
<pre><code>##              Source            Target WithinWindow
## 1   SALERNO-ANTHONY    ALBERO-CHARLES            0
## 254     SIANO-FIORE   PAGANO-PASQUALE            0
## 259 POLIZZANO-RALPH DIPALERMO-CHARLES            1</code></pre>
<p>Here are other SSN hotspots functions using various window size definitions. The parameters are the same as <code>edgeScanRadius()</code> and <code>NDScanRadius()</code>.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="advanced-ssn-metrics.html#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co">#-----calculates network density within 10 nearest neighbors of each node in a network</span></span>
<span id="cb80-2"><a href="advanced-ssn-metrics.html#cb80-2" aria-hidden="true" tabindex="-1"></a>heat <span class="ot">=</span> <span class="fu">NDScanKNearest</span>(nodes, edges, <span class="dv">10</span>)[[<span class="dv">1</span>]]</span>
<span id="cb80-3"><a href="advanced-ssn-metrics.html#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="advanced-ssn-metrics.html#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co">#-----calculates network density within a radius (500 meters - Manhattan distance) of each node in a network</span></span>
<span id="cb80-5"><a href="advanced-ssn-metrics.html#cb80-5" aria-hidden="true" tabindex="-1"></a>heat <span class="ot">=</span> <span class="fu">NDScanManhattan</span>(nodes, edges, <span class="dv">500</span>)[[<span class="dv">1</span>]]</span>
<span id="cb80-6"><a href="advanced-ssn-metrics.html#cb80-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-7"><a href="advanced-ssn-metrics.html#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="co">#-----calculates the density of edges within 10 nearest neighbors of each node in a network</span></span>
<span id="cb80-8"><a href="advanced-ssn-metrics.html#cb80-8" aria-hidden="true" tabindex="-1"></a>heat <span class="ot">=</span> <span class="fu">edgeScanKNearest</span>(nodes, edges, <span class="dv">10</span>)[[<span class="dv">1</span>]]</span>
<span id="cb80-9"><a href="advanced-ssn-metrics.html#cb80-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-10"><a href="advanced-ssn-metrics.html#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="co">#-----calculates the density of edges within a radius (500 meters - Manhattan distance) of each node in a network</span></span>
<span id="cb80-11"><a href="advanced-ssn-metrics.html#cb80-11" aria-hidden="true" tabindex="-1"></a>heat <span class="ot">=</span> <span class="fu">edgeScanManhattan</span>(nodes, edges, <span class="dv">500</span>)[[<span class="dv">1</span>]]</span></code></pre></div>
</div>
<div id="visualize-ssn-hotspots" class="section level3" number="6.1.2">
<h3><span class="header-section-number">6.1.2</span> Visualize SSN hotspots</h3>
<p>To visualize SSN hotspots, we need to attach spatial information to nodes in the <strong>heat</strong> dataframe and visualize nodes based on the hotspot values (i.e., column heat). If the codes below are foreign to you, review <a href="https://friendlycities-gatech.github.io/SSN_tutorial/advanced-aesthetics.html">Chapter 5: Advanced Aesthetics</a> for more details.</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb81-1"><a href="advanced-ssn-metrics.html#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb81-2"><a href="advanced-ssn-metrics.html#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(basemaps)</span>
<span id="cb81-3"><a href="advanced-ssn-metrics.html#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb81-4"><a href="advanced-ssn-metrics.html#cb81-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb81-5"><a href="advanced-ssn-metrics.html#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stplanr)</span>
<span id="cb81-6"><a href="advanced-ssn-metrics.html#cb81-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SSNtools)</span>
<span id="cb81-7"><a href="advanced-ssn-metrics.html#cb81-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-8"><a href="advanced-ssn-metrics.html#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="co"># we will use NDScanRadius as an example</span></span>
<span id="cb81-9"><a href="advanced-ssn-metrics.html#cb81-9" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">NDScanRadius</span>(nodes, edges, <span class="dv">500</span>, <span class="at">min=</span><span class="dv">3</span>)</span>
<span id="cb81-10"><a href="advanced-ssn-metrics.html#cb81-10" aria-hidden="true" tabindex="-1"></a>heat <span class="ot">=</span> result[[<span class="dv">1</span>]]</span>
<span id="cb81-11"><a href="advanced-ssn-metrics.html#cb81-11" aria-hidden="true" tabindex="-1"></a>edgeWithin <span class="ot">=</span> result[[<span class="dv">2</span>]]</span>
<span id="cb81-12"><a href="advanced-ssn-metrics.html#cb81-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-13"><a href="advanced-ssn-metrics.html#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="co"># convert heat dataframe to a spatial sf object</span></span>
<span id="cb81-14"><a href="advanced-ssn-metrics.html#cb81-14" aria-hidden="true" tabindex="-1"></a>MafiaSpatial <span class="ot">=</span> heat <span class="sc">%&gt;%</span> </span>
<span id="cb81-15"><a href="advanced-ssn-metrics.html#cb81-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(NYCMafiaNodes, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;label&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>), <span class="at">crs=</span><span class="dv">32118</span>)</span>
<span id="cb81-16"><a href="advanced-ssn-metrics.html#cb81-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-17"><a href="advanced-ssn-metrics.html#cb81-17" aria-hidden="true" tabindex="-1"></a><span class="co"># convert edgeWithin dataframe to line geometry and filter those that are within the window radius.</span></span>
<span id="cb81-18"><a href="advanced-ssn-metrics.html#cb81-18" aria-hidden="true" tabindex="-1"></a>NYCMafiaEdges_shp <span class="ot">=</span> <span class="fu">od2line</span>(edgeWithin, MafiaSpatial) <span class="sc">%&gt;%</span> </span>
<span id="cb81-19"><a href="advanced-ssn-metrics.html#cb81-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(WithinWindow <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb81-20"><a href="advanced-ssn-metrics.html#cb81-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-21"><a href="advanced-ssn-metrics.html#cb81-21" aria-hidden="true" tabindex="-1"></a><span class="co"># create basemap with functions from basemaps library</span></span>
<span id="cb81-22"><a href="advanced-ssn-metrics.html#cb81-22" aria-hidden="true" tabindex="-1"></a><span class="fu">set_defaults</span>(<span class="at">map_service =</span> <span class="st">&quot;carto&quot;</span>, <span class="at">map_type =</span> <span class="st">&quot;light&quot;</span>)</span>
<span id="cb81-23"><a href="advanced-ssn-metrics.html#cb81-23" aria-hidden="true" tabindex="-1"></a>bgbox <span class="ot">=</span> <span class="fu">st_bbox</span>(MafiaSpatial) <span class="sc">%&gt;%</span> <span class="fu">st_as_sfc</span>()</span>
<span id="cb81-24"><a href="advanced-ssn-metrics.html#cb81-24" aria-hidden="true" tabindex="-1"></a>bg <span class="ot">=</span> <span class="fu">basemap_stars</span>(bgbox)</span></code></pre></div>
<pre><code>## Loading basemap &#39;light&#39; from map service &#39;carto&#39;...</code></pre>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="advanced-ssn-metrics.html#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create hotspot map with functions from tmap library</span></span>
<span id="cb83-2"><a href="advanced-ssn-metrics.html#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb83-3"><a href="advanced-ssn-metrics.html#cb83-3" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> </span>
<span id="cb83-4"><a href="advanced-ssn-metrics.html#cb83-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(bg) <span class="sc">+</span></span>
<span id="cb83-5"><a href="advanced-ssn-metrics.html#cb83-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_rgb</span>(<span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb83-6"><a href="advanced-ssn-metrics.html#cb83-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#map edges within searching window </span></span>
<span id="cb83-7"><a href="advanced-ssn-metrics.html#cb83-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(NYCMafiaEdges_shp) <span class="sc">+</span> </span>
<span id="cb83-8"><a href="advanced-ssn-metrics.html#cb83-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">col=</span><span class="st">&#39;black&#39;</span>, <span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb83-9"><a href="advanced-ssn-metrics.html#cb83-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">#map nodes with NA values </span></span>
<span id="cb83-10"><a href="advanced-ssn-metrics.html#cb83-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(MafiaSpatial <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(heat))) <span class="sc">+</span> </span>
<span id="cb83-11"><a href="advanced-ssn-metrics.html#cb83-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_symbols</span>(<span class="at">col=</span><span class="st">&#39;white&#39;</span>, <span class="at">size=</span><span class="fl">0.05</span>) <span class="sc">+</span>  </span>
<span id="cb83-12"><a href="advanced-ssn-metrics.html#cb83-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#map nodes with heat values, allowing nodes with higher heat values to be mapped on top</span></span>
<span id="cb83-13"><a href="advanced-ssn-metrics.html#cb83-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(MafiaSpatial <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>(heat) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(heat)) <span class="sc">+</span> </span>
<span id="cb83-14"><a href="advanced-ssn-metrics.html#cb83-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_symbols</span>(<span class="at">col=</span><span class="st">&#39;heat&#39;</span>, <span class="at">size=</span><span class="fl">0.1</span>, <span class="at">style=</span><span class="st">&#39;fixed&#39;</span>, <span class="at">legend.col.show =</span> <span class="cn">FALSE</span>, </span>
<span id="cb83-15"><a href="advanced-ssn-metrics.html#cb83-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">&#39;#FBD977&#39;</span>, <span class="st">&#39;#F78D3D&#39;</span>, <span class="st">&#39;#E3211B&#39;</span>, <span class="st">&#39;#800F26&#39;</span>), </span>
<span id="cb83-16"><a href="advanced-ssn-metrics.html#cb83-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.00001</span>, <span class="fl">0.10</span>, <span class="fl">0.25</span>, <span class="fl">0.667</span>)) <span class="sc">+</span></span>
<span id="cb83-17"><a href="advanced-ssn-metrics.html#cb83-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">#customize legend and layout</span></span>
<span id="cb83-18"><a href="advanced-ssn-metrics.html#cb83-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_add_legend</span>(<span class="at">type=</span><span class="st">&#39;symbol&#39;</span>, </span>
<span id="cb83-19"><a href="advanced-ssn-metrics.html#cb83-19" aria-hidden="true" tabindex="-1"></a>                <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&#39;0&#39;</span>, <span class="st">&#39;(0, 0.10]&#39;</span>, <span class="st">&#39;(0.10, 0.25]&#39;</span>, <span class="st">&#39;(0.25, 0.667]&#39;</span>, <span class="st">&#39;NA (Less than MinPts)&#39;</span>), </span>
<span id="cb83-20"><a href="advanced-ssn-metrics.html#cb83-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;#FBD977&#39;</span>, <span class="st">&#39;#F78D3D&#39;</span>, <span class="st">&#39;#E3211B&#39;</span>, <span class="st">&#39;#800F26&#39;</span>, <span class="st">&#39;white&#39;</span>), </span>
<span id="cb83-21"><a href="advanced-ssn-metrics.html#cb83-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">is.portrait =</span> T, <span class="at">title=</span><span class="fu">c</span>(<span class="st">&#39;Network Density&#39;</span>), <span class="at">size=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb83-22"><a href="advanced-ssn-metrics.html#cb83-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_add_legend</span>(<span class="at">type=</span><span class="st">&#39;line&#39;</span>, <span class="at">labels=</span><span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">&#39;Edges within window size&#39;</span>)), </span>
<span id="cb83-23"><a href="advanced-ssn-metrics.html#cb83-23" aria-hidden="true" tabindex="-1"></a>                <span class="at">col=</span><span class="st">&#39;black&#39;</span>, <span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb83-24"><a href="advanced-ssn-metrics.html#cb83-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_scale_bar</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>), <span class="at">text.size =</span> <span class="fl">0.7</span>) <span class="sc">+</span>  </span>
<span id="cb83-25"><a href="advanced-ssn-metrics.html#cb83-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.title.size =</span> <span class="fl">0.9</span>, <span class="at">legend.text.size =</span> <span class="fl">0.7</span>, <span class="at">legend.width =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb83-26"><a href="advanced-ssn-metrics.html#cb83-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">&#39;NYC 1960s Mafia SSN Hotspots&#39;</span>,</span>
<span id="cb83-27"><a href="advanced-ssn-metrics.html#cb83-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title.position =</span> <span class="fu">c</span>(<span class="st">&#39;center&#39;</span>),</span>
<span id="cb83-28"><a href="advanced-ssn-metrics.html#cb83-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title.size =</span> <span class="fl">1.5</span>)</span>
<span id="cb83-29"><a href="advanced-ssn-metrics.html#cb83-29" aria-hidden="true" tabindex="-1"></a>g</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-76-1.png" width="672" /></p>
<p>You may wonder why edges are invisible: that is because the edges within the window size (500m) are short-ranged and thus may be hidden under the nodes! The following codes add an inset map to highlight an area with dense SSN hotspots. You can either print the map in your Rstudio Plots console or directly exports it. You can adjust position of the inset map through viewport positions, width, and height.</p>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="advanced-ssn-metrics.html#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a bounding box in crs=32118 to retrieve basemap </span></span>
<span id="cb84-2"><a href="advanced-ssn-metrics.html#cb84-2" aria-hidden="true" tabindex="-1"></a>Inset <span class="ot">=</span> <span class="fu">st_bbox</span>(<span class="fu">data.frame</span>(<span class="at">lon=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">74.00434</span>, <span class="sc">-</span><span class="fl">73.98125</span>), <span class="at">lat=</span><span class="fu">c</span>(<span class="fl">40.73080</span>, <span class="fl">40.71109</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb84-3"><a href="advanced-ssn-metrics.html#cb84-3" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">&#39;lon&#39;</span>, <span class="st">&#39;lat&#39;</span>), <span class="at">crs=</span><span class="dv">4326</span>) <span class="sc">%&gt;%</span> <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="dv">32118</span>)) </span>
<span id="cb84-4"><a href="advanced-ssn-metrics.html#cb84-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-5"><a href="advanced-ssn-metrics.html#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="co"># create a basemap for the inset map</span></span>
<span id="cb84-6"><a href="advanced-ssn-metrics.html#cb84-6" aria-hidden="true" tabindex="-1"></a>Inset_bg <span class="ot">=</span> <span class="fu">basemap_stars</span>(Inset)</span>
<span id="cb84-7"><a href="advanced-ssn-metrics.html#cb84-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-8"><a href="advanced-ssn-metrics.html#cb84-8" aria-hidden="true" tabindex="-1"></a><span class="co"># create the inset map</span></span>
<span id="cb84-9"><a href="advanced-ssn-metrics.html#cb84-9" aria-hidden="true" tabindex="-1"></a>InsetMap <span class="ot">=</span> <span class="fu">tm_shape</span>(Inset_bg) <span class="sc">+</span> </span>
<span id="cb84-10"><a href="advanced-ssn-metrics.html#cb84-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_rgb</span>() <span class="sc">+</span> </span>
<span id="cb84-11"><a href="advanced-ssn-metrics.html#cb84-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_shape</span>(NYCMafiaEdges_shp ) <span class="sc">+</span> </span>
<span id="cb84-12"><a href="advanced-ssn-metrics.html#cb84-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_lines</span>(<span class="at">col=</span><span class="st">&#39;black&#39;</span>, <span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb84-13"><a href="advanced-ssn-metrics.html#cb84-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_shape</span>(MafiaSpatial <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="fu">is.na</span>(heat))) <span class="sc">+</span> </span>
<span id="cb84-14"><a href="advanced-ssn-metrics.html#cb84-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_symbols</span>(<span class="at">col=</span><span class="st">&#39;white&#39;</span>, <span class="at">size=</span><span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb84-15"><a href="advanced-ssn-metrics.html#cb84-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_shape</span>(MafiaSpatial <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>(heat) <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(heat)) <span class="sc">+</span> </span>
<span id="cb84-16"><a href="advanced-ssn-metrics.html#cb84-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_symbols</span>(<span class="at">col=</span><span class="st">&#39;heat&#39;</span>, <span class="at">size=</span><span class="fl">0.2</span>, <span class="at">style=</span><span class="st">&#39;fixed&#39;</span>, </span>
<span id="cb84-17"><a href="advanced-ssn-metrics.html#cb84-17" aria-hidden="true" tabindex="-1"></a>               <span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.00001</span>, <span class="fl">0.10</span>, <span class="fl">0.25</span>, <span class="fl">0.667</span>), <span class="at">legend.col.show =</span> <span class="cn">FALSE</span>, </span>
<span id="cb84-18"><a href="advanced-ssn-metrics.html#cb84-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">&#39;#FBD977&#39;</span>, <span class="st">&#39;#F78D3D&#39;</span>, <span class="st">&#39;#E3211B&#39;</span>, <span class="st">&#39;#800F26&#39;</span>)) <span class="sc">+</span> </span>
<span id="cb84-19"><a href="advanced-ssn-metrics.html#cb84-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tm_layout</span>(<span class="at">frame=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>), <span class="at">frame.lwd =</span> <span class="dv">2</span>, <span class="at">main.title =</span> <span class="fu">c</span>(<span class="st">&#39;Little Italy&#39;</span>), </span>
<span id="cb84-20"><a href="advanced-ssn-metrics.html#cb84-20" aria-hidden="true" tabindex="-1"></a>              <span class="at">main.title.position =</span> <span class="fu">c</span>(<span class="st">&#39;center&#39;</span>),</span>
<span id="cb84-21"><a href="advanced-ssn-metrics.html#cb84-21" aria-hidden="true" tabindex="-1"></a>              <span class="at">main.title.size =</span> <span class="fl">0.8</span>, <span class="at">fontface =</span> <span class="dv">2</span>)</span>
<span id="cb84-22"><a href="advanced-ssn-metrics.html#cb84-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-23"><a href="advanced-ssn-metrics.html#cb84-23" aria-hidden="true" tabindex="-1"></a><span class="co"># create the bounding box map</span></span>
<span id="cb84-24"><a href="advanced-ssn-metrics.html#cb84-24" aria-hidden="true" tabindex="-1"></a>box <span class="ot">=</span> <span class="fu">tm_shape</span>(<span class="fu">st_bbox</span>(Inset) <span class="sc">%&gt;%</span> <span class="fu">st_as_sfc</span>()) <span class="sc">+</span> <span class="fu">tm_polygons</span>(<span class="at">alpha=</span><span class="dv">0</span>, <span class="at">border.col=</span><span class="st">&#39;black&#39;</span>, <span class="at">lwd=</span><span class="dv">1</span>)</span>
<span id="cb84-25"><a href="advanced-ssn-metrics.html#cb84-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-26"><a href="advanced-ssn-metrics.html#cb84-26" aria-hidden="true" tabindex="-1"></a><span class="co"># create aspect ratio to preserve the height and width ratio in the inset map</span></span>
<span id="cb84-27"><a href="advanced-ssn-metrics.html#cb84-27" aria-hidden="true" tabindex="-1"></a>aspect_ratio <span class="ot">=</span> <span class="fu">unname</span>((Inset<span class="sc">$</span>ymax <span class="sc">-</span> Inset<span class="sc">$</span>ymin)<span class="sc">/</span>(Inset<span class="sc">$</span>xmax <span class="sc">-</span> Inset<span class="sc">$</span>xmin))</span>
<span id="cb84-28"><a href="advanced-ssn-metrics.html#cb84-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-29"><a href="advanced-ssn-metrics.html#cb84-29" aria-hidden="true" tabindex="-1"></a><span class="co"># --- uncomment below export the background map g with the inset map ----</span></span>
<span id="cb84-30"><a href="advanced-ssn-metrics.html#cb84-30" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grid)</span>
<span id="cb84-31"><a href="advanced-ssn-metrics.html#cb84-31" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_save</span>(g <span class="sc">+</span> box, <span class="at">insets_tm=</span>InsetMap,</span>
<span id="cb84-32"><a href="advanced-ssn-metrics.html#cb84-32" aria-hidden="true" tabindex="-1"></a>          <span class="at">insets_vp =</span> <span class="fu">viewport</span>(<span class="fl">0.21</span>, <span class="fl">0.54</span>, <span class="at">width =</span> <span class="fl">0.3</span>, <span class="at">height =</span> aspect_ratio<span class="sc">*</span><span class="fl">0.5</span>),</span>
<span id="cb84-33"><a href="advanced-ssn-metrics.html#cb84-33" aria-hidden="true" tabindex="-1"></a>          <span class="at">filename=</span><span class="st">&#39;PATH&#39;</span>, <span class="at">dpi=</span><span class="dv">600</span>)</span>
<span id="cb84-34"><a href="advanced-ssn-metrics.html#cb84-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-35"><a href="advanced-ssn-metrics.html#cb84-35" aria-hidden="true" tabindex="-1"></a><span class="co"># --- uncomment below to print maps in R Studio Plots window ---- </span></span>
<span id="cb84-36"><a href="advanced-ssn-metrics.html#cb84-36" aria-hidden="true" tabindex="-1"></a><span class="co"># library(grid)</span></span>
<span id="cb84-37"><a href="advanced-ssn-metrics.html#cb84-37" aria-hidden="true" tabindex="-1"></a><span class="co"># g + box</span></span>
<span id="cb84-38"><a href="advanced-ssn-metrics.html#cb84-38" aria-hidden="true" tabindex="-1"></a><span class="co"># print(InsetMap, vp=viewport(0.21, 0.54, width = 0.2, height = aspect_ratio*0.5))</span></span></code></pre></div>
<p><img src="Figs/06-metrics-hotspot-inset.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
<div id="find-optimal-window-sizes-for-ssn-hotspots" class="section level3" number="6.1.3">
<h3><span class="header-section-number">6.1.3</span> Find optimal window sizes for SSN hotspots</h3>
<p>SSN hotspots are sensitive to <strong>neighborhood definition</strong> and <strong>window sizes</strong>. Neighborhood definition should match theoretical questions, such as: Is distance between nodes meaningful; is travel time a factor in the study; or do events form natural clusters of varying radii? As such, there may not be an optimal window size, but visualizing outputs can help with decisions.</p>
<p>Here, we shows how to create a graphic reporting the sensitivity of NDScan results (y values) by window sizes (x values) at the DBSCAN (Density-based Spatial Clustering of Applications with Noise) cluster level. We are interested to see how the <strong>average values of EdgeScan and NDScan</strong> vary for each SSN hotspots cluster, wherein consistent y values across the x axis would signal a robust method that is not sensitive to change in window size. Conceptually, the codes below are doing the following:</p>
<ul>
<li>create an empty dataframe with three columns <code>cluster</code>, <code>Average Network Density</code>, and <code>Window Size</code>.</li>
<li>loop through the window sizes and at each window size, do the following operation:
<ul>
<li>attach spatial information to the <code>NDScanRadius()</code> output</li>
<li>assign the DBSCAN cluster ID back to each node</li>
<li>calculate the average network density by DBSCAN cluster ID</li>
</ul></li>
<li>visualize average NDScan values (i.e., average network density) for each DBSCAN cluster at each window size through a raincloud plot</li>
</ul>
<div class="sourceCode" id="cb85"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb85-1"><a href="advanced-ssn-metrics.html#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SSNtools)</span>
<span id="cb85-2"><a href="advanced-ssn-metrics.html#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb85-3"><a href="advanced-ssn-metrics.html#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdist)</span>
<span id="cb85-4"><a href="advanced-ssn-metrics.html#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fpc)</span>
<span id="cb85-5"><a href="advanced-ssn-metrics.html#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-6"><a href="advanced-ssn-metrics.html#cb85-6" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> <span class="fu">processNode</span>(NYCMafiaNodes, <span class="st">&#39;label&#39;</span>, <span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>)</span>
<span id="cb85-7"><a href="advanced-ssn-metrics.html#cb85-7" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> <span class="fu">processEdge</span>(NYCMafiaEdges, <span class="st">&#39;Source&#39;</span>, <span class="st">&#39;Target&#39;</span>)</span>
<span id="cb85-8"><a href="advanced-ssn-metrics.html#cb85-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-9"><a href="advanced-ssn-metrics.html#cb85-9" aria-hidden="true" tabindex="-1"></a><span class="co"># create an empty dataframe to store values in the loop</span></span>
<span id="cb85-10"><a href="advanced-ssn-metrics.html#cb85-10" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">nrow =</span> <span class="dv">0</span>))</span>
<span id="cb85-11"><a href="advanced-ssn-metrics.html#cb85-11" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(df) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;cluster&#39;</span>, <span class="st">&#39;Average Network Density&#39;</span>, <span class="st">&#39;Window Size&#39;</span>)</span>
<span id="cb85-12"><a href="advanced-ssn-metrics.html#cb85-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-13"><a href="advanced-ssn-metrics.html#cb85-13" aria-hidden="true" tabindex="-1"></a><span class="co"># loop through each window size (meter)</span></span>
<span id="cb85-14"><a href="advanced-ssn-metrics.html#cb85-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq</span>(<span class="dv">100</span>, <span class="dv">2000</span>, <span class="dv">100</span>)) { </span>
<span id="cb85-15"><a href="advanced-ssn-metrics.html#cb85-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># calculate the heat values </span></span>
<span id="cb85-16"><a href="advanced-ssn-metrics.html#cb85-16" aria-hidden="true" tabindex="-1"></a>  heat <span class="ot">=</span> <span class="fu">NDScanRadius</span>(nodes, edges, i, <span class="at">min=</span><span class="dv">3</span>)[[<span class="dv">1</span>]]</span>
<span id="cb85-17"><a href="advanced-ssn-metrics.html#cb85-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># attach spatial information to nodes whose heat is not NA</span></span>
<span id="cb85-18"><a href="advanced-ssn-metrics.html#cb85-18" aria-hidden="true" tabindex="-1"></a>  MafiaSpatial <span class="ot">=</span> heat <span class="sc">%&gt;%</span> <span class="fu">drop_na</span>(heat) <span class="sc">%&gt;%</span> </span>
<span id="cb85-19"><a href="advanced-ssn-metrics.html#cb85-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(NYCMafiaNodes, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;label&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>)</span>
<span id="cb85-20"><a href="advanced-ssn-metrics.html#cb85-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># assign the DBSCAN cluster ID back to each node; </span></span>
<span id="cb85-21"><a href="advanced-ssn-metrics.html#cb85-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># DBSCAN eps argument takes in the same reachability distance value (window size) and reachability minimum no. of points as the NDScanRadius()</span></span>
<span id="cb85-22"><a href="advanced-ssn-metrics.html#cb85-22" aria-hidden="true" tabindex="-1"></a>  MafiaSpatial<span class="sc">$</span>cluster <span class="ot">=</span> fpc<span class="sc">::</span><span class="fu">dbscan</span>(MafiaSpatial <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(LonX, LatY)), <span class="at">eps =</span> i, <span class="at">MinPts =</span> <span class="dv">3</span>)<span class="sc">$</span>cluster</span>
<span id="cb85-23"><a href="advanced-ssn-metrics.html#cb85-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter noise (fpc::dbscan classified noise into cluster 0) and calculate the average network density by DBSCAN cluster </span></span>
<span id="cb85-24"><a href="advanced-ssn-metrics.html#cb85-24" aria-hidden="true" tabindex="-1"></a>  MafiaSpatial <span class="ot">=</span> MafiaSpatial <span class="sc">%&gt;%</span> <span class="fu">filter</span>(cluster <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(cluster) <span class="sc">%&gt;%</span> </span>
<span id="cb85-25"><a href="advanced-ssn-metrics.html#cb85-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="st">`</span><span class="at">Average Network Density</span><span class="st">`</span><span class="ot">=</span><span class="fu">mean</span>(heat)) <span class="sc">%&gt;%</span></span>
<span id="cb85-26"><a href="advanced-ssn-metrics.html#cb85-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="st">`</span><span class="at">Window Size</span><span class="st">`</span> <span class="ot">=</span> i)</span>
<span id="cb85-27"><a href="advanced-ssn-metrics.html#cb85-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># merge output from one window size into the final dataframe </span></span>
<span id="cb85-28"><a href="advanced-ssn-metrics.html#cb85-28" aria-hidden="true" tabindex="-1"></a>  df <span class="ot">=</span> <span class="fu">rbind</span>(df, MafiaSpatial)</span>
<span id="cb85-29"><a href="advanced-ssn-metrics.html#cb85-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-30"><a href="advanced-ssn-metrics.html#cb85-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-31"><a href="advanced-ssn-metrics.html#cb85-31" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize through a raincloud plot </span></span>
<span id="cb85-32"><a href="advanced-ssn-metrics.html#cb85-32" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> <span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x=</span><span class="st">`</span><span class="at">Window Size</span><span class="st">`</span>, <span class="at">y=</span><span class="st">`</span><span class="at">Average Network Density</span><span class="st">`</span>, <span class="at">group=</span><span class="st">`</span><span class="at">Window Size</span><span class="st">`</span>)) <span class="sc">+</span> </span>
<span id="cb85-33"><a href="advanced-ssn-metrics.html#cb85-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">colour =</span> <span class="st">&quot;lightgrey&quot;</span>, <span class="at">outlier.color =</span> <span class="cn">NA</span>, <span class="at">width=</span><span class="fl">0.2</span>) <span class="sc">+</span> </span>
<span id="cb85-34"><a href="advanced-ssn-metrics.html#cb85-34" aria-hidden="true" tabindex="-1"></a>  ggdist<span class="sc">::</span><span class="fu">stat_dots</span>(<span class="at">side=</span><span class="st">&#39;left&#39;</span>, <span class="at">justification=</span><span class="fl">1.1</span>, <span class="at">binwidth=</span><span class="fl">0.01</span>, <span class="at">alpha=</span><span class="fl">0.5</span>, </span>
<span id="cb85-35"><a href="advanced-ssn-metrics.html#cb85-35" aria-hidden="true" tabindex="-1"></a>                    <span class="at">col=</span><span class="st">&#39;black&#39;</span>, <span class="at">dotsize=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb85-36"><a href="advanced-ssn-metrics.html#cb85-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">&#39;Avg. Network Density per DBSCAN Cluster&#39;</span>) <span class="sc">+</span> </span>
<span id="cb85-37"><a href="advanced-ssn-metrics.html#cb85-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">&#39;Window Size (Euclidean Distance Meter)&#39;</span>) <span class="sc">+</span> </span>
<span id="cb85-38"><a href="advanced-ssn-metrics.html#cb85-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(<span class="st">&#39;New York Optimal Window Size for NDScan&#39;</span>)) <span class="sc">+</span> </span>
<span id="cb85-39"><a href="advanced-ssn-metrics.html#cb85-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_classic</span>() <span class="sc">+</span> </span>
<span id="cb85-40"><a href="advanced-ssn-metrics.html#cb85-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size=</span><span class="dv">20</span>),</span>
<span id="cb85-41"><a href="advanced-ssn-metrics.html#cb85-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size=</span><span class="dv">15</span>))</span>
<span id="cb85-42"><a href="advanced-ssn-metrics.html#cb85-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-43"><a href="advanced-ssn-metrics.html#cb85-43" aria-hidden="true" tabindex="-1"></a><span class="co"># manually added reference lines on g</span></span></code></pre></div>
<p><img src="Figs/06-metrics-optimal-window.png" width="100%" /></p>
<p><strong>Interpret Outputs</strong></p>
<p>The graphic above highlights three interesting distance ranges for optimal window sizes. At a window size of 100-200 m, there is a fully connected cluster of Mafia members (labeled with arrow c). From 400-2000 m, a cluster is consistent with the network density of 0.67 despite the increasing window size, suggesting that the cluster is either spatially isolated from other Mafia members or any additional Mafia member within the increased scanning window is fully connected to existing cluster members (labeled with arrow d). From 500m-1.3 km, there are four to five medium-high density clusters that are stable across window sizes (labeled with arrow e). Therefore, these ranges may be optimal to reveal interesting or robust outcomes.</p>
</div>
<div id="calculate-ssn-hotspots-using-a-user-defined-walking-distance-matrix-extracted-from-osm" class="section level3" number="6.1.4">
<h3><span class="header-section-number">6.1.4</span> Calculate SSN hotspots using a user-defined walking distance matrix extracted from OSM</h3>
<p>Euclidean and Manhattan are theoretical distances between two nodes, but in reality, travel distance (e.g., walking distance) can be mediated by geographic features. <strong>edgeScanMatrix</strong> and <strong>NDScanMatrix</strong> function take in:</p>
<ul>
<li><code>nodes</code>, a list of named lists. Each sublist contains a node.</li>
<li><code>edges</code>, a list of list. Each sublist contains an edge.</li>
<li><code>matrix</code>, a full distance matrix (i.e., the column and row includes all nodes)
** with column and row names
** with symmetrical cell values being travel distance between OD
** with the diagonal pairs (self pairs) coded with NA. When calculating the number of nodes within the window size (e.g., the first row for A1), cells with NA are automatically excluded. 0 represents zero distance.</li>
<li>(optional) <code>min</code>, minimum number of points required to be in the search window. Default to 3.</li>
<li>(optional) <code>bipartite</code>, TRUE or FALSE. If TRUE, bipartite column name should be identified in the <code>processNode()</code>.</li>
<li>(optional) <code>weighted</code>, TRUE or FALSE. If TRUE, weight column name should be identified in the <code>processEdge()</code>.</li>
</ul>
<p>Below is an example of a full distance matrix with nodes A1, A2, A3:</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb86-1"><a href="advanced-ssn-metrics.html#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">#    A1 A2 A3</span></span>
<span id="cb86-2"><a href="advanced-ssn-metrics.html#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="co"># A1 NA 0  1</span></span>
<span id="cb86-3"><a href="advanced-ssn-metrics.html#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="co"># A2 0  NA 2</span></span>
<span id="cb86-4"><a href="advanced-ssn-metrics.html#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co"># A3 1  2  NA</span></span></code></pre></div>
<p>This input format is also required for bipartite networks, even for nodes within the same set. For example, in a bipartite network, if you have 4 nodes and they are A1, A2, B1, B2, then your distance matrix should be 4 by 4 and self-pairs are coded as NA (see below). It is important to note that even though B1B2 (or B2B1) has no connections, they should still have a distance value (=3) in the distance matrix. This is because number of edges and network density needs to know all the nodes within the distance threshold.</p>
<div class="sourceCode" id="cb87"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb87-1"><a href="advanced-ssn-metrics.html#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">#     A1  A2  B1  B2</span></span>
<span id="cb87-2"><a href="advanced-ssn-metrics.html#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="co"># A1  NA  0   1   2  </span></span>
<span id="cb87-3"><a href="advanced-ssn-metrics.html#cb87-3" aria-hidden="true" tabindex="-1"></a><span class="co"># A2  0   NA  1   2</span></span>
<span id="cb87-4"><a href="advanced-ssn-metrics.html#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co"># B1  1   1   NA  3</span></span>
<span id="cb87-5"><a href="advanced-ssn-metrics.html#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="co"># B2  2   2   3   NA </span></span></code></pre></div>
<p>To pull actual travel distance between OD pairs, we recommend using <code>osrm</code> package in R. <a href="https://github.com/riatelab/osrm">ORSM</a> is a routing service based on OpenStreetMap data, which allows travel distance calculated in walking, biking, or driving modes. We are most interested in its ability to calculate many-to-many routing distance quickly through <code>osrmTable()</code> function. Please read the <code>osrm</code> <a href="https://github.com/riatelab/osrm">documentation</a> carefully if you are applying it to a large amount of data, as it discourages heavy usage.</p>
<p>Let’s say our goal is to get <strong>EdgeScan</strong> or <strong>NDScan</strong> values for <strong>NYCMafiaNodes</strong> and <strong>NYCMafiaEdges</strong> within a 1 mile walking distance (~1600m), using a <code>osrm</code> generated walking distance matrix. Here are the steps:</p>
<ul>
<li>create a dataframe that contains all non-repetitive combinations of nodes (nrow = 44253). Our functions require this information to decide the number of nodes within the window size threshold (and calculate network density), even if the nodes are not connected.<br />
</li>
<li>(optional) filter the dataframe to OD pairs within 2000 meters Euclidean distance to reduce workload for routing calculation.</li>
<li>create a origin and destination table where each row is a node with coordinates.</li>
<li>use <code>osrmTable</code> to calculate many-to-many routing distance for a subset of data (so that it does not overtax the <code>osrm</code> server, such as 99 rows). Iterate this process until all data are calculated.</li>
<li>transform the OD dataframe to the input matrix format for <strong>edgeScanMatrix</strong> and <strong>NDScanMatrix</strong> functions.</li>
</ul>
<p>Step 1-3 are coded as the following:</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb88-1"><a href="advanced-ssn-metrics.html#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb88-2"><a href="advanced-ssn-metrics.html#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co"># create a dataframe that contains all non-repetitive combinations of nodes</span></span>
<span id="cb88-3"><a href="advanced-ssn-metrics.html#cb88-3" aria-hidden="true" tabindex="-1"></a>allEdgesTable <span class="ot">=</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(<span class="fu">combn</span>(NYCMafiaNodes<span class="sc">$</span>label, <span class="dv">2</span>))) </span>
<span id="cb88-4"><a href="advanced-ssn-metrics.html#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(allEdgesTable) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&#39;Source&#39;</span>, <span class="st">&#39;Target&#39;</span>)</span>
<span id="cb88-5"><a href="advanced-ssn-metrics.html#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="advanced-ssn-metrics.html#cb88-6" aria-hidden="true" tabindex="-1"></a>edgeDistance <span class="ot">=</span> allEdgesTable <span class="sc">%&gt;%</span> </span>
<span id="cb88-7"><a href="advanced-ssn-metrics.html#cb88-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">#attach coordinates to allEdgesTable</span></span>
<span id="cb88-8"><a href="advanced-ssn-metrics.html#cb88-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(NYCMafiaNodes, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;Source&#39;</span> <span class="ot">=</span> <span class="st">&#39;label&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb88-9"><a href="advanced-ssn-metrics.html#cb88-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(NYCMafiaNodes, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;Target&#39;</span> <span class="ot">=</span> <span class="st">&#39;label&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb88-10"><a href="advanced-ssn-metrics.html#cb88-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#calculate Euclidean distance (again, the unit is meter)</span></span>
<span id="cb88-11"><a href="advanced-ssn-metrics.html#cb88-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">dist =</span> <span class="fu">sqrt</span>((LonX.x <span class="sc">-</span> LonX.y) <span class="sc">**</span> <span class="dv">2</span> <span class="sc">-</span> (LatY.x <span class="sc">-</span> LatY.y)<span class="sc">**</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb88-12"><a href="advanced-ssn-metrics.html#cb88-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(dist <span class="sc">&lt;=</span> <span class="dv">2000</span>) </span>
<span id="cb88-13"><a href="advanced-ssn-metrics.html#cb88-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-14"><a href="advanced-ssn-metrics.html#cb88-14" aria-hidden="true" tabindex="-1"></a><span class="co"># print example outputs </span></span>
<span id="cb88-15"><a href="advanced-ssn-metrics.html#cb88-15" aria-hidden="true" tabindex="-1"></a>edgeDistance[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>), ]</span></code></pre></div>
<pre><code>##              Source             Target   LonX.x   LatY.x   LonX.y   LatY.y
## 1 AMAROSA-ALEXANDER      BIONDO-JOSEPH 302206.2 57958.61 309374.0 64916.18
## 2 AMAROSA-ALEXANDER MANNARINO-GIACINTO 302206.2 57958.61 303457.1 58580.96
## 3 AMAROSA-ALEXANDER   CARRUBBA-CORRADO 302206.2 57958.61 300557.9 56947.99
##       dist
## 1 1723.116
## 2 1085.023
## 3 1302.158</code></pre>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb90-1"><a href="advanced-ssn-metrics.html#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create origin and destination table</span></span>
<span id="cb90-2"><a href="advanced-ssn-metrics.html#cb90-2" aria-hidden="true" tabindex="-1"></a>origin <span class="ot">=</span> edgeDistance <span class="sc">%&gt;%</span> </span>
<span id="cb90-3"><a href="advanced-ssn-metrics.html#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(Source, LonX.x, LatY.x)) <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">&#39;LonX.x&#39;</span>, <span class="st">&#39;LatY.x&#39;</span>), <span class="at">crs=</span><span class="dv">32118</span>) <span class="sc">%&gt;%</span></span>
<span id="cb90-4"><a href="advanced-ssn-metrics.html#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#osrmTable() assumes inputs are in crs=4326</span></span>
<span id="cb90-5"><a href="advanced-ssn-metrics.html#cb90-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="dv">4326</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb90-6"><a href="advanced-ssn-metrics.html#cb90-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">LonX =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>],</span>
<span id="cb90-7"><a href="advanced-ssn-metrics.html#cb90-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">LatY =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb90-8"><a href="advanced-ssn-metrics.html#cb90-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb90-9"><a href="advanced-ssn-metrics.html#cb90-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-10"><a href="advanced-ssn-metrics.html#cb90-10" aria-hidden="true" tabindex="-1"></a>des <span class="ot">=</span> edgeDistance <span class="sc">%&gt;%</span> </span>
<span id="cb90-11"><a href="advanced-ssn-metrics.html#cb90-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(Target, LonX.y, LatY.y)) <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">&#39;LonX.y&#39;</span>, <span class="st">&#39;LatY.y&#39;</span>), <span class="at">crs=</span><span class="dv">32118</span>) <span class="sc">%&gt;%</span></span>
<span id="cb90-12"><a href="advanced-ssn-metrics.html#cb90-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#osrmTable() assumes inputs are in crs=4326</span></span>
<span id="cb90-13"><a href="advanced-ssn-metrics.html#cb90-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="dv">4326</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb90-14"><a href="advanced-ssn-metrics.html#cb90-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">LonX =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>],</span>
<span id="cb90-15"><a href="advanced-ssn-metrics.html#cb90-15" aria-hidden="true" tabindex="-1"></a>         <span class="at">LatY =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb90-16"><a href="advanced-ssn-metrics.html#cb90-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb90-17"><a href="advanced-ssn-metrics.html#cb90-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-18"><a href="advanced-ssn-metrics.html#cb90-18" aria-hidden="true" tabindex="-1"></a><span class="co"># print example outputs </span></span>
<span id="cb90-19"><a href="advanced-ssn-metrics.html#cb90-19" aria-hidden="true" tabindex="-1"></a>origin[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>), ]</span></code></pre></div>
<pre><code>##              Source     LonX    LatY
## 1 AMAROSA-ALEXANDER -73.9739 40.6886
## 2 AMAROSA-ALEXANDER -73.9739 40.6886
## 3 AMAROSA-ALEXANDER -73.9739 40.6886</code></pre>
<p>For step 4, to avoid overtaxing the <code>osrm</code> backend, the following codes only show how to extract walking distance for the <strong>first 10 rows of data</strong> in <code>origin</code> and <code>des</code> dataframe. Note that <code>osrmTable()</code> assumes coordinate system crs to be 4326 and return distance in the unit of meters.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="advanced-ssn-metrics.html#cb92-1" aria-hidden="true" tabindex="-1"></a>origin_sub <span class="ot">=</span> origin[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>),]</span>
<span id="cb92-2"><a href="advanced-ssn-metrics.html#cb92-2" aria-hidden="true" tabindex="-1"></a>des_sub <span class="ot">=</span> des[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>),]</span>
<span id="cb92-3"><a href="advanced-ssn-metrics.html#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="advanced-ssn-metrics.html#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(osrm)</span>
<span id="cb92-5"><a href="advanced-ssn-metrics.html#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="co"># distances contains a list of outputs. </span></span>
<span id="cb92-6"><a href="advanced-ssn-metrics.html#cb92-6" aria-hidden="true" tabindex="-1"></a>distances <span class="ot">&lt;-</span> <span class="fu">osrmTable</span>(</span>
<span id="cb92-7"><a href="advanced-ssn-metrics.html#cb92-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">src =</span> origin_sub[<span class="fu">c</span>(<span class="st">&quot;LonX&quot;</span>, <span class="st">&quot;LatY&quot;</span>)],</span>
<span id="cb92-8"><a href="advanced-ssn-metrics.html#cb92-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">dst =</span> des_sub[<span class="fu">c</span>(<span class="st">&quot;LonX&quot;</span>, <span class="st">&quot;LatY&quot;</span>)],</span>
<span id="cb92-9"><a href="advanced-ssn-metrics.html#cb92-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">osrm.profile =</span> <span class="st">&quot;foot&quot;</span>,</span>
<span id="cb92-10"><a href="advanced-ssn-metrics.html#cb92-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">measure =</span> <span class="fu">c</span>(<span class="st">&quot;distance&quot;</span>)</span>
<span id="cb92-11"><a href="advanced-ssn-metrics.html#cb92-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb92-12"><a href="advanced-ssn-metrics.html#cb92-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-13"><a href="advanced-ssn-metrics.html#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="co"># distances$distances returns a full distance matrix between all nodes in origin_sub and des_sub. We are only interested in the pairwise result and thus only take the diagonal values. Distance values are meters. </span></span>
<span id="cb92-14"><a href="advanced-ssn-metrics.html#cb92-14" aria-hidden="true" tabindex="-1"></a>Distance_m <span class="ot">=</span> <span class="fu">diag</span>(distances<span class="sc">$</span>distances)</span>
<span id="cb92-15"><a href="advanced-ssn-metrics.html#cb92-15" aria-hidden="true" tabindex="-1"></a>Distance_m</span></code></pre></div>
<pre><code>##     1     2     3     4     5     6     7     8     9    10 
## 11868  1815  2521  1220  5584  8237   941  1027  1027  4131</code></pre>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb94-1"><a href="advanced-ssn-metrics.html#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># if you are running the sample codes above in loop, force the system to sleep 1s before running the next loop </span></span>
<span id="cb94-2"><a href="advanced-ssn-metrics.html#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Sys.sleep(1)</span></span></code></pre></div>
<p>For step 5, we assume readers have acquired walking distance values for all rows of data. Here we filled the <code>Distance_m</code> vector with random values to demonstrate the codes.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb95-1"><a href="advanced-ssn-metrics.html#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fill Distance_m with random values </span></span>
<span id="cb95-2"><a href="advanced-ssn-metrics.html#cb95-2" aria-hidden="true" tabindex="-1"></a>Distance_m <span class="ot">=</span> <span class="fu">sample.int</span>(<span class="dv">2000</span>, <span class="fu">nrow</span>(origin), <span class="at">replace=</span><span class="cn">TRUE</span>)</span>
<span id="cb95-3"><a href="advanced-ssn-metrics.html#cb95-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-4"><a href="advanced-ssn-metrics.html#cb95-4" aria-hidden="true" tabindex="-1"></a>dist <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">Source =</span> origin<span class="sc">$</span>Source, <span class="at">Target =</span> des<span class="sc">$</span>Target, <span class="at">Distance_m =</span> Distance_m)</span>
<span id="cb95-5"><a href="advanced-ssn-metrics.html#cb95-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-6"><a href="advanced-ssn-metrics.html#cb95-6" aria-hidden="true" tabindex="-1"></a><span class="co"># create an edge table with walking distance </span></span>
<span id="cb95-7"><a href="advanced-ssn-metrics.html#cb95-7" aria-hidden="true" tabindex="-1"></a>edgeDistance <span class="ot">=</span> edgeDistance <span class="sc">%&gt;%</span> </span>
<span id="cb95-8"><a href="advanced-ssn-metrics.html#cb95-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dist, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;Source&#39;</span>, <span class="st">&#39;Target&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb95-9"><a href="advanced-ssn-metrics.html#cb95-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(Source, Target, Distance_m)) <span class="sc">%&gt;%</span></span>
<span id="cb95-10"><a href="advanced-ssn-metrics.html#cb95-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Distance_m =</span> <span class="fu">ifelse</span>(Distance_m <span class="sc">==</span> <span class="dv">0</span>, <span class="fl">0.001</span>, Distance_m))</span>
<span id="cb95-11"><a href="advanced-ssn-metrics.html#cb95-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-12"><a href="advanced-ssn-metrics.html#cb95-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(igraph)</span>
<span id="cb95-13"><a href="advanced-ssn-metrics.html#cb95-13" aria-hidden="true" tabindex="-1"></a><span class="co"># create input full matrix from the edge table. </span></span>
<span id="cb95-14"><a href="advanced-ssn-metrics.html#cb95-14" aria-hidden="true" tabindex="-1"></a><span class="co"># as_adjacency_matrix() fills empty sell with zeros.</span></span>
<span id="cb95-15"><a href="advanced-ssn-metrics.html#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="co"># zero has practical meaning in our example. </span></span>
<span id="cb95-16"><a href="advanced-ssn-metrics.html#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Thus we convert 0 to NA </span></span>
<span id="cb95-17"><a href="advanced-ssn-metrics.html#cb95-17" aria-hidden="true" tabindex="-1"></a><span class="co"># and converted those that have actual 0 in distance (converted to 0.001 in the code above) back to 0. </span></span>
<span id="cb95-18"><a href="advanced-ssn-metrics.html#cb95-18" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> <span class="fu">graph_from_data_frame</span>(edgeDistance, <span class="at">directed=</span><span class="cn">FALSE</span>, <span class="at">vertices=</span>NYCMafiaNodes)</span>
<span id="cb95-19"><a href="advanced-ssn-metrics.html#cb95-19" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">=</span> <span class="fu">as_adjacency_matrix</span>(g, <span class="at">sparse=</span>F, <span class="at">attr=</span><span class="st">&quot;Distance_m&quot;</span>) </span>
<span id="cb95-20"><a href="advanced-ssn-metrics.html#cb95-20" aria-hidden="true" tabindex="-1"></a>mat[mat<span class="sc">==</span><span class="dv">0</span>]<span class="ot">&lt;-</span><span class="cn">NA</span></span>
<span id="cb95-21"><a href="advanced-ssn-metrics.html#cb95-21" aria-hidden="true" tabindex="-1"></a>mat[mat<span class="sc">==</span><span class="fl">0.001</span>]<span class="ot">&lt;-</span><span class="dv">0</span></span>
<span id="cb95-22"><a href="advanced-ssn-metrics.html#cb95-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-23"><a href="advanced-ssn-metrics.html#cb95-23" aria-hidden="true" tabindex="-1"></a><span class="co"># find SSN hotspots within 1 mile (~1600m) walking distance! </span></span>
<span id="cb95-24"><a href="advanced-ssn-metrics.html#cb95-24" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> <span class="fu">processNode</span>(NYCMafiaNodes, <span class="st">&#39;label&#39;</span>, <span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>)</span>
<span id="cb95-25"><a href="advanced-ssn-metrics.html#cb95-25" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> <span class="fu">processEdge</span>(NYCMafiaEdges, <span class="st">&#39;Source&#39;</span>, <span class="st">&#39;Target&#39;</span>)</span>
<span id="cb95-26"><a href="advanced-ssn-metrics.html#cb95-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-27"><a href="advanced-ssn-metrics.html#cb95-27" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">edgeScanMatrix</span>(nodes, edges, <span class="dv">1600</span>, mat, <span class="at">min=</span><span class="dv">3</span>)</span>
<span id="cb95-28"><a href="advanced-ssn-metrics.html#cb95-28" aria-hidden="true" tabindex="-1"></a>heat <span class="ot">=</span> result[[<span class="dv">1</span>]]</span>
<span id="cb95-29"><a href="advanced-ssn-metrics.html#cb95-29" aria-hidden="true" tabindex="-1"></a>edgeWithin <span class="ot">=</span> result[[<span class="dv">2</span>]]</span>
<span id="cb95-30"><a href="advanced-ssn-metrics.html#cb95-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-31"><a href="advanced-ssn-metrics.html#cb95-31" aria-hidden="true" tabindex="-1"></a>heat[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span></code></pre></div>
<pre><code>##               label heat
## 1 AMAROSA-ALEXANDER   NA
## 2   VINTALORO-JAMES   NA
## 3   TANTILLO-ENRICO   NA</code></pre>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb97-1"><a href="advanced-ssn-metrics.html#cb97-1" aria-hidden="true" tabindex="-1"></a>edgeWithin[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span></code></pre></div>
<pre><code>##            Source         Target WithinWindow
## 1 SALERNO-ANTHONY ALBERO-CHARLES            0
## 2    CARUSO-FRANK  NOBILE-GEORGE            0
## 3    LISI-GAETANO     MARI-FRANK            0</code></pre>
</div>
<div id="application-to-a-weighted-and-bipartite-network" class="section level3" number="6.1.5">
<h3><span class="header-section-number">6.1.5</span> Application to a weighted and bipartite network</h3>
<p>We have applied the <strong>EdgeScan</strong> and <strong>NDScan</strong> functions to <strong>NYCMafiaNodes</strong> and <strong>NYCMafiaEdges</strong>, which is an unweighted, undirected, and non-bipartite network. We can apply the same functions to a weighted and/or bipartite network, using sample dataset <strong>POINodes</strong> and <strong>POIEdges</strong> in <code>SSNtools</code>.</p>
<p>If you are using your own dataset, there should be a bipartite column that indicates which set the node is in. The set that would like have EdgeScan or NDScan values reported should be coded as 1, and 0 otherwise. In our <strong>POINodes</strong> sample dataset, restaurant POIs are coded as 1 and census block group centroids are coded as 0 in the bipartite network. Please reference the sample dataset if you are unclear of the input formats.</p>
<p>We chose <strong>K-nearest neighbor</strong> as the neighborhood definition for analyzing the sample dataset and <strong>KNN=5</strong> as the window size. Here, the distance between the POI (restaurant) and census block group centroids vary across geographic space, because the size of the census block groups tend to be smaller in the city center than the suburbs. Thus, a KNN neighborhood definition is better because it searches for the five closest census block groups (CBGs) around the POI, ignoring distances between the two.</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb99-1"><a href="advanced-ssn-metrics.html#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SSNtools)</span>
<span id="cb99-2"><a href="advanced-ssn-metrics.html#cb99-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-3"><a href="advanced-ssn-metrics.html#cb99-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(POINodes)</span>
<span id="cb99-4"><a href="advanced-ssn-metrics.html#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(POIEdges)</span>
<span id="cb99-5"><a href="advanced-ssn-metrics.html#cb99-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-6"><a href="advanced-ssn-metrics.html#cb99-6" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> <span class="fu">processNode</span>(POINodes, <span class="st">&#39;label&#39;</span>, <span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>, <span class="st">&#39;Bipartite&#39;</span>)</span>
<span id="cb99-7"><a href="advanced-ssn-metrics.html#cb99-7" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> <span class="fu">processEdge</span>(POIEdges, <span class="st">&#39;Source&#39;</span>, <span class="st">&#39;Target&#39;</span>, <span class="st">&#39;Weight&#39;</span>)</span></code></pre></div>
<p>The following codes use <code>edgeScanKnearest()</code>:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb100-1"><a href="advanced-ssn-metrics.html#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate edgeScan values for KNN = 5 in a weighted, bipartite network</span></span>
<span id="cb100-2"><a href="advanced-ssn-metrics.html#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="co"># this takes about 3 mins to run</span></span>
<span id="cb100-3"><a href="advanced-ssn-metrics.html#cb100-3" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">edgeScanKNearest</span>(nodes, edges, <span class="dv">5</span>, <span class="at">weighted=</span><span class="cn">TRUE</span>, <span class="at">bipartite=</span><span class="cn">TRUE</span>)</span>
<span id="cb100-4"><a href="advanced-ssn-metrics.html#cb100-4" aria-hidden="true" tabindex="-1"></a>heat <span class="ot">=</span> result[[<span class="dv">1</span>]]</span>
<span id="cb100-5"><a href="advanced-ssn-metrics.html#cb100-5" aria-hidden="true" tabindex="-1"></a>edgeWithin <span class="ot">=</span> result[[<span class="dv">2</span>]]</span>
<span id="cb100-6"><a href="advanced-ssn-metrics.html#cb100-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-7"><a href="advanced-ssn-metrics.html#cb100-7" aria-hidden="true" tabindex="-1"></a>heat[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span>
<span id="cb100-8"><a href="advanced-ssn-metrics.html#cb100-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-9"><a href="advanced-ssn-metrics.html#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   label      heat</span></span>
<span id="cb100-10"><a href="advanced-ssn-metrics.html#cb100-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 1  poi1  476.2827</span></span>
<span id="cb100-11"><a href="advanced-ssn-metrics.html#cb100-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 2  poi2 1250.8860</span></span>
<span id="cb100-12"><a href="advanced-ssn-metrics.html#cb100-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 3  poi3 1160.1423</span></span>
<span id="cb100-13"><a href="advanced-ssn-metrics.html#cb100-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-14"><a href="advanced-ssn-metrics.html#cb100-14" aria-hidden="true" tabindex="-1"></a>edgeWithin[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span>
<span id="cb100-15"><a href="advanced-ssn-metrics.html#cb100-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-16"><a href="advanced-ssn-metrics.html#cb100-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   Source       Target    Weight WithinWindow                       </span></span>
<span id="cb100-17"><a href="advanced-ssn-metrics.html#cb100-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 1   poi1 130890204001 14.545455            1 </span></span>
<span id="cb100-18"><a href="advanced-ssn-metrics.html#cb100-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2   poi1 130890205002  7.272727            0  </span></span>
<span id="cb100-19"><a href="advanced-ssn-metrics.html#cb100-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 3   poi1 131210001002  7.272727            0</span></span></code></pre></div>
<p>The following codes use <code>NDScanKnearest()</code>:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb101-1"><a href="advanced-ssn-metrics.html#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate NDScan values for KNN = 5 in an undirected, bipartite network</span></span>
<span id="cb101-2"><a href="advanced-ssn-metrics.html#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="co"># this takes about 3 mins to run</span></span>
<span id="cb101-3"><a href="advanced-ssn-metrics.html#cb101-3" aria-hidden="true" tabindex="-1"></a>result <span class="ot">=</span> <span class="fu">NDScanKNearest</span>(nodes, edges, <span class="dv">5</span>, <span class="at">directed=</span><span class="cn">FALSE</span>, <span class="at">bipartite=</span><span class="cn">TRUE</span>)</span>
<span id="cb101-4"><a href="advanced-ssn-metrics.html#cb101-4" aria-hidden="true" tabindex="-1"></a>heat <span class="ot">=</span> result[[<span class="dv">1</span>]]</span>
<span id="cb101-5"><a href="advanced-ssn-metrics.html#cb101-5" aria-hidden="true" tabindex="-1"></a>edgeWithin <span class="ot">=</span> result[[<span class="dv">2</span>]]</span>
<span id="cb101-6"><a href="advanced-ssn-metrics.html#cb101-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-7"><a href="advanced-ssn-metrics.html#cb101-7" aria-hidden="true" tabindex="-1"></a>heat[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span>
<span id="cb101-8"><a href="advanced-ssn-metrics.html#cb101-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-9"><a href="advanced-ssn-metrics.html#cb101-9" aria-hidden="true" tabindex="-1"></a><span class="co">#   label      heat</span></span>
<span id="cb101-10"><a href="advanced-ssn-metrics.html#cb101-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 1  poi1 0.2758621</span></span>
<span id="cb101-11"><a href="advanced-ssn-metrics.html#cb101-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 2  poi2 0.2254428</span></span>
<span id="cb101-12"><a href="advanced-ssn-metrics.html#cb101-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 3  poi3 0.3029557</span></span>
<span id="cb101-13"><a href="advanced-ssn-metrics.html#cb101-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-14"><a href="advanced-ssn-metrics.html#cb101-14" aria-hidden="true" tabindex="-1"></a>edgeWithin[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span>
<span id="cb101-15"><a href="advanced-ssn-metrics.html#cb101-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-16"><a href="advanced-ssn-metrics.html#cb101-16" aria-hidden="true" tabindex="-1"></a><span class="co">#   Source       Target WithinWindow</span></span>
<span id="cb101-17"><a href="advanced-ssn-metrics.html#cb101-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 1   poi1 130890204001            1</span></span>
<span id="cb101-18"><a href="advanced-ssn-metrics.html#cb101-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2   poi1 130890205002            0</span></span>
<span id="cb101-19"><a href="advanced-ssn-metrics.html#cb101-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 3   poi1 131210001002            0</span></span></code></pre></div>
<p><strong>Interpret Outputs</strong></p>
<p>Note that when the network is weighted, <strong>edgeScan</strong> related functions report <strong>the sum of edge weights</strong> instead of <strong>the number of edges</strong>. If the network is bipartite, <strong>only nodes whose bipartite value is coded as 1 (in this case, POI) will report values</strong>. The formula to calculate network density also changes if a network is bipartite (see Figure: Schematic Diagram of EdgeScan and NDScan Values Calculation above). Based on the definitions of <strong>EdgeScan</strong> and <strong>NDScan</strong>, <strong>directed</strong> argument is only implemented for ND-functions, while <strong>weighted</strong> is only implemented for the Edge-functions.</p>
<p>To visualize the POI visits hotspots, you can use the following codes as a reference.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb102-1"><a href="advanced-ssn-metrics.html#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb102-2"><a href="advanced-ssn-metrics.html#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb102-3"><a href="advanced-ssn-metrics.html#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(basemaps)</span>
<span id="cb102-4"><a href="advanced-ssn-metrics.html#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb102-5"><a href="advanced-ssn-metrics.html#cb102-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-6"><a href="advanced-ssn-metrics.html#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="co"># convert heat dataframe to a spatial sf object</span></span>
<span id="cb102-7"><a href="advanced-ssn-metrics.html#cb102-7" aria-hidden="true" tabindex="-1"></a>POISpatial <span class="ot">=</span> heat <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(POINodes, <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>), <span class="at">crs=</span><span class="dv">26967</span>)</span>
<span id="cb102-8"><a href="advanced-ssn-metrics.html#cb102-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-9"><a href="advanced-ssn-metrics.html#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="co"># attach spatial information to edgeWithin and convert edgeWithin dataframe to line geometry </span></span>
<span id="cb102-10"><a href="advanced-ssn-metrics.html#cb102-10" aria-hidden="true" tabindex="-1"></a>edgeWithin <span class="ot">=</span> edgeWithin <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(POINodes, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;Source&#39;</span> <span class="ot">=</span> <span class="st">&#39;label&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb102-11"><a href="advanced-ssn-metrics.html#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(POINodes, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;Target&#39;</span> <span class="ot">=</span> <span class="st">&#39;label&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) </span>
<span id="cb102-12"><a href="advanced-ssn-metrics.html#cb102-12" aria-hidden="true" tabindex="-1"></a><span class="co"># convert points to lines without stplanar package. See Chapter 4.1.3.</span></span>
<span id="cb102-13"><a href="advanced-ssn-metrics.html#cb102-13" aria-hidden="true" tabindex="-1"></a>st_segment <span class="ot">=</span> <span class="cf">function</span>(r){<span class="fu">st_linestring</span>(<span class="fu">t</span>(<span class="fu">matrix</span>(<span class="fu">unlist</span>(r), <span class="dv">2</span>, <span class="dv">2</span>)))}</span>
<span id="cb102-14"><a href="advanced-ssn-metrics.html#cb102-14" aria-hidden="true" tabindex="-1"></a>edgeWithin<span class="sc">$</span>geometry <span class="ot">=</span> <span class="fu">st_sfc</span>(</span>
<span id="cb102-15"><a href="advanced-ssn-metrics.html#cb102-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(edgeWithin), </span>
<span id="cb102-16"><a href="advanced-ssn-metrics.html#cb102-16" aria-hidden="true" tabindex="-1"></a>         <span class="cf">function</span>(i){<span class="fu">st_segment</span>(edgeWithin[i,][<span class="fu">c</span>(<span class="st">&#39;LonX.x&#39;</span>, <span class="st">&#39;LatY.x&#39;</span>, <span class="st">&#39;LonX.y&#39;</span>, <span class="st">&#39;LatY.y&#39;</span>)])},</span>
<span id="cb102-17"><a href="advanced-ssn-metrics.html#cb102-17" aria-hidden="true" tabindex="-1"></a>         <span class="at">simplify=</span><span class="cn">FALSE</span>)) </span>
<span id="cb102-18"><a href="advanced-ssn-metrics.html#cb102-18" aria-hidden="true" tabindex="-1"></a><span class="co"># convert edgeWithin back to sf object and filter edges to be within the window </span></span>
<span id="cb102-19"><a href="advanced-ssn-metrics.html#cb102-19" aria-hidden="true" tabindex="-1"></a>edgeWithin <span class="ot">=</span> edgeWithin <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> <span class="fu">st_set_crs</span>(<span class="dv">26967</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb102-20"><a href="advanced-ssn-metrics.html#cb102-20" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(WithinWindow <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb102-21"><a href="advanced-ssn-metrics.html#cb102-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-22"><a href="advanced-ssn-metrics.html#cb102-22" aria-hidden="true" tabindex="-1"></a><span class="co"># create basemap</span></span>
<span id="cb102-23"><a href="advanced-ssn-metrics.html#cb102-23" aria-hidden="true" tabindex="-1"></a><span class="fu">set_defaults</span>(<span class="at">map_service =</span> <span class="st">&quot;carto&quot;</span>, <span class="at">map_type =</span> <span class="st">&quot;light&quot;</span>)</span>
<span id="cb102-24"><a href="advanced-ssn-metrics.html#cb102-24" aria-hidden="true" tabindex="-1"></a>bgbox <span class="ot">=</span> <span class="fu">st_bbox</span>(POISpatial)</span>
<span id="cb102-25"><a href="advanced-ssn-metrics.html#cb102-25" aria-hidden="true" tabindex="-1"></a>bg <span class="ot">=</span> <span class="fu">basemap_stars</span>(bgbox, <span class="at">map_service =</span> <span class="st">&#39;carto&#39;</span>)</span>
<span id="cb102-26"><a href="advanced-ssn-metrics.html#cb102-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-27"><a href="advanced-ssn-metrics.html#cb102-27" aria-hidden="true" tabindex="-1"></a><span class="co"># parameters for visualization</span></span>
<span id="cb102-28"><a href="advanced-ssn-metrics.html#cb102-28" aria-hidden="true" tabindex="-1"></a>legend_name <span class="ot">=</span> <span class="st">&#39;Network Density&#39;</span></span>
<span id="cb102-29"><a href="advanced-ssn-metrics.html#cb102-29" aria-hidden="true" tabindex="-1"></a>k <span class="ot">=</span> <span class="st">&#39;5&#39;</span></span>
<span id="cb102-30"><a href="advanced-ssn-metrics.html#cb102-30" aria-hidden="true" tabindex="-1"></a>breaks <span class="ot">=</span> <span class="fu">c</span>(<span class="fl">0.07</span>, <span class="fl">0.30</span>, <span class="fl">0.40</span>, <span class="fl">0.50</span>, <span class="dv">1</span>)</span>
<span id="cb102-31"><a href="advanced-ssn-metrics.html#cb102-31" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;[0.07, 0.30)&#39;</span>, <span class="st">&#39;[0.3, 0.4)&#39;</span>, <span class="st">&#39;[0.4, 0.50)&#39;</span>, <span class="st">&#39;[0.50, 0.75]&#39;</span>)</span>
<span id="cb102-32"><a href="advanced-ssn-metrics.html#cb102-32" aria-hidden="true" tabindex="-1"></a>output <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&#39;Atlanta POI Visits NDScan&#39;</span>)</span>
<span id="cb102-33"><a href="advanced-ssn-metrics.html#cb102-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-34"><a href="advanced-ssn-metrics.html#cb102-34" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize the SSN hotspots</span></span>
<span id="cb102-35"><a href="advanced-ssn-metrics.html#cb102-35" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb102-36"><a href="advanced-ssn-metrics.html#cb102-36" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> <span class="fu">tm_shape</span>(bg) <span class="sc">+</span> </span>
<span id="cb102-37"><a href="advanced-ssn-metrics.html#cb102-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_rgb</span>(<span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span> </span>
<span id="cb102-38"><a href="advanced-ssn-metrics.html#cb102-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(edgeWithin) <span class="sc">+</span> </span>
<span id="cb102-39"><a href="advanced-ssn-metrics.html#cb102-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb102-40"><a href="advanced-ssn-metrics.html#cb102-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(POISpatial) <span class="sc">+</span> </span>
<span id="cb102-41"><a href="advanced-ssn-metrics.html#cb102-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_symbols</span>(<span class="at">col=</span><span class="st">&#39;heat&#39;</span>, <span class="at">size=</span><span class="fl">0.05</span>, <span class="at">style=</span><span class="st">&#39;fixed&#39;</span>, <span class="at">legend.col.show =</span> <span class="cn">FALSE</span>, </span>
<span id="cb102-42"><a href="advanced-ssn-metrics.html#cb102-42" aria-hidden="true" tabindex="-1"></a>             <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">&#39;#FBD977&#39;</span>, <span class="st">&#39;#F78D3D&#39;</span>, <span class="st">&#39;#E3211B&#39;</span>, <span class="st">&#39;#800F26&#39;</span>), <span class="at">breaks=</span>breaks) <span class="sc">+</span></span>
<span id="cb102-43"><a href="advanced-ssn-metrics.html#cb102-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_add_legend</span>(<span class="at">type=</span><span class="st">&#39;symbol&#39;</span>, <span class="at">labels=</span>labels, <span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;#FBD977&#39;</span>, <span class="st">&#39;#F78D3D&#39;</span>, <span class="st">&#39;#E3211B&#39;</span>, <span class="st">&#39;#800F26&#39;</span>),</span>
<span id="cb102-44"><a href="advanced-ssn-metrics.html#cb102-44" aria-hidden="true" tabindex="-1"></a>                <span class="at">title=</span><span class="fu">paste0</span>(legend_name, <span class="st">&#39; (KNN = &#39;</span>, k, <span class="st">&#39;)&#39;</span>), <span class="at">size=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb102-45"><a href="advanced-ssn-metrics.html#cb102-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_add_legend</span>(<span class="at">type=</span><span class="st">&#39;line&#39;</span>, <span class="at">labels=</span><span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">&#39;Edges within window size&#39;</span>)), <span class="at">col=</span><span class="st">&#39;black&#39;</span>, <span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb102-46"><a href="advanced-ssn-metrics.html#cb102-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_scale_bar</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>), <span class="at">text.size =</span> <span class="dv">1</span>) <span class="sc">+</span>  </span>
<span id="cb102-47"><a href="advanced-ssn-metrics.html#cb102-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.title.size =</span> <span class="fl">1.3</span>, <span class="at">legend.text.size =</span> <span class="dv">1</span>, <span class="at">legend.width =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb102-48"><a href="advanced-ssn-metrics.html#cb102-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.bg.color =</span> <span class="st">&#39;white&#39;</span>, <span class="at">legend.bg.alpha =</span> <span class="fl">0.7</span>,</span>
<span id="cb102-49"><a href="advanced-ssn-metrics.html#cb102-49" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title =</span> output,</span>
<span id="cb102-50"><a href="advanced-ssn-metrics.html#cb102-50" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title.position =</span> <span class="fu">c</span>(<span class="st">&#39;center&#39;</span>)) </span></code></pre></div>
<p><img src="Figs/06-metrics-POIvisits.png" width="70%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="k-fullfillment" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> K-fullfillment</h2>
<p><strong>K-fullfillment</strong> is a node-level metric to describe local (dis)connection. It is defined as the percentage of a node’s K-nearest neighbors (in Euclidean space) that it is connected (i.e., connected K-nearest neighbors divided by total K-nearest neighbors). Here, <code>K</code> is equal to the node’s degree. Nodes that are exclusively connected to their nearest neighbors will have a K-fulfillment value of 1. K-fullfillment assumes that the target SSN is an unweighted, undirected network.</p>
<p>Here are some example research questions that can be answered by the <strong>K-fullfillment</strong> metric:</p>
<ul>
<li>(Mafia members SSN) Which mafia members have strong local connections (i.e., higher percentage of K-nearest neighbors connected)?</li>
<li>(Restaurant POI visits SSN) Which restaurant tends to serve residents from nearby census block groups?</li>
<li>(Food sharing SSN) Which organization is highly connected to other local organizations?</li>
</ul>
<p>Our tutorial will cover the following topics:</p>
<ul>
<li>How to calculate K-fullfillment values on the node level using <code>Kfullfillment()</code> in <code>SSNtools</code>.</li>
<li>How to visualize K-fullfillment values on the node level and connections to the nearest neighbors.</li>
</ul>
<p>We will continue to use sample dataset <strong>NYCMafiaNodes</strong>, <strong>NYCMafiaEdges</strong>, <strong>POINodes</strong>, and <strong>POIEdges</strong> in <code>SSNtools</code> to illustrate examples. To load the sample dataset and the functions, go to GitHub <a href="https://github.com/friendlycities-gatech/SSNtools">SSNtool</a> to download the development R package, or type the following lines in your R console. Click the GitHub page for more detailed description of all the functions available in the package and the input formats for each function.</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb103-1"><a href="advanced-ssn-metrics.html#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;devtools&quot;)</span></span>
<span id="cb103-2"><a href="advanced-ssn-metrics.html#cb103-2" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;friendlycities-gatech/SSNtools&quot;</span>)</span></code></pre></div>
<p><strong>NYCMafiaNodes</strong> is a node table with label and spatial coordinates for each node (a mafia member). <strong>NYCMafiaeEdges</strong> contains pairs of node labels (corresponding to node table label), representing mafia criminal associations. This is a unweighted and undirected network. The coordinate system crs is 32118, in the unit of meters.</p>
<p>Data in <strong>POINodes</strong> and <strong>POIEdges</strong> are processed from SafeGraph with extra filters and coding to hide sensitive information. The dataset is meant to be educational and thus can be inaccurate for real implications. The nodes in the dataset are restaurants in Atlanta (set 0) and centroids of census block group (set 1). The edges in the dataset are visits from the census block group to restaurants. The weight of the edges represent the percentage of total visits coming from a particular census block group. You can call <strong>POINodes</strong> (n=1356) and <strong>POIEdges</strong> (n=7926) to directly access the sample dataset. The coordinates system is transformed with crs=26967 (unit meter).</p>
<div id="calculate-k-fullfillment-values" class="section level3" number="6.2.1">
<h3><span class="header-section-number">6.2.1</span> Calculate K-fullfillment values</h3>
<p>To get K-fullfillment value for each node, you just need to run your node and edge dataframe through the following codes:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb104-1"><a href="advanced-ssn-metrics.html#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SSNtools)</span>
<span id="cb104-2"><a href="advanced-ssn-metrics.html#cb104-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-3"><a href="advanced-ssn-metrics.html#cb104-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(NYCMafiaNodes)</span>
<span id="cb104-4"><a href="advanced-ssn-metrics.html#cb104-4" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(NYCMafiaEdges)</span>
<span id="cb104-5"><a href="advanced-ssn-metrics.html#cb104-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-6"><a href="advanced-ssn-metrics.html#cb104-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ----process dataframe into a list of lists </span></span>
<span id="cb104-7"><a href="advanced-ssn-metrics.html#cb104-7" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb104-8"><a href="advanced-ssn-metrics.html#cb104-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     data - a R dataframe containing node label, longitude, and latitude</span></span>
<span id="cb104-9"><a href="advanced-ssn-metrics.html#cb104-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     label_name - the name of the column for node label</span></span>
<span id="cb104-10"><a href="advanced-ssn-metrics.html#cb104-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     lon_name - the name of the column for node longitude </span></span>
<span id="cb104-11"><a href="advanced-ssn-metrics.html#cb104-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     lat_name - the name of the column for node latitude</span></span>
<span id="cb104-12"><a href="advanced-ssn-metrics.html#cb104-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     bipartite_name - (optional) the name of the column that indicates the bipartite set of the nodes. The set of nodes that EdgeScan or NDScan should report on should be coded as 1 in the biparite column, and 0 otherwise.  </span></span>
<span id="cb104-13"><a href="advanced-ssn-metrics.html#cb104-13" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> <span class="fu">processNode</span>(NYCMafiaNodes, <span class="st">&#39;label&#39;</span>, <span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>)</span>
<span id="cb104-14"><a href="advanced-ssn-metrics.html#cb104-14" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb104-15"><a href="advanced-ssn-metrics.html#cb104-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     data - a R dataframe containing source node label and target node label</span></span>
<span id="cb104-16"><a href="advanced-ssn-metrics.html#cb104-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     source_name - the name of the column for source node label</span></span>
<span id="cb104-17"><a href="advanced-ssn-metrics.html#cb104-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     target_name - the name of the column for target node label</span></span>
<span id="cb104-18"><a href="advanced-ssn-metrics.html#cb104-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     weight_name - (optional) the name of the column for edge weight </span></span>
<span id="cb104-19"><a href="advanced-ssn-metrics.html#cb104-19" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> <span class="fu">processEdge</span>(NYCMafiaEdges, <span class="st">&#39;Source&#39;</span>, <span class="st">&#39;Target&#39;</span>)</span>
<span id="cb104-20"><a href="advanced-ssn-metrics.html#cb104-20" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb104-21"><a href="advanced-ssn-metrics.html#cb104-21" aria-hidden="true" tabindex="-1"></a><span class="co">#     nodes - a list of named lists. Each sublist contains a node.</span></span>
<span id="cb104-22"><a href="advanced-ssn-metrics.html#cb104-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     edges - a list of list. Each sublist contains an edge.</span></span>
<span id="cb104-23"><a href="advanced-ssn-metrics.html#cb104-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     minK - (optional) minimum K (degree) for a node to have K-fullfillment value. Default to minK = 1.</span></span>
<span id="cb104-24"><a href="advanced-ssn-metrics.html#cb104-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     bipartite - (optional) whether the K-fullfillment will only be reported for nodes whose bipartite column is coded as 1. Default to FALSE.</span></span>
<span id="cb104-25"><a href="advanced-ssn-metrics.html#cb104-25" aria-hidden="true" tabindex="-1"></a><span class="co"># return:</span></span>
<span id="cb104-26"><a href="advanced-ssn-metrics.html#cb104-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     list(nodelist, edgelist) - a list of two dataframe for node and edge table. </span></span>
<span id="cb104-27"><a href="advanced-ssn-metrics.html#cb104-27" aria-hidden="true" tabindex="-1"></a>results <span class="ot">=</span> <span class="fu">Kfullfillment</span>(nodes, edges)</span>
<span id="cb104-28"><a href="advanced-ssn-metrics.html#cb104-28" aria-hidden="true" tabindex="-1"></a>nodelist <span class="ot">=</span> results[[<span class="dv">1</span>]]</span>
<span id="cb104-29"><a href="advanced-ssn-metrics.html#cb104-29" aria-hidden="true" tabindex="-1"></a>edgelist <span class="ot">=</span> results[[<span class="dv">2</span>]]</span>
<span id="cb104-30"><a href="advanced-ssn-metrics.html#cb104-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-31"><a href="advanced-ssn-metrics.html#cb104-31" aria-hidden="true" tabindex="-1"></a>nodelist[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>), ]</span></code></pre></div>
<pre><code>##               label  K K_fullfillment
## 1 AMAROSA-ALEXANDER  3     0.33333333
## 2   VINTALORO-JAMES  6     0.00000000
## 3   TANTILLO-ENRICO 12     0.08333333</code></pre>
<div class="sourceCode" id="cb106"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb106-1"><a href="advanced-ssn-metrics.html#cb106-1" aria-hidden="true" tabindex="-1"></a>edgelist[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>), ]</span></code></pre></div>
<pre><code>##            Source         Target is_K_nearest_neighbor
## 1 SALERNO-ANTHONY ALBERO-CHARLES                     0
## 2    CARUSO-FRANK  NOBILE-GEORGE                     0
## 3    LISI-GAETANO     MARI-FRANK                     1</code></pre>
<p><strong>Interpret Outputs</strong></p>
<p><code>Kfullfillment()</code> will return a list of two dataframes. The first dataframe is a node dataframe wtih three columns:</p>
<ul>
<li><code>label</code>: the node label</li>
<li><code>K</code>: the node’s degree K, which is the same K for the node’s K-nearest neighbors.<br />
</li>
<li><code>K-fullfillment</code>: the percentage of a node’s K-nearest neighbors that it is connected. Nodes that are exclusively connected to their nearest neighbors will have a k-fulfillment value of 1.</li>
</ul>
<p>The second dataframe is an edge dataframe that has three columns:</p>
<ul>
<li><code>Source</code>: source node label</li>
<li><code>Target</code>: target node label</li>
<li><code>is_K_nearest_neighbor</code>: binary value (1 or 0) indicating whether the edge represented a connection that is also within the source or target node’s K-nearest neighbors.</li>
</ul>
</div>
<div id="visualize-k-fullfillment" class="section level3" number="6.2.2">
<h3><span class="header-section-number">6.2.2</span> Visualize K-fullfillment</h3>
<p>To visualize <strong>Kfullfillment</strong> values on the node level, you can use the following codes as a reference.</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb108-1"><a href="advanced-ssn-metrics.html#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="co"># packages for wrangling data and map visualization</span></span>
<span id="cb108-2"><a href="advanced-ssn-metrics.html#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb108-3"><a href="advanced-ssn-metrics.html#cb108-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb108-4"><a href="advanced-ssn-metrics.html#cb108-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb108-5"><a href="advanced-ssn-metrics.html#cb108-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stplanr)</span>
<span id="cb108-6"><a href="advanced-ssn-metrics.html#cb108-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(basemaps)</span>
<span id="cb108-7"><a href="advanced-ssn-metrics.html#cb108-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-8"><a href="advanced-ssn-metrics.html#cb108-8" aria-hidden="true" tabindex="-1"></a><span class="co"># convert heat dataframe to a spatial sf object</span></span>
<span id="cb108-9"><a href="advanced-ssn-metrics.html#cb108-9" aria-hidden="true" tabindex="-1"></a>MafiaSpatial <span class="ot">=</span> nodelist <span class="sc">%&gt;%</span> </span>
<span id="cb108-10"><a href="advanced-ssn-metrics.html#cb108-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(NYCMafiaNodes, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;label&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>), <span class="at">crs=</span><span class="dv">32118</span>)</span>
<span id="cb108-11"><a href="advanced-ssn-metrics.html#cb108-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-12"><a href="advanced-ssn-metrics.html#cb108-12" aria-hidden="true" tabindex="-1"></a><span class="co"># convert edgelist dataframe to line geometry</span></span>
<span id="cb108-13"><a href="advanced-ssn-metrics.html#cb108-13" aria-hidden="true" tabindex="-1"></a>NYCMafiaEdges_shp <span class="ot">=</span> <span class="fu">od2line</span>(edgelist, MafiaSpatial) </span>
<span id="cb108-14"><a href="advanced-ssn-metrics.html#cb108-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-15"><a href="advanced-ssn-metrics.html#cb108-15" aria-hidden="true" tabindex="-1"></a><span class="co"># create basemap with functions from basemaps library</span></span>
<span id="cb108-16"><a href="advanced-ssn-metrics.html#cb108-16" aria-hidden="true" tabindex="-1"></a><span class="fu">set_defaults</span>(<span class="at">map_service =</span> <span class="st">&quot;carto&quot;</span>, <span class="at">map_type =</span> <span class="st">&quot;light&quot;</span>)</span>
<span id="cb108-17"><a href="advanced-ssn-metrics.html#cb108-17" aria-hidden="true" tabindex="-1"></a>bgbox <span class="ot">=</span> <span class="fu">st_bbox</span>(MafiaSpatial) <span class="sc">%&gt;%</span> <span class="fu">st_as_sfc</span>()</span>
<span id="cb108-18"><a href="advanced-ssn-metrics.html#cb108-18" aria-hidden="true" tabindex="-1"></a>bg <span class="ot">=</span> <span class="fu">basemap_stars</span>(bgbox)</span></code></pre></div>
<pre><code>## Loading basemap &#39;light&#39; from map service &#39;carto&#39;...</code></pre>
<div class="sourceCode" id="cb110"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb110-1"><a href="advanced-ssn-metrics.html#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb110-2"><a href="advanced-ssn-metrics.html#cb110-2" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> </span>
<span id="cb110-3"><a href="advanced-ssn-metrics.html#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map base map</span></span>
<span id="cb110-4"><a href="advanced-ssn-metrics.html#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(bg) <span class="sc">+</span></span>
<span id="cb110-5"><a href="advanced-ssn-metrics.html#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_rgb</span>(<span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb110-6"><a href="advanced-ssn-metrics.html#cb110-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map all edges in grey</span></span>
<span id="cb110-7"><a href="advanced-ssn-metrics.html#cb110-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(NYCMafiaEdges_shp) <span class="sc">+</span> </span>
<span id="cb110-8"><a href="advanced-ssn-metrics.html#cb110-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">alpha=</span><span class="fl">0.5</span>, <span class="at">col=</span><span class="st">&#39;grey&#39;</span>) <span class="sc">+</span> </span>
<span id="cb110-9"><a href="advanced-ssn-metrics.html#cb110-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map edges that also connect to K-nearest neighbors in black </span></span>
<span id="cb110-10"><a href="advanced-ssn-metrics.html#cb110-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(NYCMafiaEdges_shp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(is_K_nearest_neighbor <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb110-11"><a href="advanced-ssn-metrics.html#cb110-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">alpha=</span><span class="fl">0.5</span>, <span class="at">col=</span><span class="st">&#39;black&#39;</span>) <span class="sc">+</span> </span>
<span id="cb110-12"><a href="advanced-ssn-metrics.html#cb110-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map nodes colored by K_fullfillment. Nodes with higher K_fullfillment values mapped last. </span></span>
<span id="cb110-13"><a href="advanced-ssn-metrics.html#cb110-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(MafiaSpatial <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(K_fullfillment)) <span class="sc">+</span> </span>
<span id="cb110-14"><a href="advanced-ssn-metrics.html#cb110-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_symbols</span>(<span class="at">col=</span><span class="st">&#39;K_fullfillment&#39;</span>, <span class="at">size=</span><span class="fl">0.1</span>, <span class="at">style=</span><span class="st">&#39;fixed&#39;</span>, </span>
<span id="cb110-15"><a href="advanced-ssn-metrics.html#cb110-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.00001</span>, <span class="fl">0.10</span>, <span class="fl">0.25</span>, <span class="dv">1</span>),</span>
<span id="cb110-16"><a href="advanced-ssn-metrics.html#cb110-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">&#39;#FBD977&#39;</span>, <span class="st">&#39;#F78D3D&#39;</span>, <span class="st">&#39;#E3211B&#39;</span>, <span class="st">&#39;#800F26&#39;</span>),</span>
<span id="cb110-17"><a href="advanced-ssn-metrics.html#cb110-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">legend.col.show =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb110-18"><a href="advanced-ssn-metrics.html#cb110-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># customize legend and layout</span></span>
<span id="cb110-19"><a href="advanced-ssn-metrics.html#cb110-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_add_legend</span>(<span class="at">type=</span><span class="st">&#39;symbol&#39;</span>, </span>
<span id="cb110-20"><a href="advanced-ssn-metrics.html#cb110-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&#39;0&#39;</span>, <span class="st">&#39;(0, 0.10]&#39;</span>, <span class="st">&#39;(0.10, 0.25]&#39;</span>, <span class="st">&#39;(0.25, 1]&#39;</span>, <span class="st">&#39;NA (Less than minK)&#39;</span>), </span>
<span id="cb110-21"><a href="advanced-ssn-metrics.html#cb110-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;#FBD977&#39;</span>, <span class="st">&#39;#F78D3D&#39;</span>, <span class="st">&#39;#E3211B&#39;</span>, <span class="st">&#39;#800F26&#39;</span>, <span class="st">&#39;grey&#39;</span>), </span>
<span id="cb110-22"><a href="advanced-ssn-metrics.html#cb110-22" aria-hidden="true" tabindex="-1"></a>                <span class="at">is.portrait =</span> T, <span class="at">title=</span><span class="fu">c</span>(<span class="st">&#39;K-fullfillment&#39;</span>), <span class="at">size=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb110-23"><a href="advanced-ssn-metrics.html#cb110-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_add_legend</span>(<span class="at">type=</span><span class="st">&#39;line&#39;</span>, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&#39;Edges also Connect to KNN&#39;</span>, <span class="st">&#39;All Edges&#39;</span>), </span>
<span id="cb110-24"><a href="advanced-ssn-metrics.html#cb110-24" aria-hidden="true" tabindex="-1"></a>                <span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;grey&#39;</span>), <span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb110-25"><a href="advanced-ssn-metrics.html#cb110-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_scale_bar</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>), <span class="at">text.size =</span> <span class="fl">0.7</span>, <span class="at">position=</span><span class="fu">c</span>(<span class="fl">0.78</span>,<span class="fl">0.9</span>)) <span class="sc">+</span>  </span>
<span id="cb110-26"><a href="advanced-ssn-metrics.html#cb110-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.title.size =</span> <span class="fl">0.9</span>, <span class="at">legend.text.size =</span> <span class="fl">0.7</span>, <span class="at">legend.width =</span> <span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb110-27"><a href="advanced-ssn-metrics.html#cb110-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">main.title =</span> <span class="st">&#39;NYC Mafia SSN K-fullfillment&#39;</span>,</span>
<span id="cb110-28"><a href="advanced-ssn-metrics.html#cb110-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title.position =</span> <span class="fu">c</span>(<span class="st">&#39;center&#39;</span>),</span>
<span id="cb110-29"><a href="advanced-ssn-metrics.html#cb110-29" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title.size =</span> <span class="fl">1.5</span>)</span>
<span id="cb110-30"><a href="advanced-ssn-metrics.html#cb110-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-31"><a href="advanced-ssn-metrics.html#cb110-31" aria-hidden="true" tabindex="-1"></a>g</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-93-1.png" width="672" /></p>
</div>
<div id="application-to-a-bipartite-network" class="section level3" number="6.2.3">
<h3><span class="header-section-number">6.2.3</span> Application to a bipartite network</h3>
<p>To calculate <strong>K-fullfillment</strong> values on the node level for a bipartite network, you can use the following codes as a reference. Note that only nodes whose <code>Bipartite</code> column is equal to 1 (in this case, POIs) will have K-fullfillment values.</p>
<div class="sourceCode" id="cb111"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb111-1"><a href="advanced-ssn-metrics.html#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SSNtools)</span>
<span id="cb111-2"><a href="advanced-ssn-metrics.html#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(POINodes)</span>
<span id="cb111-3"><a href="advanced-ssn-metrics.html#cb111-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(POIEdges)</span>
<span id="cb111-4"><a href="advanced-ssn-metrics.html#cb111-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-5"><a href="advanced-ssn-metrics.html#cb111-5" aria-hidden="true" tabindex="-1"></a>POINodes[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1046</span>),]</span>
<span id="cb111-6"><a href="advanced-ssn-metrics.html#cb111-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-7"><a href="advanced-ssn-metrics.html#cb111-7" aria-hidden="true" tabindex="-1"></a><span class="co">#             label Bipartite     LonX     LatY</span></span>
<span id="cb111-8"><a href="advanced-ssn-metrics.html#cb111-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 1            poi1         1 682812.1 418009.0</span></span>
<span id="cb111-9"><a href="advanced-ssn-metrics.html#cb111-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2            poi2         1 681756.2 417956.0</span></span>
<span id="cb111-10"><a href="advanced-ssn-metrics.html#cb111-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 1046 131210016001         0 682506.8 417742.6</span></span>
<span id="cb111-11"><a href="advanced-ssn-metrics.html#cb111-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-12"><a href="advanced-ssn-metrics.html#cb111-12" aria-hidden="true" tabindex="-1"></a>POIEdges[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span>
<span id="cb111-13"><a href="advanced-ssn-metrics.html#cb111-13" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb111-14"><a href="advanced-ssn-metrics.html#cb111-14" aria-hidden="true" tabindex="-1"></a><span class="co">#   Source       Target    Weight</span></span>
<span id="cb111-15"><a href="advanced-ssn-metrics.html#cb111-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 1   poi1 130890204001 14.545455</span></span>
<span id="cb111-16"><a href="advanced-ssn-metrics.html#cb111-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 2   poi1 130890205002  7.272727</span></span>
<span id="cb111-17"><a href="advanced-ssn-metrics.html#cb111-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 3   poi1 131210001002  7.272727</span></span>
<span id="cb111-18"><a href="advanced-ssn-metrics.html#cb111-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-19"><a href="advanced-ssn-metrics.html#cb111-19" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> <span class="fu">processNode</span>(POINodes, <span class="st">&#39;label&#39;</span>, <span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>, <span class="st">&#39;Bipartite&#39;</span>)</span>
<span id="cb111-20"><a href="advanced-ssn-metrics.html#cb111-20" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> <span class="fu">processEdge</span>(POIEdges, <span class="st">&#39;Source&#39;</span>, <span class="st">&#39;Target&#39;</span>, <span class="st">&#39;Weight&#39;</span>)</span>
<span id="cb111-21"><a href="advanced-ssn-metrics.html#cb111-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-22"><a href="advanced-ssn-metrics.html#cb111-22" aria-hidden="true" tabindex="-1"></a>results <span class="ot">=</span> <span class="fu">Kfullfillment</span>(nodes, edges, <span class="at">minK=</span><span class="dv">1</span>, <span class="at">bipartite=</span><span class="cn">TRUE</span>)</span>
<span id="cb111-23"><a href="advanced-ssn-metrics.html#cb111-23" aria-hidden="true" tabindex="-1"></a>nodelist <span class="ot">=</span> results[[<span class="dv">1</span>]]</span>
<span id="cb111-24"><a href="advanced-ssn-metrics.html#cb111-24" aria-hidden="true" tabindex="-1"></a>edgelist <span class="ot">=</span> results[[<span class="dv">2</span>]]</span>
<span id="cb111-25"><a href="advanced-ssn-metrics.html#cb111-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-26"><a href="advanced-ssn-metrics.html#cb111-26" aria-hidden="true" tabindex="-1"></a>nodelist[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span>
<span id="cb111-27"><a href="advanced-ssn-metrics.html#cb111-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-28"><a href="advanced-ssn-metrics.html#cb111-28" aria-hidden="true" tabindex="-1"></a><span class="co">#   label  K K_fullfillment</span></span>
<span id="cb111-29"><a href="advanced-ssn-metrics.html#cb111-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 1  poi1 11      0.3636364</span></span>
<span id="cb111-30"><a href="advanced-ssn-metrics.html#cb111-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 2  poi2 15      0.3333333</span></span>
<span id="cb111-31"><a href="advanced-ssn-metrics.html#cb111-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 3  poi3  7      0.4285714</span></span>
<span id="cb111-32"><a href="advanced-ssn-metrics.html#cb111-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-33"><a href="advanced-ssn-metrics.html#cb111-33" aria-hidden="true" tabindex="-1"></a>edgelist[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span>
<span id="cb111-34"><a href="advanced-ssn-metrics.html#cb111-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-35"><a href="advanced-ssn-metrics.html#cb111-35" aria-hidden="true" tabindex="-1"></a><span class="co">#   Source       Target is_K_nearest_neighbor</span></span>
<span id="cb111-36"><a href="advanced-ssn-metrics.html#cb111-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 1   poi1 130890204001                     1</span></span>
<span id="cb111-37"><a href="advanced-ssn-metrics.html#cb111-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 2   poi1 130890205002                     0</span></span>
<span id="cb111-38"><a href="advanced-ssn-metrics.html#cb111-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 3   poi1 131210001002                     0</span></span></code></pre></div>
</div>
</div>
<div id="flattening-ratio" class="section level2" number="6.3">
<h2><span class="header-section-number">6.3</span> Flattening Ratio</h2>
<p><strong>Global Flattening Ratio</strong> is a network-level metric to measure the spatial tightness of a network. We reference the following definition in the paper <a href="https://www.tandfonline.com/doi/full/10.1080/13658816.2019.1567736">Metrics for characterizing network structure and node importance in Spatial Social Network (Sarkar et al., 2019)</a>. To define the flattening ratio, we first create a degree-constrained nearest neighbour network <span class="math inline">\(\bar{G}\)</span> from the given social network <em>G</em> by reconfiguration, such that each node <em>i</em> in <span class="math inline">\(\bar{G}\)</span> with degree <em>K</em> connects to its nearest <em>K</em> neighbors in Euclidean space. As such, the (global) flattening ratio is the ratio of the sum of the Euclidean distance of edges in <span class="math inline">\(\bar{G}\)</span> where all nodes are connected to their K-nearest neighbors versus the sum of the Euclidean distance of actual edges in <em>G</em>.</p>
<p>Note that many <span class="math inline">\(\bar{G}\)</span> can be possible for one <em>G</em>. Here is an example:</p>
<div class="figure"><span style="display:block;" id="fig:unnamed-chunk-95"></span>
<img src="Figs/06-metrics-global-flattening-ratio.png" alt="Different $\bar{G}$ can be possible for one G" width="100%" />
<p class="caption">
Figure 6.2: Different <span class="math inline">\(\bar{G}\)</span> can be possible for one G
</p>
</div>
<p>In the Figure 6.2 above, every node has degree <em>K</em> equals to 2. In the first network, <em>G1</em> = <span class="math inline">\(\bar{G1}\)</span> because the network <em>G1</em> is already spatially efficient (i.e., every node connects to its two nearest neighbors). In the second network, two <span class="math inline">\(\bar{G}\)</span> (<span class="math inline">\(\bar{G2.1}\)</span> and <span class="math inline">\(\bar{G2.2}\)</span>) are possible for <em>G2</em>. If we reroute the network <em>G2</em> in the node order of A -&gt; B -&gt; C -&gt; D, then we have <span class="math inline">\(\bar{G2.1}\)</span> because when it loops to node C or D, both A, B, and C have satisfied the degree constraints (<em>K</em>=2). The sum of distance for <span class="math inline">\(\bar{G2.1}\)</span> is <code>1+1+Sqrt(2)</code>. However, if the node order is A -&gt; D -&gt; B -&gt; C, then when it loops to B and C, all nodes have satisfied the degree constraints (<em>K</em>=2). The sum of distance for <span class="math inline">\(\bar{G2.2}\)</span> is <code>1+1+Sqrt(5)+Sqrt(5)</code>. Thus, the sum of distance for <span class="math inline">\(\bar{G2}\)</span> is the average sum of distance for <span class="math inline">\(\bar{G2.1}\)</span>, <span class="math inline">\(\bar{G2.2}\)</span>, etc. Our <code>GlobalFlatteningRatio()</code> function will allow users to select how many iterations (i.e., randomly generated order of nodes) they would like to use to calculate the average sum of distance.</p>
<p><strong>Local Flattening Ratio</strong> is a node-level metric, adapted from the <strong>Global Flattening Ratio</strong> definition. It is defined as the ratio of a node’s minimized distance (<em>d_opt</em>) needed to connect to any k nearest neighbors to the total actual distance (<em>d_act</em>) of its connections. Nodes with low values prioritize distant connections. This metric is similar to <strong>K-fullfillment</strong>, as both describe local (dis)connection.</p>
<p>Our implementation of the Global and Local Flattening Ratio in <code>SSNtools</code> assume that the network is undirected and unweighted. These two concepts can also be applied to <strong>bipartite networks</strong>. In bipartite networks, a node (in set 1)’s K nearest neighbors can only be nodes in set 0.</p>
<p>Here are some example research questions that can be answered by the <strong>Global/Local Flattening Ratio</strong> metric:</p>
<ul>
<li>(Global Flattening Ratio) Is the SSN spatially efficient? In another word, do nodes prefer to connect to their nearest neighbors or far friends?</li>
<li>(Local Flattening Ratio) Which SSN node tends to connect to their neighbors (or have the most spatially tight social connections)?</li>
</ul>
<p>Our tutorial will cover the following topics:</p>
<ul>
<li>How to calculate Global Flattening Ratio values on the node level using <code>GlobalFlatteningRatio()</code> in <code>SSNtools</code>.</li>
<li>How to calculate Local Flattening Ratio values on the node level using <code>LocalFlatteningRatio()</code> in <code>SSNtools</code>.</li>
<li>How to visualize Local Flattening Ratio values on the node level and connections to the nearest neighbors.</li>
</ul>
<p>We will continue to use sample dataset <strong>NYCMafiaNodes</strong>, <strong>NYCMafiaEdges</strong>, <strong>POINodes</strong>, and <strong>POIEdges</strong> in <code>SSNtools</code> to illustrate examples. To load the sample dataset and the functions, go to GitHub <a href="https://github.com/friendlycities-gatech/SSNtools">SSNtool</a> to download the development R package, or type the following lines in your R console. Click the GitHub page for more detailed description of all the functions available in the package and the input formats for each function.</p>
<div class="sourceCode" id="cb112"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb112-1"><a href="advanced-ssn-metrics.html#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;devtools&quot;)</span></span>
<span id="cb112-2"><a href="advanced-ssn-metrics.html#cb112-2" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;friendlycities-gatech/SSNtools&quot;</span>)</span></code></pre></div>
<p><strong>NYCMafiaNodes</strong> is a node table with label and spatial coordinates for each node (a mafia member). <strong>NYCMafiaeEdges</strong> contains pairs of node labels (corresponding to node table label), representing mafia criminal associations. This is a unweighted and undirected network. The coordinate system crs is 32118, in the unit of meters.</p>
<p>Data in <strong>POINodes</strong> and <strong>POIEdges</strong> are processed from SafeGraph with extra filters and coding to hide sensitive information. The dataset is meant to be educational and thus can be inaccurate for real implications. The nodes in the dataset are restaurants in Atlanta (set 0) and centroids of census block group (set 1). The edges in the dataset are visits from the census block group to restaurants. The weight of the edges represent the percentage of total visits coming from a particular census block group. You can call <strong>POINodes</strong> (n=1356) and <strong>POIEdges</strong> (n=7926) to directly access the sample dataset. The coordinates system is transformed with crs=26967 (unit meter).</p>
<div id="calculate-global-flattening-ratio" class="section level3" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> Calculate Global Flattening Ratio</h3>
<p>To get the Global Flattening Ratio for your network, you just need to run your node and edge dataframe through the following codes. Because the random generation of node orders can be different every time and across different machines, you are expected to get slightly different result than what is shown in the tutorial. <code>set.seed()</code> may help you get the exact same outcome. Here, our data have 298 nodes, so we try 100 different node orders to calculate the average values for <span class="math inline">\(\bar{G}\)</span>. You should scale your iterations based on the size of your network.</p>
<div class="sourceCode" id="cb113"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb113-1"><a href="advanced-ssn-metrics.html#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SSNtools)</span>
<span id="cb113-2"><a href="advanced-ssn-metrics.html#cb113-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-3"><a href="advanced-ssn-metrics.html#cb113-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(NYCMafiaNodes)</span>
<span id="cb113-4"><a href="advanced-ssn-metrics.html#cb113-4" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(NYCMafiaEdges)</span>
<span id="cb113-5"><a href="advanced-ssn-metrics.html#cb113-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-6"><a href="advanced-ssn-metrics.html#cb113-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ----process dataframe into a list of lists </span></span>
<span id="cb113-7"><a href="advanced-ssn-metrics.html#cb113-7" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb113-8"><a href="advanced-ssn-metrics.html#cb113-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     data - a R dataframe containing node label, longitude, and latitude</span></span>
<span id="cb113-9"><a href="advanced-ssn-metrics.html#cb113-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     label_name - the name of the column for node label</span></span>
<span id="cb113-10"><a href="advanced-ssn-metrics.html#cb113-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     lon_name - the name of the column for node longitude </span></span>
<span id="cb113-11"><a href="advanced-ssn-metrics.html#cb113-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     lat_name - the name of the column for node latitude</span></span>
<span id="cb113-12"><a href="advanced-ssn-metrics.html#cb113-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     bipartite_name - (optional) the name of the column that indicates the bipartite set of the nodes. The set of nodes that EdgeScan or NDScan should report on should be coded as 1 in the biparite column, and 0 otherwise.  </span></span>
<span id="cb113-13"><a href="advanced-ssn-metrics.html#cb113-13" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> <span class="fu">processNode</span>(NYCMafiaNodes, <span class="st">&#39;label&#39;</span>, <span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>)</span>
<span id="cb113-14"><a href="advanced-ssn-metrics.html#cb113-14" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb113-15"><a href="advanced-ssn-metrics.html#cb113-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     data - a R dataframe containing source node label and target node label</span></span>
<span id="cb113-16"><a href="advanced-ssn-metrics.html#cb113-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     source_name - the name of the column for source node label</span></span>
<span id="cb113-17"><a href="advanced-ssn-metrics.html#cb113-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     target_name - the name of the column for target node label</span></span>
<span id="cb113-18"><a href="advanced-ssn-metrics.html#cb113-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     weight_name - (optional) the name of the column for edge weight </span></span>
<span id="cb113-19"><a href="advanced-ssn-metrics.html#cb113-19" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> <span class="fu">processEdge</span>(NYCMafiaEdges, <span class="st">&#39;Source&#39;</span>, <span class="st">&#39;Target&#39;</span>)</span>
<span id="cb113-20"><a href="advanced-ssn-metrics.html#cb113-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-21"><a href="advanced-ssn-metrics.html#cb113-21" aria-hidden="true" tabindex="-1"></a><span class="co"># run both lines to get consistent GlobalFlatteningRatio results</span></span>
<span id="cb113-22"><a href="advanced-ssn-metrics.html#cb113-22" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>, <span class="st">&quot;Mersenne-Twister&quot;</span>, <span class="at">sample.kind=</span><span class="st">&quot;Rounding&quot;</span>)</span>
<span id="cb113-23"><a href="advanced-ssn-metrics.html#cb113-23" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb113-24"><a href="advanced-ssn-metrics.html#cb113-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     nodes - a list of named list; each sublist is a node </span></span>
<span id="cb113-25"><a href="advanced-ssn-metrics.html#cb113-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     edges - a list of named list; each sublist is an edge</span></span>
<span id="cb113-26"><a href="advanced-ssn-metrics.html#cb113-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     iter - the number of iterations for node orders </span></span>
<span id="cb113-27"><a href="advanced-ssn-metrics.html#cb113-27" aria-hidden="true" tabindex="-1"></a><span class="fu">GlobalFlatteningRatio</span>(nodes, edges, <span class="dv">100</span>)</span></code></pre></div>
<pre><code>## [1] 0.1940646</code></pre>
<p><strong>Interpret Outputs</strong></p>
<p><strong>Global Flattening Ratio</strong> reports <strong>0.1940646</strong> for our mafia network, which means that the mafia network is not very spatially tight. In another word, mafia members prefer far friends rather than connections to nearest neighbors. This result makes sense because mafia members are likely to connect to other mafia members in the same families and these members spread out in geographic space.</p>
</div>
<div id="calculate-local-flattening-ratio" class="section level3" number="6.3.2">
<h3><span class="header-section-number">6.3.2</span> Calculate Local Flattening Ratio</h3>
<p>To get Local Flattening Ratio value for each node, you just need to run your node and edge dataframe through the following codes:</p>
<div class="sourceCode" id="cb115"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb115-1"><a href="advanced-ssn-metrics.html#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SSNtools)</span>
<span id="cb115-2"><a href="advanced-ssn-metrics.html#cb115-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-3"><a href="advanced-ssn-metrics.html#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(NYCMafiaNodes)</span>
<span id="cb115-4"><a href="advanced-ssn-metrics.html#cb115-4" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(NYCMafiaEdges)</span>
<span id="cb115-5"><a href="advanced-ssn-metrics.html#cb115-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-6"><a href="advanced-ssn-metrics.html#cb115-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ----process dataframe into a list of lists </span></span>
<span id="cb115-7"><a href="advanced-ssn-metrics.html#cb115-7" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb115-8"><a href="advanced-ssn-metrics.html#cb115-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     data - a R dataframe containing node label, longitude, and latitude</span></span>
<span id="cb115-9"><a href="advanced-ssn-metrics.html#cb115-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     label_name - the name of the column for node label</span></span>
<span id="cb115-10"><a href="advanced-ssn-metrics.html#cb115-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     lon_name - the name of the column for node longitude </span></span>
<span id="cb115-11"><a href="advanced-ssn-metrics.html#cb115-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     lat_name - the name of the column for node latitude</span></span>
<span id="cb115-12"><a href="advanced-ssn-metrics.html#cb115-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     bipartite_name - (optional) the name of the column that indicates the bipartite set of the nodes. The set of nodes that EdgeScan or NDScan should report on should be coded as 1 in the biparite column, and 0 otherwise.  </span></span>
<span id="cb115-13"><a href="advanced-ssn-metrics.html#cb115-13" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> <span class="fu">processNode</span>(NYCMafiaNodes, <span class="st">&#39;label&#39;</span>, <span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>)</span>
<span id="cb115-14"><a href="advanced-ssn-metrics.html#cb115-14" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb115-15"><a href="advanced-ssn-metrics.html#cb115-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     data - a R dataframe containing source node label and target node label</span></span>
<span id="cb115-16"><a href="advanced-ssn-metrics.html#cb115-16" aria-hidden="true" tabindex="-1"></a><span class="co">#     source_name - the name of the column for source node label</span></span>
<span id="cb115-17"><a href="advanced-ssn-metrics.html#cb115-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     target_name - the name of the column for target node label</span></span>
<span id="cb115-18"><a href="advanced-ssn-metrics.html#cb115-18" aria-hidden="true" tabindex="-1"></a><span class="co">#     weight_name - (optional) the name of the column for edge weight </span></span>
<span id="cb115-19"><a href="advanced-ssn-metrics.html#cb115-19" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> <span class="fu">processEdge</span>(NYCMafiaEdges, <span class="st">&#39;Source&#39;</span>, <span class="st">&#39;Target&#39;</span>)</span>
<span id="cb115-20"><a href="advanced-ssn-metrics.html#cb115-20" aria-hidden="true" tabindex="-1"></a><span class="co"># params:</span></span>
<span id="cb115-21"><a href="advanced-ssn-metrics.html#cb115-21" aria-hidden="true" tabindex="-1"></a><span class="co">#     nodes - a list of named lists. Each sublist contains a node.</span></span>
<span id="cb115-22"><a href="advanced-ssn-metrics.html#cb115-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     edges - a list of list. Each sublist contains an edge.</span></span>
<span id="cb115-23"><a href="advanced-ssn-metrics.html#cb115-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     minK - (optional) minimum K (degree) for a node to have Local_flattening_ratio value. Default to minK = 1.</span></span>
<span id="cb115-24"><a href="advanced-ssn-metrics.html#cb115-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     bipartite - (optional) whether the Local_flattening_ratio will only be reported for nodes whose bipartite column is coded as 1. Default to FALSE.</span></span>
<span id="cb115-25"><a href="advanced-ssn-metrics.html#cb115-25" aria-hidden="true" tabindex="-1"></a><span class="co"># return:</span></span>
<span id="cb115-26"><a href="advanced-ssn-metrics.html#cb115-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     list(nodelist, edgelist) - a list of two dataframe for node and edge table. </span></span>
<span id="cb115-27"><a href="advanced-ssn-metrics.html#cb115-27" aria-hidden="true" tabindex="-1"></a>results <span class="ot">=</span> <span class="fu">LocalFlatteningRatio</span>(nodes, edges) </span>
<span id="cb115-28"><a href="advanced-ssn-metrics.html#cb115-28" aria-hidden="true" tabindex="-1"></a>nodelist <span class="ot">=</span> results[[<span class="dv">1</span>]]</span>
<span id="cb115-29"><a href="advanced-ssn-metrics.html#cb115-29" aria-hidden="true" tabindex="-1"></a>edgelist <span class="ot">=</span> results[[<span class="dv">2</span>]]</span>
<span id="cb115-30"><a href="advanced-ssn-metrics.html#cb115-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-31"><a href="advanced-ssn-metrics.html#cb115-31" aria-hidden="true" tabindex="-1"></a>nodelist[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>), ]</span></code></pre></div>
<pre><code>##               label  K Local_flattening_ratio
## 1 AMAROSA-ALEXANDER  3             0.81895190
## 2   VINTALORO-JAMES  6             0.07881283
## 3   TANTILLO-ENRICO 12             0.12986306</code></pre>
<div class="sourceCode" id="cb117"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb117-1"><a href="advanced-ssn-metrics.html#cb117-1" aria-hidden="true" tabindex="-1"></a>edgelist[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>), ]</span></code></pre></div>
<pre><code>##            Source         Target is_K_nearest_neighbor
## 1 SALERNO-ANTHONY ALBERO-CHARLES                     0
## 2    CARUSO-FRANK  NOBILE-GEORGE                     0
## 3    LISI-GAETANO     MARI-FRANK                     1</code></pre>
<p><strong>Interpret Outputs</strong></p>
<p><code>LocalFlatteningRatio()</code> will return a list of two dataframes. The first dataframe is a node dataframe wtih three columns:</p>
<ul>
<li><code>label</code>: the node label</li>
<li><code>K</code>: the node’s degree K, which is the same K for the node’s K-nearest neighbors.<br />
</li>
<li><code>Local_flattening_ratio</code>: the ratio of the sum of Euclidean distance between a node and its K-nearest neighbors (K is the node’s degree) versus the sum of Euclidean distance between a node and all other nodes it connects to. The value is ranged between 0 and 1.</li>
</ul>
<p>The second dataframe is an edge dataframe that has three columns:</p>
<ul>
<li><code>Source</code>: source node label</li>
<li><code>Target</code>: target node label</li>
<li><code>is_K_nearest_neighbor</code>: binary value (1 or 0) indicating whether the edge represented a connection that is also within the source or target node’s K-nearest neighbors.</li>
</ul>
</div>
<div id="visualize-local-flattening-ratio" class="section level3" number="6.3.3">
<h3><span class="header-section-number">6.3.3</span> Visualize Local Flattening Ratio</h3>
<p>To visualize <strong>Local Flattening Ratio</strong> values on the node level, you can use the following codes as a reference.</p>
<div class="sourceCode" id="cb119"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb119-1"><a href="advanced-ssn-metrics.html#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="co"># packages for wrangling data and map visualization</span></span>
<span id="cb119-2"><a href="advanced-ssn-metrics.html#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb119-3"><a href="advanced-ssn-metrics.html#cb119-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb119-4"><a href="advanced-ssn-metrics.html#cb119-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb119-5"><a href="advanced-ssn-metrics.html#cb119-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stplanr)</span>
<span id="cb119-6"><a href="advanced-ssn-metrics.html#cb119-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(basemaps)</span>
<span id="cb119-7"><a href="advanced-ssn-metrics.html#cb119-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-8"><a href="advanced-ssn-metrics.html#cb119-8" aria-hidden="true" tabindex="-1"></a><span class="co"># convert heat dataframe to a spatial sf object</span></span>
<span id="cb119-9"><a href="advanced-ssn-metrics.html#cb119-9" aria-hidden="true" tabindex="-1"></a>MafiaSpatial <span class="ot">=</span> nodelist <span class="sc">%&gt;%</span> </span>
<span id="cb119-10"><a href="advanced-ssn-metrics.html#cb119-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(NYCMafiaNodes, <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;label&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>), <span class="at">crs=</span><span class="dv">32118</span>)</span>
<span id="cb119-11"><a href="advanced-ssn-metrics.html#cb119-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-12"><a href="advanced-ssn-metrics.html#cb119-12" aria-hidden="true" tabindex="-1"></a><span class="co"># convert edgelist dataframe to line geometry</span></span>
<span id="cb119-13"><a href="advanced-ssn-metrics.html#cb119-13" aria-hidden="true" tabindex="-1"></a>NYCMafiaEdges_shp <span class="ot">=</span> <span class="fu">od2line</span>(edgelist, MafiaSpatial) </span>
<span id="cb119-14"><a href="advanced-ssn-metrics.html#cb119-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-15"><a href="advanced-ssn-metrics.html#cb119-15" aria-hidden="true" tabindex="-1"></a><span class="co"># create basemap with functions from basemaps library</span></span>
<span id="cb119-16"><a href="advanced-ssn-metrics.html#cb119-16" aria-hidden="true" tabindex="-1"></a><span class="fu">set_defaults</span>(<span class="at">map_service =</span> <span class="st">&quot;carto&quot;</span>, <span class="at">map_type =</span> <span class="st">&quot;light&quot;</span>)</span>
<span id="cb119-17"><a href="advanced-ssn-metrics.html#cb119-17" aria-hidden="true" tabindex="-1"></a>bgbox <span class="ot">=</span> <span class="fu">st_bbox</span>(MafiaSpatial) <span class="sc">%&gt;%</span> <span class="fu">st_as_sfc</span>()</span>
<span id="cb119-18"><a href="advanced-ssn-metrics.html#cb119-18" aria-hidden="true" tabindex="-1"></a>bg <span class="ot">=</span> <span class="fu">basemap_stars</span>(bgbox)</span></code></pre></div>
<pre><code>## Loading basemap &#39;light&#39; from map service &#39;carto&#39;...</code></pre>
<div class="sourceCode" id="cb121"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb121-1"><a href="advanced-ssn-metrics.html#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb121-2"><a href="advanced-ssn-metrics.html#cb121-2" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> </span>
<span id="cb121-3"><a href="advanced-ssn-metrics.html#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map base map</span></span>
<span id="cb121-4"><a href="advanced-ssn-metrics.html#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(bg) <span class="sc">+</span></span>
<span id="cb121-5"><a href="advanced-ssn-metrics.html#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_rgb</span>(<span class="at">alpha=</span><span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb121-6"><a href="advanced-ssn-metrics.html#cb121-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map all edges in grey</span></span>
<span id="cb121-7"><a href="advanced-ssn-metrics.html#cb121-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(NYCMafiaEdges_shp) <span class="sc">+</span> </span>
<span id="cb121-8"><a href="advanced-ssn-metrics.html#cb121-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">alpha=</span><span class="fl">0.5</span>, <span class="at">col=</span><span class="st">&#39;grey&#39;</span>) <span class="sc">+</span> </span>
<span id="cb121-9"><a href="advanced-ssn-metrics.html#cb121-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map edges that also connect to K-nearest neighbors in black </span></span>
<span id="cb121-10"><a href="advanced-ssn-metrics.html#cb121-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(NYCMafiaEdges_shp <span class="sc">%&gt;%</span> <span class="fu">filter</span>(is_K_nearest_neighbor <span class="sc">==</span> <span class="dv">1</span>)) <span class="sc">+</span> </span>
<span id="cb121-11"><a href="advanced-ssn-metrics.html#cb121-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">alpha=</span><span class="fl">0.5</span>, <span class="at">col=</span><span class="st">&#39;black&#39;</span>) <span class="sc">+</span> </span>
<span id="cb121-12"><a href="advanced-ssn-metrics.html#cb121-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map nodes colored by Local_flattening_ratio. Nodes with higher Local_flattening_ratio values mapped last. </span></span>
<span id="cb121-13"><a href="advanced-ssn-metrics.html#cb121-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(MafiaSpatial <span class="sc">%&gt;%</span> <span class="fu">arrange</span>(Local_flattening_ratio)) <span class="sc">+</span> </span>
<span id="cb121-14"><a href="advanced-ssn-metrics.html#cb121-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_symbols</span>(<span class="at">col=</span><span class="st">&#39;Local_flattening_ratio&#39;</span>, <span class="at">size=</span><span class="fl">0.1</span>, <span class="at">style=</span><span class="st">&#39;fixed&#39;</span>, </span>
<span id="cb121-15"><a href="advanced-ssn-metrics.html#cb121-15" aria-hidden="true" tabindex="-1"></a>             <span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.15</span>, <span class="dv">1</span>),</span>
<span id="cb121-16"><a href="advanced-ssn-metrics.html#cb121-16" aria-hidden="true" tabindex="-1"></a>             <span class="at">palette =</span> <span class="fu">c</span>(<span class="st">&#39;#FBD977&#39;</span>, <span class="st">&#39;#F78D3D&#39;</span>, <span class="st">&#39;#E3211B&#39;</span>, <span class="st">&#39;#800F26&#39;</span>),</span>
<span id="cb121-17"><a href="advanced-ssn-metrics.html#cb121-17" aria-hidden="true" tabindex="-1"></a>             <span class="at">legend.col.show =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb121-18"><a href="advanced-ssn-metrics.html#cb121-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">#customize legend and layout</span></span>
<span id="cb121-19"><a href="advanced-ssn-metrics.html#cb121-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_add_legend</span>(<span class="at">type=</span><span class="st">&#39;symbol&#39;</span>, </span>
<span id="cb121-20"><a href="advanced-ssn-metrics.html#cb121-20" aria-hidden="true" tabindex="-1"></a>                <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&#39;(0, 0.05]&#39;</span>, <span class="st">&#39;(0.05, 0.10]&#39;</span>, <span class="st">&#39;(0.10, 0.15]&#39;</span>, <span class="st">&#39;(0.15, 1]&#39;</span>, <span class="st">&#39;NA (Less than minK)&#39;</span>), </span>
<span id="cb121-21"><a href="advanced-ssn-metrics.html#cb121-21" aria-hidden="true" tabindex="-1"></a>                <span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;#FBD977&#39;</span>, <span class="st">&#39;#F78D3D&#39;</span>, <span class="st">&#39;#E3211B&#39;</span>, <span class="st">&#39;#800F26&#39;</span>, <span class="st">&#39;grey&#39;</span>), </span>
<span id="cb121-22"><a href="advanced-ssn-metrics.html#cb121-22" aria-hidden="true" tabindex="-1"></a>                <span class="at">is.portrait =</span> T, <span class="at">title=</span><span class="fu">c</span>(<span class="st">&#39;Local Flattening Ratio&#39;</span>), <span class="at">size=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb121-23"><a href="advanced-ssn-metrics.html#cb121-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_add_legend</span>(<span class="at">type=</span><span class="st">&#39;line&#39;</span>, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&#39;Edges also Connect to KNN&#39;</span>, <span class="st">&#39;All Edges&#39;</span>), </span>
<span id="cb121-24"><a href="advanced-ssn-metrics.html#cb121-24" aria-hidden="true" tabindex="-1"></a>                <span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;black&#39;</span>, <span class="st">&#39;grey&#39;</span>), <span class="at">lwd=</span><span class="dv">1</span>) <span class="sc">+</span> </span>
<span id="cb121-25"><a href="advanced-ssn-metrics.html#cb121-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_scale_bar</span>(<span class="at">breaks=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="dv">10</span>), <span class="at">text.size =</span> <span class="fl">0.7</span>, <span class="at">position=</span><span class="fu">c</span>(<span class="fl">0.78</span>,<span class="fl">0.9</span>)) <span class="sc">+</span>  </span>
<span id="cb121-26"><a href="advanced-ssn-metrics.html#cb121-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.title.size =</span> <span class="fl">0.9</span>, <span class="at">legend.text.size =</span> <span class="fl">0.7</span>, <span class="at">legend.width =</span> <span class="dv">1</span>,</span>
<span id="cb121-27"><a href="advanced-ssn-metrics.html#cb121-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title =</span> <span class="st">&#39;NYC Mafia SSN Local Flattening Ratio&#39;</span>,</span>
<span id="cb121-28"><a href="advanced-ssn-metrics.html#cb121-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title.position =</span> <span class="fu">c</span>(<span class="st">&#39;center&#39;</span>),</span>
<span id="cb121-29"><a href="advanced-ssn-metrics.html#cb121-29" aria-hidden="true" tabindex="-1"></a>            <span class="at">main.title.size =</span> <span class="fl">1.2</span>)</span>
<span id="cb121-30"><a href="advanced-ssn-metrics.html#cb121-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-31"><a href="advanced-ssn-metrics.html#cb121-31" aria-hidden="true" tabindex="-1"></a>g</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-99-1.png" width="672" /></p>
</div>
<div id="application-to-a-bipartite-network-1" class="section level3" number="6.3.4">
<h3><span class="header-section-number">6.3.4</span> Application to a bipartite network</h3>
<p>To calculate <strong>Local Flattening Ratio</strong> values on the node level for a bipartite network, you can use the following codes as a reference. Note that only nodes whose <code>Bipartite</code> column is equal to 1 (in this case, POIs) will have Local Flattening Ratio values.</p>
<div class="sourceCode" id="cb122"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb122-1"><a href="advanced-ssn-metrics.html#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SSNtools)</span>
<span id="cb122-2"><a href="advanced-ssn-metrics.html#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(POINodes)</span>
<span id="cb122-3"><a href="advanced-ssn-metrics.html#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(POIEdges)</span>
<span id="cb122-4"><a href="advanced-ssn-metrics.html#cb122-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-5"><a href="advanced-ssn-metrics.html#cb122-5" aria-hidden="true" tabindex="-1"></a><span class="co"># show example outputs in the sample data</span></span>
<span id="cb122-6"><a href="advanced-ssn-metrics.html#cb122-6" aria-hidden="true" tabindex="-1"></a>POINodes[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">1046</span>),]</span>
<span id="cb122-7"><a href="advanced-ssn-metrics.html#cb122-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-8"><a href="advanced-ssn-metrics.html#cb122-8" aria-hidden="true" tabindex="-1"></a><span class="co">#             label Bipartite     LonX     LatY</span></span>
<span id="cb122-9"><a href="advanced-ssn-metrics.html#cb122-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 1            poi1         1 682812.1 418009.0</span></span>
<span id="cb122-10"><a href="advanced-ssn-metrics.html#cb122-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2            poi2         1 681756.2 417956.0</span></span>
<span id="cb122-11"><a href="advanced-ssn-metrics.html#cb122-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 1046 131210016001         0 682506.8 417742.6</span></span>
<span id="cb122-12"><a href="advanced-ssn-metrics.html#cb122-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-13"><a href="advanced-ssn-metrics.html#cb122-13" aria-hidden="true" tabindex="-1"></a>POIEdges[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span>
<span id="cb122-14"><a href="advanced-ssn-metrics.html#cb122-14" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb122-15"><a href="advanced-ssn-metrics.html#cb122-15" aria-hidden="true" tabindex="-1"></a><span class="co">#   Source       Target    Weight</span></span>
<span id="cb122-16"><a href="advanced-ssn-metrics.html#cb122-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 1   poi1 130890204001 14.545455</span></span>
<span id="cb122-17"><a href="advanced-ssn-metrics.html#cb122-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 2   poi1 130890205002  7.272727</span></span>
<span id="cb122-18"><a href="advanced-ssn-metrics.html#cb122-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 3   poi1 131210001002  7.272727</span></span>
<span id="cb122-19"><a href="advanced-ssn-metrics.html#cb122-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-20"><a href="advanced-ssn-metrics.html#cb122-20" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> <span class="fu">processNode</span>(POINodes, <span class="st">&#39;label&#39;</span>, <span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>, <span class="st">&#39;Bipartite&#39;</span>)</span>
<span id="cb122-21"><a href="advanced-ssn-metrics.html#cb122-21" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> <span class="fu">processEdge</span>(POIEdges, <span class="st">&#39;Source&#39;</span>, <span class="st">&#39;Target&#39;</span>, <span class="st">&#39;Weight&#39;</span>)</span>
<span id="cb122-22"><a href="advanced-ssn-metrics.html#cb122-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-23"><a href="advanced-ssn-metrics.html#cb122-23" aria-hidden="true" tabindex="-1"></a>results <span class="ot">=</span> <span class="fu">LocalFlatteningRatio</span>(nodes, edges, <span class="at">minK=</span><span class="dv">1</span>, <span class="at">bipartite=</span><span class="cn">TRUE</span>)</span>
<span id="cb122-24"><a href="advanced-ssn-metrics.html#cb122-24" aria-hidden="true" tabindex="-1"></a>nodelist <span class="ot">=</span> results[[<span class="dv">1</span>]]</span>
<span id="cb122-25"><a href="advanced-ssn-metrics.html#cb122-25" aria-hidden="true" tabindex="-1"></a>edgelist <span class="ot">=</span> results[[<span class="dv">2</span>]]</span>
<span id="cb122-26"><a href="advanced-ssn-metrics.html#cb122-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-27"><a href="advanced-ssn-metrics.html#cb122-27" aria-hidden="true" tabindex="-1"></a>nodelist[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span>
<span id="cb122-28"><a href="advanced-ssn-metrics.html#cb122-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-29"><a href="advanced-ssn-metrics.html#cb122-29" aria-hidden="true" tabindex="-1"></a><span class="co">#   label  K Local_flattening_ratio</span></span>
<span id="cb122-30"><a href="advanced-ssn-metrics.html#cb122-30" aria-hidden="true" tabindex="-1"></a><span class="co"># 1  poi1 11              0.2400992</span></span>
<span id="cb122-31"><a href="advanced-ssn-metrics.html#cb122-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 2  poi2 15              0.3255136</span></span>
<span id="cb122-32"><a href="advanced-ssn-metrics.html#cb122-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 3  poi3  7              0.3924708</span></span>
<span id="cb122-33"><a href="advanced-ssn-metrics.html#cb122-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-34"><a href="advanced-ssn-metrics.html#cb122-34" aria-hidden="true" tabindex="-1"></a>edgelist[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span>
<span id="cb122-35"><a href="advanced-ssn-metrics.html#cb122-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-36"><a href="advanced-ssn-metrics.html#cb122-36" aria-hidden="true" tabindex="-1"></a><span class="co">#   Source       Target is_K_nearest_neighbor</span></span>
<span id="cb122-37"><a href="advanced-ssn-metrics.html#cb122-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 1   poi1 130890204001                     1</span></span>
<span id="cb122-38"><a href="advanced-ssn-metrics.html#cb122-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 2   poi1 130890205002                     0</span></span>
<span id="cb122-39"><a href="advanced-ssn-metrics.html#cb122-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 3   poi1 131210001002                     0</span></span></code></pre></div>
</div>
</div>
<div id="linked-activity-spaces" class="section level2" number="6.4">
<h2><span class="header-section-number">6.4</span> Linked Activity Spaces</h2>
<p><strong>Linked Activity Spaces</strong> is a concept introduced in paper <a href="https://pennstate.pure.elsevier.com/en/publications/linked-activity-spaces-embedding-social-networks-in-urban-space">Linked Activity Spaces: Embedding Social Networks in Urban Space (Wang et al., 2015)</a> to measure to what extent nodes connected also overlap in their associated locations. This concept applies to networks where the nodes represent <strong>egos</strong> (e.g., individuals; also called <strong>primary nodes</strong>) and the locations associated with egos (e.g., places the individuals have visited), while the edges represent connections between egos and their <strong>alters</strong> (e.g., friends; also called <strong>linked nodes</strong>). In <a href="https://pennstate.pure.elsevier.com/en/publications/linked-activity-spaces-embedding-social-networks-in-urban-space">Wang et al., 2015</a>, an ego is a cell phone user, alters are users who have phone calls with this user, and the locations associated with the users are POIs that the users have visited.</p>
<p>An <strong>Activity Space</strong> refers to the areas captured by the standard deviation ellipse given an ego’s associated locations. Thus, <strong>Linked Activity Spaces</strong> refers to a pair of activity spaces of an ego and its alters. We quantify the overlaps between linked activity spaces using the number of locations (e.g., POIs) found in the intersections of activity spaces, as defined in <a href="https://pennstate.pure.elsevier.com/en/publications/linked-activity-spaces-embedding-social-networks-in-urban-space">Wang et al., 2015</a>.</p>
<p>Here are some example research questions that can be answered by the <strong>Linked Activity Spaces</strong> visualization and metric:</p>
<ul>
<li>Do egos visit the same set of places as its alters?</li>
<li>Which alter (given an ego) has activity space overlapping the most with the ego?</li>
</ul>
<p>Our tutorial will cover the following topics:</p>
<ul>
<li>How to visualize a selected ego’s and its alters’ activity spaces (i.e., two ellipses), using <code>ggplot2</code></li>
<li>How to visualize a selected ego’s activity space and each of its alters’ activity spaces (i.e., linked activity spaces), using <code>ggplot2</code></li>
<li>How to quantify the overlap between a ego and its alters’ activity spaces (i.e., number of nodes in both ellipses)</li>
<li>How to quantify the overlap between a ego and each of its alters’ activity spaces (i.e., number of nodes in each pair of ellipses)</li>
</ul>
<p>We will use a new sample dataset <strong>EmergencyNodes</strong> and <strong>EmergencyEdges</strong> in <code>SSNtools</code> to illustrate examples. To load the sample dataset and the functions, go to GitHub <a href="https://github.com/friendlycities-gatech/SSNtools">SSNtool</a> to download the development R package, or type the following lines in your R console. Click the GitHub page for more detailed description of all the functions available in the package and the input formats for each function.</p>
<div class="sourceCode" id="cb123"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb123-1"><a href="advanced-ssn-metrics.html#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages(&quot;devtools&quot;)</span></span>
<span id="cb123-2"><a href="advanced-ssn-metrics.html#cb123-2" aria-hidden="true" tabindex="-1"></a>devtools<span class="sc">::</span><span class="fu">install_github</span>(<span class="st">&quot;friendlycities-gatech/SSNtools&quot;</span>)</span></code></pre></div>
<p>A row in <strong>EmergencyNodes</strong> (n=1582) represents a New York City emergency responder (label) and locations where the responder have been dispatched (LonX, LatY). The coordinate system is in crs = 4326. A row in <strong>EmergencyEdges</strong> (n=47) represents two responders (Source, Target) who had been paired in a dispatch. Note that one responder can be dispatched multiple times and thus be associated with multiple locations in <strong>EmergencyNodes</strong>, while <strong>EmergencyEdges</strong> only documents the pairing once as long as the two repsonders have been paired up before. The network is unweighted and undirected. As such, linked activity spaces method can help examine the efficiency of emergency management, such as whether respondents who are often paired together also tend to go to the same emergency locations.</p>
<div id="visualize-linked-activity-spaces" class="section level3" number="6.4.1">
<h3><span class="header-section-number">6.4.1</span> Visualize Linked Activity Spaces</h3>
<p>The sample dataset contains data for two egos (primary nodes; labeled as <strong>P1</strong> and <strong>P2</strong>) and their associated alters (linked nodes). We would like to focus on one primary node, <strong>P1</strong>, to demonstrate the method. The additional primary node (P2) is included in the sample dataset as an extra example for exploration. We would like to thank Sambhavi Joshi for contributing to the codes below.</p>
<p>We first filter <strong>EmergencyNodes</strong> and <strong>EmergencyEdges</strong> to data that are relevant to <strong>P1</strong> and take a look at the data. Then we use <code>ggplot2()</code> to visualize locations associated with <strong>P1</strong>, the primary node, and its linked nodes. Note that <code>basemap_gglayer()</code> defaults the input data has crs 3857, so we have to convert our data from crs 4326 to 3857.</p>
<div class="sourceCode" id="cb124"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb124-1"><a href="advanced-ssn-metrics.html#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(SSNtools)</span>
<span id="cb124-2"><a href="advanced-ssn-metrics.html#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb124-3"><a href="advanced-ssn-metrics.html#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(basemaps)</span>
<span id="cb124-4"><a href="advanced-ssn-metrics.html#cb124-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb124-5"><a href="advanced-ssn-metrics.html#cb124-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb124-6"><a href="advanced-ssn-metrics.html#cb124-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-7"><a href="advanced-ssn-metrics.html#cb124-7" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(EmergencyNodes)</span>
<span id="cb124-8"><a href="advanced-ssn-metrics.html#cb124-8" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(EmergencyEdges)</span>
<span id="cb124-9"><a href="advanced-ssn-metrics.html#cb124-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-10"><a href="advanced-ssn-metrics.html#cb124-10" aria-hidden="true" tabindex="-1"></a><span class="co"># filter edges that contain the ego</span></span>
<span id="cb124-11"><a href="advanced-ssn-metrics.html#cb124-11" aria-hidden="true" tabindex="-1"></a>ego_label <span class="ot">=</span> <span class="st">&#39;P1&#39;</span></span>
<span id="cb124-12"><a href="advanced-ssn-metrics.html#cb124-12" aria-hidden="true" tabindex="-1"></a>ego_alters_pairs <span class="ot">=</span> EmergencyEdges <span class="sc">%&gt;%</span> <span class="fu">filter</span>(Source <span class="sc">==</span> ego_label <span class="sc">|</span> Target <span class="sc">==</span> ego_label)</span>
<span id="cb124-13"><a href="advanced-ssn-metrics.html#cb124-13" aria-hidden="true" tabindex="-1"></a>ego_alters_pairs[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>),]</span></code></pre></div>
<pre><code>##   Source Target
## 1     P1    P30
## 2     P1    P26
## 3    P23     P1</code></pre>
<div class="sourceCode" id="cb126"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb126-1"><a href="advanced-ssn-metrics.html#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># filter emergency locations associated with ego and its alters in node list  </span></span>
<span id="cb126-2"><a href="advanced-ssn-metrics.html#cb126-2" aria-hidden="true" tabindex="-1"></a>ego_alters_locations <span class="ot">=</span> EmergencyNodes <span class="sc">%&gt;%</span> </span>
<span id="cb126-3"><a href="advanced-ssn-metrics.html#cb126-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(label <span class="sc">%in%</span> ego_alters_pairs<span class="sc">$</span>Source <span class="sc">|</span> label <span class="sc">%in%</span> ego_alters_pairs<span class="sc">$</span>Target) <span class="sc">%&gt;%</span> </span>
<span id="cb126-4"><a href="advanced-ssn-metrics.html#cb126-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">role =</span> <span class="fu">ifelse</span>(label <span class="sc">==</span> ego_label, <span class="st">&#39;Primary Node&#39;</span>, <span class="st">&#39;Linked Node&#39;</span>))</span>
<span id="cb126-5"><a href="advanced-ssn-metrics.html#cb126-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-6"><a href="advanced-ssn-metrics.html#cb126-6" aria-hidden="true" tabindex="-1"></a>ego_alters_locations[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">46</span>),]</span></code></pre></div>
<pre><code>##    label      LonX     LatY         role
## 1     P1 -73.92782 40.76762 Primary Node
## 2     P1 -73.92457 40.76927 Primary Node
## 46    P3 -73.92782 40.76762  Linked Node</code></pre>
<div class="sourceCode" id="cb128"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb128-1"><a href="advanced-ssn-metrics.html#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize locations visited by the primary nodes and linked nodes; </span></span>
<span id="cb128-2"><a href="advanced-ssn-metrics.html#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="co"># basemap_gglayer assumes data comes in with crs=3857, so transform the coordinates from crs 4326 to 3857</span></span>
<span id="cb128-3"><a href="advanced-ssn-metrics.html#cb128-3" aria-hidden="true" tabindex="-1"></a>ego_alters_locations <span class="ot">=</span> ego_alters_locations <span class="sc">%&gt;%</span> </span>
<span id="cb128-4"><a href="advanced-ssn-metrics.html#cb128-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>), <span class="at">crs=</span><span class="dv">4326</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb128-5"><a href="advanced-ssn-metrics.html#cb128-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="at">crs=</span><span class="dv">3857</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb128-6"><a href="advanced-ssn-metrics.html#cb128-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">LonX =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">1</span>],</span>
<span id="cb128-7"><a href="advanced-ssn-metrics.html#cb128-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">LatY =</span> sf<span class="sc">::</span><span class="fu">st_coordinates</span>(.)[,<span class="dv">2</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb128-8"><a href="advanced-ssn-metrics.html#cb128-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">role =</span> <span class="fu">factor</span>(role, <span class="at">levels=</span><span class="fu">c</span>(<span class="st">&#39;Primary Node&#39;</span>, <span class="st">&#39;Linked Node&#39;</span>)))</span>
<span id="cb128-9"><a href="advanced-ssn-metrics.html#cb128-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-10"><a href="advanced-ssn-metrics.html#cb128-10" aria-hidden="true" tabindex="-1"></a><span class="co"># create basemap </span></span>
<span id="cb128-11"><a href="advanced-ssn-metrics.html#cb128-11" aria-hidden="true" tabindex="-1"></a><span class="fu">set_defaults</span>(<span class="at">map_service =</span> <span class="st">&quot;carto&quot;</span>, <span class="at">map_type =</span> <span class="st">&quot;light&quot;</span>)</span>
<span id="cb128-12"><a href="advanced-ssn-metrics.html#cb128-12" aria-hidden="true" tabindex="-1"></a>bgbox <span class="ot">=</span> <span class="fu">st_bbox</span>(ego_alters_locations <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>(<span class="at">coords=</span><span class="fu">c</span>(<span class="st">&#39;LonX&#39;</span>, <span class="st">&#39;LatY&#39;</span>), <span class="at">crs=</span><span class="dv">3857</span>)) <span class="sc">%&gt;%</span> <span class="fu">st_as_sfc</span>()</span>
<span id="cb128-13"><a href="advanced-ssn-metrics.html#cb128-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-14"><a href="advanced-ssn-metrics.html#cb128-14" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">=</span> </span>
<span id="cb128-15"><a href="advanced-ssn-metrics.html#cb128-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map basemap </span></span>
<span id="cb128-16"><a href="advanced-ssn-metrics.html#cb128-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb128-17"><a href="advanced-ssn-metrics.html#cb128-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">basemap_gglayer</span>(bgbox) <span class="sc">+</span> </span>
<span id="cb128-18"><a href="advanced-ssn-metrics.html#cb128-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_identity</span>() <span class="sc">+</span></span>
<span id="cb128-19"><a href="advanced-ssn-metrics.html#cb128-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map locations associated with both the primary node and linked nodes. </span></span>
<span id="cb128-20"><a href="advanced-ssn-metrics.html#cb128-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> ego_alters_locations, </span>
<span id="cb128-21"><a href="advanced-ssn-metrics.html#cb128-21" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span>LonX, <span class="at">y=</span>LatY, <span class="at">color=</span>role, <span class="at">size=</span>role)) <span class="sc">+</span></span>
<span id="cb128-22"><a href="advanced-ssn-metrics.html#cb128-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># customize aesthetics and the layout</span></span>
<span id="cb128-23"><a href="advanced-ssn-metrics.html#cb128-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Primary Node</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">5</span>, <span class="st">`</span><span class="at">Linked Node</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">2</span>), <span class="at">name=</span><span class="st">&#39;Emergency Locations Visited by&#39;</span>) <span class="sc">+</span></span>
<span id="cb128-24"><a href="advanced-ssn-metrics.html#cb128-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Primary Node</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;darkred&#39;</span>, <span class="st">`</span><span class="at">Linked Node</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;orange&#39;</span>), <span class="at">name=</span><span class="st">&#39;Emergency Locations Visited by&#39;</span>) <span class="sc">+</span></span>
<span id="cb128-25"><a href="advanced-ssn-metrics.html#cb128-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>() <span class="sc">+</span> </span>
<span id="cb128-26"><a href="advanced-ssn-metrics.html#cb128-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span> </span>
<span id="cb128-27"><a href="advanced-ssn-metrics.html#cb128-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb128-28"><a href="advanced-ssn-metrics.html#cb128-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb128-29"><a href="advanced-ssn-metrics.html#cb128-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y=</span><span class="fu">element_blank</span>()) </span></code></pre></div>
<pre><code>## Loading basemap &#39;light&#39; from map service &#39;carto&#39;...</code></pre>
<div class="sourceCode" id="cb130"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb130-1"><a href="advanced-ssn-metrics.html#cb130-1" aria-hidden="true" tabindex="-1"></a>g1</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-102-1.png" width="672" /></p>
<p>Not surprisingly, we can see that emergency locations visited by the linked nodes are more widespread than those visited by the primary node, with most overlaps in the northeast section of the map. Next, we would like to visualize the activity spaces as ellipses.</p>
<p>To add eclipses to the map above, we just need to add a layer in <code>ggplot</code> using <code>stat_ellipse()</code>. You can control the size (or coverage) of ellipses by adjusting the <code>level</code> argument. Here, <code>level = 0.8</code> means the ellipse covers about 80% of the data points.</p>
<div class="sourceCode" id="cb131"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb131-1"><a href="advanced-ssn-metrics.html#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize standard deviation ellipses for locations visited by the primary node and linked nodes.</span></span>
<span id="cb131-2"><a href="advanced-ssn-metrics.html#cb131-2" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">=</span> </span>
<span id="cb131-3"><a href="advanced-ssn-metrics.html#cb131-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map basemap </span></span>
<span id="cb131-4"><a href="advanced-ssn-metrics.html#cb131-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb131-5"><a href="advanced-ssn-metrics.html#cb131-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">basemap_gglayer</span>(bgbox) <span class="sc">+</span> </span>
<span id="cb131-6"><a href="advanced-ssn-metrics.html#cb131-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_identity</span>() <span class="sc">+</span></span>
<span id="cb131-7"><a href="advanced-ssn-metrics.html#cb131-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map locations associated with both the primary node and linked nodes. </span></span>
<span id="cb131-8"><a href="advanced-ssn-metrics.html#cb131-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> ego_alters_locations, </span>
<span id="cb131-9"><a href="advanced-ssn-metrics.html#cb131-9" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span>LonX, <span class="at">y=</span>LatY, <span class="at">color=</span>role, <span class="at">size=</span>role)) <span class="sc">+</span></span>
<span id="cb131-10"><a href="advanced-ssn-metrics.html#cb131-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Primary Node</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">5</span>, <span class="st">`</span><span class="at">Linked Node</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">2</span>), <span class="at">name=</span><span class="st">&#39;Activity Space by&#39;</span>) <span class="sc">+</span></span>
<span id="cb131-11"><a href="advanced-ssn-metrics.html#cb131-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Primary Node</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;darkred&#39;</span>, <span class="st">`</span><span class="at">Linked Node</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;orange&#39;</span>), <span class="at">name=</span><span class="st">&#39;Activity Space by&#39;</span>) <span class="sc">+</span></span>
<span id="cb131-12"><a href="advanced-ssn-metrics.html#cb131-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map activity space in the form of ellipses </span></span>
<span id="cb131-13"><a href="advanced-ssn-metrics.html#cb131-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">data =</span> ego_alters_locations, </span>
<span id="cb131-14"><a href="advanced-ssn-metrics.html#cb131-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="fu">aes</span>(<span class="at">x=</span>LonX, <span class="at">y=</span>LatY, <span class="at">group=</span>role, <span class="at">color=</span>role),</span>
<span id="cb131-15"><a href="advanced-ssn-metrics.html#cb131-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">linetype=</span><span class="st">&#39;dashed&#39;</span>, <span class="at">level =</span> <span class="fl">0.8</span>) <span class="sc">+</span> </span>
<span id="cb131-16"><a href="advanced-ssn-metrics.html#cb131-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>() <span class="sc">+</span> </span>
<span id="cb131-17"><a href="advanced-ssn-metrics.html#cb131-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span> </span>
<span id="cb131-18"><a href="advanced-ssn-metrics.html#cb131-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&#39;A Pair of Activity Spaces&#39;</span>) <span class="sc">+</span> </span>
<span id="cb131-19"><a href="advanced-ssn-metrics.html#cb131-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb131-20"><a href="advanced-ssn-metrics.html#cb131-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb131-21"><a href="advanced-ssn-metrics.html#cb131-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.y=</span><span class="fu">element_blank</span>(),</span>
<span id="cb131-22"><a href="advanced-ssn-metrics.html#cb131-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) </span></code></pre></div>
<pre><code>## Loading basemap &#39;light&#39; from map service &#39;carto&#39;...</code></pre>
<div class="sourceCode" id="cb133"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb133-1"><a href="advanced-ssn-metrics.html#cb133-1" aria-hidden="true" tabindex="-1"></a>g2 </span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-103-1.png" width="672" /></p>
<p>The map confirms that the primary node has a smaller activity space than the linked nodes. The two activity spaces overlap quite a bit as expected, because the primary node visits the emergency locations with at least one other linked node.</p>
<p>We are interested to explore further how the primary node’s activity space overlaps with <strong>each</strong> linked node (i.e., <strong>Linked Activity Spaces</strong>). We only need to modify the codes above slightly, by adding <code>group = label</code> in the <code>stat_ellipse()</code> function. Now the codes will draw a ellipse for each responders’ dispatched locations.</p>
<div class="sourceCode" id="cb134"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb134-1"><a href="advanced-ssn-metrics.html#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="co"># visualize standard deviation ellipses of locations visited by each unique responders </span></span>
<span id="cb134-2"><a href="advanced-ssn-metrics.html#cb134-2" aria-hidden="true" tabindex="-1"></a>g3 <span class="ot">=</span> </span>
<span id="cb134-3"><a href="advanced-ssn-metrics.html#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map basemap </span></span>
<span id="cb134-4"><a href="advanced-ssn-metrics.html#cb134-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>() <span class="sc">+</span> </span>
<span id="cb134-5"><a href="advanced-ssn-metrics.html#cb134-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">basemap_gglayer</span>(bgbox) <span class="sc">+</span> </span>
<span id="cb134-6"><a href="advanced-ssn-metrics.html#cb134-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_identity</span>() <span class="sc">+</span></span>
<span id="cb134-7"><a href="advanced-ssn-metrics.html#cb134-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map locations associated with both the primary node and linked nodes. </span></span>
<span id="cb134-8"><a href="advanced-ssn-metrics.html#cb134-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">data =</span> ego_alters_locations, </span>
<span id="cb134-9"><a href="advanced-ssn-metrics.html#cb134-9" aria-hidden="true" tabindex="-1"></a>             <span class="fu">aes</span>(<span class="at">x =</span>LonX, <span class="at">y=</span>LatY, <span class="at">color=</span>role, <span class="at">size=</span>role)) <span class="sc">+</span></span>
<span id="cb134-10"><a href="advanced-ssn-metrics.html#cb134-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_size_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Primary Node</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">5</span>, <span class="st">`</span><span class="at">Linked Node</span><span class="st">`</span> <span class="ot">=</span> <span class="dv">2</span>), <span class="at">name=</span><span class="st">&#39;Activity Space by&#39;</span>) <span class="sc">+</span></span>
<span id="cb134-11"><a href="advanced-ssn-metrics.html#cb134-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Primary Node</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;darkred&#39;</span>, <span class="st">`</span><span class="at">Linked Node</span><span class="st">`</span> <span class="ot">=</span> <span class="st">&#39;orange&#39;</span>), <span class="at">name=</span><span class="st">&#39;Activity Space by&#39;</span>) <span class="sc">+</span></span>
<span id="cb134-12"><a href="advanced-ssn-metrics.html#cb134-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map activity space in the form of ellipses </span></span>
<span id="cb134-13"><a href="advanced-ssn-metrics.html#cb134-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_ellipse</span>(<span class="at">data =</span> ego_alters_locations, </span>
<span id="cb134-14"><a href="advanced-ssn-metrics.html#cb134-14" aria-hidden="true" tabindex="-1"></a>               <span class="at">geom =</span> <span class="st">&quot;polygon&quot;</span>, <span class="fu">aes</span>(<span class="at">x=</span>LonX, <span class="at">y=</span>LatY, <span class="at">group=</span>label, <span class="at">color=</span>role),</span>
<span id="cb134-15"><a href="advanced-ssn-metrics.html#cb134-15" aria-hidden="true" tabindex="-1"></a>               <span class="at">type =</span> <span class="st">&quot;norm&quot;</span>, <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">linetype=</span><span class="st">&#39;dashed&#39;</span>, <span class="at">level =</span> <span class="fl">0.8</span>) <span class="sc">+</span> </span>
<span id="cb134-16"><a href="advanced-ssn-metrics.html#cb134-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>() <span class="sc">+</span> </span>
<span id="cb134-17"><a href="advanced-ssn-metrics.html#cb134-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_void</span>() <span class="sc">+</span> </span>
<span id="cb134-18"><a href="advanced-ssn-metrics.html#cb134-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">&#39;Linked Activity Spaces&#39;</span>) <span class="sc">+</span> </span>
<span id="cb134-19"><a href="advanced-ssn-metrics.html#cb134-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">&quot;bottom&quot;</span>,</span>
<span id="cb134-20"><a href="advanced-ssn-metrics.html#cb134-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title.x=</span><span class="fu">element_blank</span>(),</span>
<span id="cb134-21"><a href="advanced-ssn-metrics.html#cb134-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)) </span></code></pre></div>
<pre><code>## Loading basemap &#39;light&#39; from map service &#39;carto&#39;...</code></pre>
<div class="sourceCode" id="cb136"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb136-1"><a href="advanced-ssn-metrics.html#cb136-1" aria-hidden="true" tabindex="-1"></a>g3</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-104-1.png" width="672" /></p>
<p>We can roughly see three clusters of linked nodes’ activity spaces. One cluster of ellipses overlap closely with the primary node’s ellipse. The other cluster of ellipses overlap partially with the primary node’s ellipse while also going to locations toward the south (east of the river). However, there are about three elipses on the west bank of the river that have little overlaps with the primary node’s ellipse. It indicates that these three linked nodes (emergency responders) tend to have very different dispatch locations than the primary node. Next, we would like to further quantify the intersection between the activity spaces.</p>
</div>
<div id="quantify-linked-activity-spaces" class="section level3" number="6.4.2">
<h3><span class="header-section-number">6.4.2</span> Quantify Linked Activity Spaces</h3>
<p>We quantify the intersection between activity spaces as the number of nodes (in this case, emergency locations) in between the ellipses. We reference this <a href="https://stackoverflow.com/questions/34650441/how-to-get-the-points-inside-of-the-ellipse-in-ggplot2">Stack Overflow post</a> to generate the codes below.</p>
<p>Let’s first quantify the intersection for <code>g2</code> (see the map for <code>g2</code> above). <code>ggplot_build()</code> returns a list containing several data frames, one for each layer in the plot. In my case, there are three layers: <code>basemap_gglayer</code>, <code>geom_point</code>, and <code>stat_ellipse</code>. Thus, <code>points</code> and <code>ellipse</code> data correspond to the second and third data frames. <code>ellipse_sf</code> is an sf object with two geometries (because we drew two ellipses). Thus, <code>points_in_ellipses</code> will return a list of integer vectors, in which an empty vector means the point is not inside either ellipses; one element (1 or 2) means the point is inside ellipse 1 or 2 (the number refers to the group associated with the ellipses); two elements (1 and 2) means that the point is inside both ellipses.</p>
<div class="sourceCode" id="cb137"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb137-1"><a href="advanced-ssn-metrics.html#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co"># retrieve points and ellipse data. </span></span>
<span id="cb137-2"><a href="advanced-ssn-metrics.html#cb137-2" aria-hidden="true" tabindex="-1"></a>build <span class="ot">&lt;-</span> <span class="fu">ggplot_build</span>(g2)<span class="sc">$</span>data</span>
<span id="cb137-3"><a href="advanced-ssn-metrics.html#cb137-3" aria-hidden="true" tabindex="-1"></a>points <span class="ot">&lt;-</span> build[[<span class="dv">2</span>]]</span>
<span id="cb137-4"><a href="advanced-ssn-metrics.html#cb137-4" aria-hidden="true" tabindex="-1"></a>ellipse <span class="ot">&lt;-</span> build[[<span class="dv">3</span>]]</span>
<span id="cb137-5"><a href="advanced-ssn-metrics.html#cb137-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-6"><a href="advanced-ssn-metrics.html#cb137-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert ellipse data to sf polygons; ellipse_sf is an sf object with two geometries </span></span>
<span id="cb137-7"><a href="advanced-ssn-metrics.html#cb137-7" aria-hidden="true" tabindex="-1"></a>ellipse_sf <span class="ot">&lt;-</span> ellipse <span class="sc">%&gt;%</span></span>
<span id="cb137-8"><a href="advanced-ssn-metrics.html#cb137-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="dv">3857</span>) <span class="sc">%&gt;%</span></span>
<span id="cb137-9"><a href="advanced-ssn-metrics.html#cb137-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb137-10"><a href="advanced-ssn-metrics.html#cb137-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">geometry =</span> <span class="fu">st_combine</span>(geometry)) <span class="sc">%&gt;%</span></span>
<span id="cb137-11"><a href="advanced-ssn-metrics.html#cb137-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_cast</span>(<span class="st">&quot;POLYGON&quot;</span>)</span>
<span id="cb137-12"><a href="advanced-ssn-metrics.html#cb137-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-13"><a href="advanced-ssn-metrics.html#cb137-13" aria-hidden="true" tabindex="-1"></a>ellipse_sf</span></code></pre></div>
<pre><code>## Simple feature collection with 2 features and 1 field
## Geometry type: POLYGON
## Dimension:     XY
## Bounding box:  xmin: -8232963 ymin: 4975299 xmax: -8227866 ymax: 4979577
## Projected CRS: WGS 84 / Pseudo-Mercator
## # A tibble: 2 × 2
##   group                                                                 geometry
##   &lt;int&gt;                                                            &lt;POLYGON [m]&gt;
## 1     1 ((-8228259 4978079, -8228268 4978264, -8228297 4978447, -8228344 497862…
## 2     2 ((-8227866 4977535, -8227886 4977787, -8227943 4978033, -8228039 497826…</code></pre>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="advanced-ssn-metrics.html#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if each point in the ego_alters_locations dataset is within the respective ellipses</span></span>
<span id="cb139-2"><a href="advanced-ssn-metrics.html#cb139-2" aria-hidden="true" tabindex="-1"></a>points_in_ellipses <span class="ot">&lt;-</span> <span class="fu">st_within</span>(ego_alters_locations, ellipse_sf)</span>
<span id="cb139-3"><a href="advanced-ssn-metrics.html#cb139-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-4"><a href="advanced-ssn-metrics.html#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="co"># example outputs in points_in_ellipses</span></span>
<span id="cb139-5"><a href="advanced-ssn-metrics.html#cb139-5" aria-hidden="true" tabindex="-1"></a>points_in_ellipses[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">12</span>)]</span></code></pre></div>
<pre><code>## [[1]]
## [1] 1 2
## 
## [[2]]
## [1] 2
## 
## [[3]]
## integer(0)</code></pre>
<div class="sourceCode" id="cb141"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb141-1"><a href="advanced-ssn-metrics.html#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate the number of points that are in both ellipses</span></span>
<span id="cb141-2"><a href="advanced-ssn-metrics.html#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sum</span>(<span class="fu">lengths</span>(points_in_ellipses) <span class="sc">&gt;</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>## [1] 399</code></pre>
<p>Great! We have quantified intersection between one pair of activity spaces. For <strong>Linked Activity Spaces</strong>, we would like to know this value for each linked node so that we can see which responders’ activity space overlap the most with the primary node. We just need to modify the codes above slightly and use outputs from <code>g3</code>. Note that this time <code>ellipse_sf</code> will have 22 geometries (22 ellipses for 22 linked nodes). Since in <code>stat_ellipse()</code>, ellipses are drawn by group based on the order of labels. Thus, primary node’s ellipse is assigned to group 1 (i.e., 1). We create a loop to loop through each linked node’s ellipse (starting from group 2) and count the number of locations in the intersection of the primary node’s ellipse and the linked node’s ellipse.</p>
<div class="sourceCode" id="cb143"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb143-1"><a href="advanced-ssn-metrics.html#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># retrieve points and ellipse data. </span></span>
<span id="cb143-2"><a href="advanced-ssn-metrics.html#cb143-2" aria-hidden="true" tabindex="-1"></a>build <span class="ot">&lt;-</span> <span class="fu">ggplot_build</span>(g3)<span class="sc">$</span>data</span>
<span id="cb143-3"><a href="advanced-ssn-metrics.html#cb143-3" aria-hidden="true" tabindex="-1"></a>points <span class="ot">&lt;-</span> build[[<span class="dv">2</span>]]</span>
<span id="cb143-4"><a href="advanced-ssn-metrics.html#cb143-4" aria-hidden="true" tabindex="-1"></a>ellipse <span class="ot">&lt;-</span> build[[<span class="dv">3</span>]]</span>
<span id="cb143-5"><a href="advanced-ssn-metrics.html#cb143-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-6"><a href="advanced-ssn-metrics.html#cb143-6" aria-hidden="true" tabindex="-1"></a><span class="co"># convert ellipse data to sf polygons; ellipse_sf is an sf object with twenty-two geometries </span></span>
<span id="cb143-7"><a href="advanced-ssn-metrics.html#cb143-7" aria-hidden="true" tabindex="-1"></a>ellipse_sf <span class="ot">&lt;-</span> ellipse <span class="sc">%&gt;%</span></span>
<span id="cb143-8"><a href="advanced-ssn-metrics.html#cb143-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">crs =</span> <span class="dv">3857</span>) <span class="sc">%&gt;%</span></span>
<span id="cb143-9"><a href="advanced-ssn-metrics.html#cb143-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb143-10"><a href="advanced-ssn-metrics.html#cb143-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">geometry =</span> <span class="fu">st_combine</span>(geometry)) <span class="sc">%&gt;%</span></span>
<span id="cb143-11"><a href="advanced-ssn-metrics.html#cb143-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_cast</span>(<span class="st">&quot;POLYGON&quot;</span>)</span>
<span id="cb143-12"><a href="advanced-ssn-metrics.html#cb143-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-13"><a href="advanced-ssn-metrics.html#cb143-13" aria-hidden="true" tabindex="-1"></a><span class="fu">nrow</span>(ellipse_sf)</span></code></pre></div>
<pre><code>## [1] 22</code></pre>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="advanced-ssn-metrics.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loop through each linked node&#39;s ellipse (starting from group 2) and count the number of locations in the intersection. </span></span>
<span id="cb145-2"><a href="advanced-ssn-metrics.html#cb145-2" aria-hidden="true" tabindex="-1"></a>cnt <span class="ot">=</span> <span class="fu">c</span>()</span>
<span id="cb145-3"><a href="advanced-ssn-metrics.html#cb145-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (grp <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="fu">nrow</span>(ellipse_sf))) {</span>
<span id="cb145-4"><a href="advanced-ssn-metrics.html#cb145-4" aria-hidden="true" tabindex="-1"></a>  points_in_ellipses <span class="ot">&lt;-</span> <span class="fu">st_within</span>(ego_alters_locations, ellipse_sf <span class="sc">%&gt;%</span> <span class="fu">filter</span>(group <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, grp)))</span>
<span id="cb145-5"><a href="advanced-ssn-metrics.html#cb145-5" aria-hidden="true" tabindex="-1"></a>  n_nodes_in_both_ellipses <span class="ot">&lt;-</span> <span class="fu">sum</span>(<span class="fu">lengths</span>(points_in_ellipses) <span class="sc">&gt;</span> <span class="dv">1</span>)</span>
<span id="cb145-6"><a href="advanced-ssn-metrics.html#cb145-6" aria-hidden="true" tabindex="-1"></a>  cnt <span class="ot">=</span> <span class="fu">c</span>(cnt, n_nodes_in_both_ellipses)</span>
<span id="cb145-7"><a href="advanced-ssn-metrics.html#cb145-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb145-8"><a href="advanced-ssn-metrics.html#cb145-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-9"><a href="advanced-ssn-metrics.html#cb145-9" aria-hidden="true" tabindex="-1"></a><span class="co">#pair up nodes and the number of nodes in P1&#39;s ellipse and this linked node&#39;s ellipse. </span></span>
<span id="cb145-10"><a href="advanced-ssn-metrics.html#cb145-10" aria-hidden="true" tabindex="-1"></a><span class="fu">data.frame</span>(<span class="at">label =</span> <span class="fu">unique</span>(ego_alters_locations<span class="sc">$</span>label), <span class="at">n_nodes_in_both_ellipses =</span> <span class="fu">c</span>(<span class="cn">NA</span>, cnt))</span></code></pre></div>
<pre><code>##    label n_nodes_in_both_ellipses
## 1     P1                       NA
## 2     P3                      409
## 3     P4                      395
## 4     P8                      409
## 5    P10                      137
## 6    P11                      320
## 7    P13                      193
## 8    P14                      368
## 9    P17                      392
## 10   P19                      360
## 11   P20                      315
## 12   P22                      353
## 13   P23                      315
## 14   P25                      382
## 15   P26                      360
## 16   P28                      392
## 17   P29                      159
## 18   P30                      360
## 19   P31                        0
## 20   P32                        0
## 21   P33                      101
## 22   P38                        0</code></pre>
<p>The result confirms our observations above: there are three linked nodes (P31, P32, P38) that have zero location overlaps with the primary node. While these responders may be paired with the primary node (P1) for few tasks, it is worth looking into why they are paired to improve the emergency management. In contrast, P3 and P8’s activity spaces overlap with the primary node (P1) the most.</p>
<div id="reference" class="section level4" number="6.4.2.1">
<h4><span class="header-section-number">6.4.2.1</span> Reference</h4>
<p>Liang, X., Baker, J., DellaPosta, D., &amp; Andris, C. (2023). Is your neighbor your friend? Scan methods for spatial social network hotspot detection. <em>Transactions in GIS</em>. <a href="https://doi.org/10.1111/tgis.13050" class="uri">https://doi.org/10.1111/tgis.13050</a></p>
<p>Andris, C., DellaPosta, D., Freelin, B. N., Zhu, X., Hinger, B., &amp; Chen, H. (2021). To racketeer among neighbors: spatial features of criminal collaboration in the American Mafia. <em>International Journal of Geographical Information Science</em>, 35(12), 2463-2488.</p>
<p>Sarkar, D., Andris, C., Chapman, C. A., &amp; Sengupta, R. (2019). Metrics for characterizing network structure and node importance in Spatial Social Networks. <em>International Journal of Geographical Information Science</em>, 33(5), 1017-1039.</p>
<p>Wang, Y., Kang, C., Bettencourt, L. M., Liu, Y., &amp; Andris, C. (2015). Linked activity spaces: Embedding social networks in urban space. <em>Computational approaches for urban environments</em>, 313-336.</p>

</div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="advanced-aesthetics.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="development.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["SSN_tutorial.pdf", "SSN_tutorial.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
