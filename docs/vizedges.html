<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 4 Visualizing Edges | Spatial Social Networks (SSN) Visualization and Metrics with R</title>
  <meta name="description" content="This book describes the basic concepts, theories, methods, and visualizations involved to map and analyze spatial networks in R." />
  <meta name="generator" content="bookdown 0.24 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 4 Visualizing Edges | Spatial Social Networks (SSN) Visualization and Metrics with R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book describes the basic concepts, theories, methods, and visualizations involved to map and analyze spatial networks in R." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 4 Visualizing Edges | Spatial Social Networks (SSN) Visualization and Metrics with R" />
  
  <meta name="twitter:description" content="This book describes the basic concepts, theories, methods, and visualizations involved to map and analyze spatial networks in R." />
  

<meta name="author" content="Xiaofan Liang, Clio Andris, Dipto Sarkar" />


<meta name="date" content="2022-11-30" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="nodes.html"/>
<link rel="next" href="advanced-aesthetics.html"/>
<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>
<script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
<link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-1.3.1/leaflet.js"></script>
<link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="libs/proj4-2.6.2/proj4.min.js"></script>
<script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding-2.0.4.1/leaflet.js"></script>
<script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin-2.0.4.1/leaflet-providers-plugin.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">SSN Tutorial</a></li>

<li class="divider"></li>
<li><a href="index.html#introduction" id="toc-introduction"><span class="toc-section-number">1</span> Introduction</a></li>
<li><a href="metrics.html#metrics" id="toc-metrics"><span class="toc-section-number">2</span> Network Metrics</a>
<ul>
<li><a href="metrics.html#network-data-formats" id="toc-network-data-formats"><span class="toc-section-number">2.1</span> Network Data Formats</a></li>
<li><a href="metrics.html#network-metrics" id="toc-network-metrics"><span class="toc-section-number">2.2</span> Network Metrics</a>
<ul>
<li><a href="metrics.html#network-metrics-for-nodes" id="toc-network-metrics-for-nodes"><span class="toc-section-number">2.2.1</span> Network Metrics for Nodes</a></li>
<li><a href="metrics.html#network-metrics-for-edges" id="toc-network-metrics-for-edges"><span class="toc-section-number">2.2.2</span> Network Metrics for Edges</a></li>
</ul></li>
<li><a href="metrics.html#igraph-visualization" id="toc-igraph-visualization"><span class="toc-section-number">2.3</span> igraph Visualization</a></li>
</ul></li>
<li><a href="nodes.html#nodes" id="toc-nodes"><span class="toc-section-number">3</span> Visualizing Nodes</a>
<ul>
<li><a href="nodes.html#convert-coordinates-to-points" id="toc-convert-coordinates-to-points"><span class="toc-section-number">3.1</span> Convert Coordinates to Points</a></li>
<li><a href="nodes.html#visualize-nodes" id="toc-visualize-nodes"><span class="toc-section-number">3.2</span> Visualize Nodes</a></li>
<li><a href="nodes.html#visualize-nodes-by-node-color" id="toc-visualize-nodes-by-node-color"><span class="toc-section-number">3.3</span> Visualize Nodes by Node Color</a></li>
<li><a href="nodes.html#visualize-nodes-by-node-size" id="toc-visualize-nodes-by-node-size"><span class="toc-section-number">3.4</span> Visualize Nodes by Node Size</a></li>
<li><a href="nodes.html#visualize-nodes-by-size-and-color" id="toc-visualize-nodes-by-size-and-color"><span class="toc-section-number">3.5</span> Visualize Nodes by Size and Color</a></li>
</ul></li>
<li><a href="vizedges.html#vizedges" id="toc-vizedges"><span class="toc-section-number">4</span> Visualizing Edges</a>
<ul>
<li><a href="vizedges.html#convert-points-into-lines" id="toc-convert-points-into-lines"><span class="toc-section-number">4.1</span> Convert Points into Lines</a>
<ul>
<li><a href="vizedges.html#method-1-use-od2line-function-in-stplanr-package." id="toc-method-1-use-od2line-function-in-stplanr-package."><span class="toc-section-number">4.1.1</span> Method 1: Use <code>od2line</code> function in <code>stplanr</code> package.</a></li>
<li><a href="vizedges.html#method-2-group-by-lineid-and-summarize-points-into-line" id="toc-method-2-group-by-lineid-and-summarize-points-into-line"><span class="toc-section-number">4.1.2</span> Method 2: Group by lineID and Summarize Points into Line</a></li>
<li><a href="vizedges.html#method-3-join-two-point-geometry-into-one-row-and-unite-into-line" id="toc-method-3-join-two-point-geometry-into-one-row-and-unite-into-line"><span class="toc-section-number">4.1.3</span> Method 3: Join Two Point Geometry into One Row and Unite into Line</a></li>
</ul></li>
<li><a href="vizedges.html#visualizing-edges" id="toc-visualizing-edges"><span class="toc-section-number">4.2</span> Visualizing Edges</a></li>
<li><a href="vizedges.html#visualizing-edges-by-line-width" id="toc-visualizing-edges-by-line-width"><span class="toc-section-number">4.3</span> Visualizing Edges by Line Width</a></li>
<li><a href="vizedges.html#visualizing-edges-by-color" id="toc-visualizing-edges-by-color"><span class="toc-section-number">4.4</span> Visualizing Edges by Color</a></li>
<li><a href="vizedges.html#visualizing-edges-by-width-and-color" id="toc-visualizing-edges-by-width-and-color"><span class="toc-section-number">4.5</span> Visualizing Edges by Width and Color</a></li>
</ul></li>
<li><a href="advanced-aesthetics.html#advanced-aesthetics" id="toc-advanced-aesthetics"><span class="toc-section-number">5</span> Advanced Aesthetics</a>
<ul>
<li><a href="advanced-aesthetics.html#export-maps" id="toc-export-maps"><span class="toc-section-number">5.1</span> Export Maps</a></li>
<li><a href="advanced-aesthetics.html#small-multiples" id="toc-small-multiples"><span class="toc-section-number">5.2</span> Small Multiples</a></li>
<li><a href="advanced-aesthetics.html#interactive-maps" id="toc-interactive-maps"><span class="toc-section-number">5.3</span> Interactive Maps</a></li>
<li><a href="advanced-aesthetics.html#base-map" id="toc-base-map"><span class="toc-section-number">5.4</span> Base Map</a></li>
<li><a href="advanced-aesthetics.html#inset-map" id="toc-inset-map"><span class="toc-section-number">5.5</span> Inset Map</a></li>
<li><a href="advanced-aesthetics.html#edge-bundling" id="toc-edge-bundling"><span class="toc-section-number">5.6</span> Edge Bundling</a></li>
</ul></li>
<li><a href="advanced-ssn-metrics.html#advanced-ssn-metrics" id="toc-advanced-ssn-metrics"><span class="toc-section-number">6</span> Advanced SSN Metrics</a>
<ul>
<li><a href="advanced-ssn-metrics.html#ssn-hotspots-detection" id="toc-ssn-hotspots-detection"><span class="toc-section-number">6.1</span> SSN Hotspots Detection</a>
<ul>
<li><a href="advanced-ssn-metrics.html#calculate-ssn-hotspots-using-radius-or-k-nearest-neighbor-window-sizes" id="toc-calculate-ssn-hotspots-using-radius-or-k-nearest-neighbor-window-sizes"><span class="toc-section-number">6.1.1</span> Calculate SSN hotspots using radius or K-nearest neighbor window sizes</a></li>
<li><a href="advanced-ssn-metrics.html#how-to-visualize-ssn-hotspots" id="toc-how-to-visualize-ssn-hotspots"><span class="toc-section-number">6.1.2</span> How to visualize SSN hotspots</a></li>
<li><a href="advanced-ssn-metrics.html#how-to-find-optimal-window-sizes-for-ssn-hotspots" id="toc-how-to-find-optimal-window-sizes-for-ssn-hotspots"><span class="toc-section-number">6.1.3</span> How to find optimal window sizes for SSN hotspots</a></li>
<li><a href="advanced-ssn-metrics.html#calculate-ssn-hotspots-using-a-user-defined-walking-distance-matrix-extracted-from-osm" id="toc-calculate-ssn-hotspots-using-a-user-defined-walking-distance-matrix-extracted-from-osm"><span class="toc-section-number">6.1.4</span> Calculate SSN hotspots using a user-defined walking distance matrix extracted from OSM</a></li>
<li><a href="advanced-ssn-metrics.html#application-to-a-weighted-and-bipartite-network" id="toc-application-to-a-weighted-and-bipartite-network"><span class="toc-section-number">6.1.5</span> Application to a weighted and bipartite network</a></li>
</ul></li>
<li><a href="advanced-ssn-metrics.html#k-fullfillment" id="toc-k-fullfillment"><span class="toc-section-number">6.2</span> K-fullfillment</a>
<ul>
<li><a href="advanced-ssn-metrics.html#calculate-k-fullfillment-values" id="toc-calculate-k-fullfillment-values"><span class="toc-section-number">6.2.1</span> Calculate K-fullfillment values</a></li>
<li><a href="advanced-ssn-metrics.html#visualize-k-fullfillment" id="toc-visualize-k-fullfillment"><span class="toc-section-number">6.2.2</span> Visualize K-fullfillment</a></li>
<li><a href="advanced-ssn-metrics.html#application-to-a-bipartite-network" id="toc-application-to-a-bipartite-network"><span class="toc-section-number">6.2.3</span> Application to a Bipartite Network</a></li>
</ul></li>
</ul></li>
<li><a href="edges.html#edges" id="toc-edges"><span class="toc-section-number">7</span> Future Development</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Spatial Social Networks (SSN) Visualization and Metrics with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="vizedges" class="section level1" number="4">
<h1><span class="header-section-number">Chapter 4</span> Visualizing Edges</h1>
<p>In this chapter, we will use commute data from U.S. Census LEHD (Longitudinal Employer-Household Dynamics) Origin-Destination Employment Statistics (<a href="https://lehd.ces.census.gov/data/">LODES</a>). We will use <code>lehdr</code> package to download LODES commute data between counties in Georgia and use <code>tigris</code> to download county shapefiles and convert to centroids as points in the spatial networks.</p>
<p>This chapter covers the following topics:</p>
<ul>
<li>How to convert point data into line geometry</li>
<li>How to visualize edges with constant color and size</li>
<li>How to visualize edges with varying edge width by attributes</li>
<li>How to visualize edges with varying edge color by attributes</li>
<li>How to visualize edges with varying edge size and edge color with a combined legend</li>
</ul>
<p>You will be able to find a copy of all the codes at the bottom of the page.</p>
<p><img src="Figs/04-edges-1.png" width="50%" /><img src="Figs/04-edges-3.png" width="50%" /><img src="Figs/04-edges-4.png" width="50%" /><img src="Figs/04-edges-6.png" width="50%" /></p>
<p>Before proceeding to the codes, please load the following packages:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="vizedges.html#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co">#for using spatial objects </span></span>
<span id="cb33-2"><a href="vizedges.html#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co">#for using tidy syntax </span></span>
<span id="cb33-3"><a href="vizedges.html#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap) <span class="co">#for visualizing maps </span></span>
<span id="cb33-4"><a href="vizedges.html#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris) <span class="co">#for downloading TIGER boundary shapefiles </span></span>
<span id="cb33-5"><a href="vizedges.html#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lehdr) <span class="co">#for downloading LODES commute data</span></span>
<span id="cb33-6"><a href="vizedges.html#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stplanr) <span class="co">#for using od2line function to convert points to lines</span></span></code></pre></div>
<div id="convert-points-into-lines" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Convert Points into Lines</h2>
<p>To start, we use <code>lehdr</code> <a href="https://github.com/jamgreen/lehdr">package</a> to download LODES commute data between counties in Georgia and use <code>tigris</code> <a href="https://github.com/walkerke/tigris">package</a> to download county shapefiles and convert to centroids as points in the spatial networks.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="vizedges.html#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">#counties is a function in tigris package</span></span>
<span id="cb34-2"><a href="vizedges.html#cb34-2" aria-hidden="true" tabindex="-1"></a>GA_county <span class="ot">=</span> <span class="fu">counties</span>(<span class="at">state =</span> <span class="st">&#39;GA&#39;</span>, <span class="at">cb=</span><span class="cn">TRUE</span>, <span class="at">year=</span><span class="dv">2018</span>, <span class="at">progress_bar=</span><span class="cn">FALSE</span>) </span>
<span id="cb34-3"><a href="vizedges.html#cb34-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-4"><a href="vizedges.html#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">#grab_lodes is a function in lehdr package</span></span>
<span id="cb34-5"><a href="vizedges.html#cb34-5" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">grab_lodes</span>(<span class="at">state=</span><span class="st">&#39;ga&#39;</span>, <span class="at">year=</span><span class="dv">2018</span>, <span class="at">lodes_type =</span> <span class="st">&#39;od&#39;</span>, <span class="at">state_part =</span> <span class="st">&#39;main&#39;</span>, <span class="at">agg_geo =</span> <span class="st">&#39;county&#39;</span>)</span>
<span id="cb34-6"><a href="vizedges.html#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="vizedges.html#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">#filter top 1000 county-to-county flows </span></span>
<span id="cb34-8"><a href="vizedges.html#cb34-8" aria-hidden="true" tabindex="-1"></a>ctc_commutes <span class="ot">=</span> data <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(w_county, h_county, S000)) <span class="sc">%&gt;%</span> </span>
<span id="cb34-9"><a href="vizedges.html#cb34-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">flow =</span> S000) <span class="sc">%&gt;%</span> </span>
<span id="cb34-10"><a href="vizedges.html#cb34-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(h_county <span class="sc">!=</span> w_county) <span class="sc">%&gt;%</span> </span>
<span id="cb34-11"><a href="vizedges.html#cb34-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(flow)) <span class="sc">%&gt;%</span> </span>
<span id="cb34-12"><a href="vizedges.html#cb34-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>) </span>
<span id="cb34-13"><a href="vizedges.html#cb34-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-14"><a href="vizedges.html#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(ctc_commutes, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## # A tibble: 3 × 3
##   w_county h_county   flow
##   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;
## 1 13121    13089    128889
## 2 13121    13067    109627
## 3 13121    13135     87646</code></pre>
<p>Columns <code>h_county</code> and <code>w_county</code> contain the county FIPS (or GEOID) codes. <code>S000</code> contains the total number of job flows between the home county and the work county. We also only want to create lines between counties, so we will filter out flows that have the same <code>h_county</code> and <code>w_county</code>.</p>
<p>There are THREE ways to convert points into a line geometry.</p>
<div id="method-1-use-od2line-function-in-stplanr-package." class="section level3" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> Method 1: Use <code>od2line</code> function in <code>stplanr</code> package.</h3>
<p><code>od2line</code> takes in an OD dataframe that assumes the first two column contains the origin and destination variables that can be matched to the shapefile. In our case, those are the county GEOID. <strong>This method is particularly useful if you stores your OD dataframe and your shapefiles separately</strong>. This is the easiest way for our dataset to convert into lines. The only downside is you have one more package dependency. We encourage readers to explore other useful OD-related functions in the <code>stplanr</code> package, such as <code>dist_google()</code>, <code>od_coords2line()</code>, <code>od_to_odmatrix()</code> and so on.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="vizedges.html#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stplanr)</span>
<span id="cb36-2"><a href="vizedges.html#cb36-2" aria-hidden="true" tabindex="-1"></a>cnty_centroid <span class="ot">=</span> GA_county <span class="sc">%&gt;%</span> <span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(GEOID, geometry))</span>
<span id="cb36-3"><a href="vizedges.html#cb36-3" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> <span class="fu">od2line</span>(ctc_commutes, cnty_centroid)</span>
<span id="cb36-4"><a href="vizedges.html#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(edges, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 3 fields
## Geometry type: LINESTRING
## Dimension:     XY
## Bounding box:  xmin: -84.5767 ymin: 33.77149 xmax: -84.02363 ymax: 33.96167
## Geodetic CRS:  NAD83
##   w_county h_county   flow                       geometry
## 1    13121    13089 128889 LINESTRING (-84.4676 33.789...
## 2    13121    13067 109627 LINESTRING (-84.4676 33.789...
## 3    13121    13135  87646 LINESTRING (-84.4676 33.789...</code></pre>
</div>
<div id="method-2-group-by-lineid-and-summarize-points-into-line" class="section level3" number="4.1.2">
<h3><span class="header-section-number">4.1.2</span> Method 2: Group by lineID and Summarize Points into Line</h3>
<p>The second one is to group the points coordinates by line ID, summarize the flow values, and then use <code>st_cast</code> in the <code>sf</code> package to turn the grouped point coordinates into a line geometry. <strong>This method is particularly useful if your points are organized by line ID and if you do not want to use extra packages</strong>. It is also convenient GPS trajectory data because each row is a point data associated with a line ID and you want to connect all the points that represent one trajectory.</p>
<p>For our data, we do not have line ID for points, but we can create such ID with <code>row_number()</code>. To leverage method 1, we have to split one OD pair into two rows so that the first row contains the point geometry of the origin and the second row contains the point geometry of the destination. To do that, we perform a little trick: we swap the position of the <code>h_county</code> and <code>w_county</code> of <code>ctc_commutes</code> and bind it to the existing <code>ctc_commutes</code> dataframe. Then when we join county shapefiles by <code>h_county</code>, we actually join the shapefiles for both the origin county and the destination county. Then we can use the group_by and summarise method to create lines. Noted that column <code>ID</code> needs to be created before and during binding the <code>ctc_commutes</code>, so that group_by knows which OD is one the same line. You also need to ensure the dataframe is an <code>sf</code> object after doing <code>left_join</code> through <code>st_as_sf()</code>.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="vizedges.html#cb38-1" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> ctc_commutes <span class="sc">%&gt;%</span> </span>
<span id="cb38-2"><a href="vizedges.html#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb38-3"><a href="vizedges.html#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(ctc_commutes <span class="sc">%&gt;%</span> <span class="fu">rename</span>(<span class="at">w_county =</span> h_county, <span class="at">h_county =</span> w_county) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">ID =</span> <span class="fu">row_number</span>())) <span class="sc">%&gt;%</span> </span>
<span id="cb38-4"><a href="vizedges.html#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(GA_county <span class="sc">%&gt;%</span> <span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(GEOID, geometry)), <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;h_county&#39;</span> <span class="ot">=</span> <span class="st">&#39;GEOID&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb38-5"><a href="vizedges.html#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb38-6"><a href="vizedges.html#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(ID) <span class="sc">%&gt;%</span> </span>
<span id="cb38-7"><a href="vizedges.html#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">w_county=</span><span class="fu">first</span>(w_county), <span class="at">h_county =</span> <span class="fu">first</span>(h_county), <span class="at">flow=</span><span class="fu">mean</span>(flow)) <span class="sc">%&gt;%</span></span>
<span id="cb38-8"><a href="vizedges.html#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_cast</span>(<span class="st">&quot;LINESTRING&quot;</span>) </span>
<span id="cb38-9"><a href="vizedges.html#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="vizedges.html#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(edges, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 4 fields
## Geometry type: LINESTRING
## Dimension:     XY
## Bounding box:  xmin: -84.5767 ymin: 33.77149 xmax: -84.02363 ymax: 33.96167
## Geodetic CRS:  NAD83
## # A tibble: 3 × 5
##      ID w_county h_county   flow                                geometry
##   &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;                        &lt;LINESTRING [°]&gt;
## 1     1 13121    13089    128889 (-84.4676 33.78992, -84.22637 33.77149)
## 2     2 13121    13067    109627  (-84.5767 33.94143, -84.4676 33.78992)
## 3     3 13121    13135     87646 (-84.4676 33.78992, -84.02363 33.96167)</code></pre>
</div>
<div id="method-3-join-two-point-geometry-into-one-row-and-unite-into-line" class="section level3" number="4.1.3">
<h3><span class="header-section-number">4.1.3</span> Method 3: Join Two Point Geometry into One Row and Unite into Line</h3>
<p>The third way to convert points into lines is to join two point geometry in one row and cast them into a line. <strong>This method is particularly useful if you have coordinates of both origin and destination points in one dataframe</strong>. In our case, we do not have coordinates, so we have to join <code>GA_county</code> to get the geometries to use this method.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="vizedges.html#cb40-1" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> ctc_commutes <span class="sc">%&gt;%</span> </span>
<span id="cb40-2"><a href="vizedges.html#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(GA_county <span class="sc">%&gt;%</span> <span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(GEOID, geometry)), <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;h_county&#39;</span> <span class="ot">=</span> <span class="st">&#39;GEOID&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-3"><a href="vizedges.html#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(GA_county <span class="sc">%&gt;%</span> <span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(GEOID, geometry)), <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;w_county&#39;</span> <span class="ot">=</span> <span class="st">&#39;GEOID&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb40-4"><a href="vizedges.html#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">geometry =</span> <span class="fu">st_cast</span>(<span class="fu">st_union</span>(geometry.x, geometry.y), <span class="st">&quot;LINESTRING&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb40-5"><a href="vizedges.html#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(geometry.x, geometry.y)) <span class="sc">%&gt;%</span> <span class="fu">st_as_sf</span>()</span>
<span id="cb40-6"><a href="vizedges.html#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="vizedges.html#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(edges, <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## Simple feature collection with 3 features and 3 fields
## Geometry type: LINESTRING
## Dimension:     XY
## Bounding box:  xmin: -84.5767 ymin: 33.77149 xmax: -84.02363 ymax: 33.96167
## Geodetic CRS:  NAD83
## # A tibble: 3 × 4
##   w_county h_county   flow                                geometry
##   &lt;chr&gt;    &lt;chr&gt;     &lt;dbl&gt;                        &lt;LINESTRING [°]&gt;
## 1 13121    13089    128889 (-84.4676 33.78992, -84.22637 33.77149)
## 2 13121    13067    109627  (-84.5767 33.94143, -84.4676 33.78992)
## 3 13121    13135     87646 (-84.4676 33.78992, -84.02363 33.96167)</code></pre>
</div>
</div>
<div id="visualizing-edges" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Visualizing Edges</h2>
<p>The simplest edge visualization code snippet using <code>tmap</code> is the following:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="vizedges.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb42-2"><a href="vizedges.html#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Visualize edges </span></span>
<span id="cb42-3"><a href="vizedges.html#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(GA_county) <span class="sc">+</span> </span>
<span id="cb42-4"><a href="vizedges.html#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>() <span class="sc">+</span></span>
<span id="cb42-5"><a href="vizedges.html#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(edges) <span class="sc">+</span></span>
<span id="cb42-6"><a href="vizedges.html#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>()</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>
</div>
<div id="visualizing-edges-by-line-width" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Visualizing Edges by Line Width</h2>
<p>To visualize edges by line width, we added a column variable <code>flow</code> for line width in <code>tm_lines()</code>.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="vizedges.html#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb43-2"><a href="vizedges.html#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(GA_county) <span class="sc">+</span> </span>
<span id="cb43-3"><a href="vizedges.html#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">#change polygon background to be transparent</span></span>
<span id="cb43-4"><a href="vizedges.html#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">alpha=</span><span class="dv">0</span>, <span class="at">border.col =</span> <span class="st">&#39;black&#39;</span>) <span class="sc">+</span></span>
<span id="cb43-5"><a href="vizedges.html#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(edges) <span class="sc">+</span></span>
<span id="cb43-6"><a href="vizedges.html#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">#define line width and properties associated with lines </span></span>
<span id="cb43-7"><a href="vizedges.html#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">lwd=</span><span class="st">&#39;flow&#39;</span>, <span class="at">scale=</span><span class="dv">10</span>, <span class="at">alpha=</span><span class="fl">0.5</span>, <span class="at">legend.lwd.is.portrait =</span> <span class="cn">TRUE</span>,</span>
<span id="cb43-8"><a href="vizedges.html#cb43-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">title.lwd =</span> <span class="fu">c</span>(<span class="st">&#39;Commutes Across Counties&#39;</span>)) <span class="sc">+</span> </span>
<span id="cb43-9"><a href="vizedges.html#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">&#39;right&#39;</span>, <span class="st">&#39;top&#39;</span>),</span>
<span id="cb43-10"><a href="vizedges.html#cb43-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">inner.margins =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.07</span>))</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
<p>The default line width setting is proportional to the column variable (in this case, flow values). As you can see, this default is not a good visualization for the map because edges with small amount of flows are too thin to be seen. In reality, the degree weight distribution of non-planar networks is often skewed, with a few edges have very high flow values and most of the rest have low values. Therefore, we need to adjust the breaks to better visualize the spatial network.</p>
<p><strong>To adjust the line width breaks</strong>, we need to create a column to store relative edge width, which is similar to the node size visualization in chapter 2. We chose a skewed quantile breaks for line width.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="vizedges.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We design the breaks for edge width through a skewed quantile distribution</span></span>
<span id="cb44-2"><a href="vizedges.html#cb44-2" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">quantile</span>(edges<span class="sc">$</span>flow, <span class="at">probs=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="fl">0.99</span>, <span class="dv">1</span>)), <span class="dv">0</span>)</span>
<span id="cb44-3"><a href="vizedges.html#cb44-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-4"><a href="vizedges.html#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co"># We create a column called flow_breaks that stores relative line width </span></span>
<span id="cb44-5"><a href="vizedges.html#cb44-5" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> edges <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb44-6"><a href="vizedges.html#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">flow_width =</span> <span class="fu">case_when</span>(</span>
<span id="cb44-7"><a href="vizedges.html#cb44-7" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;=</span> brks[<span class="dv">1</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">2</span>] <span class="sc">~</span> <span class="fl">0.1</span>,</span>
<span id="cb44-8"><a href="vizedges.html#cb44-8" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks[<span class="dv">2</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">3</span>] <span class="sc">~</span> <span class="fl">0.3</span>,</span>
<span id="cb44-9"><a href="vizedges.html#cb44-9" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks[<span class="dv">3</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">4</span>] <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb44-10"><a href="vizedges.html#cb44-10" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks[<span class="dv">4</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">5</span>] <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb44-11"><a href="vizedges.html#cb44-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb44-12"><a href="vizedges.html#cb44-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb44-13"><a href="vizedges.html#cb44-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-14"><a href="vizedges.html#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb44-15"><a href="vizedges.html#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(GA_county) <span class="sc">+</span> </span>
<span id="cb44-16"><a href="vizedges.html#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">alpha=</span><span class="dv">0</span>, <span class="at">border.col =</span> <span class="st">&#39;black&#39;</span>) <span class="sc">+</span> </span>
<span id="cb44-17"><a href="vizedges.html#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># commute edges are arranged by flow values from high to low so that </span></span>
<span id="cb44-18"><a href="vizedges.html#cb44-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># high volumn flows will be plotted on the top of the low value ones.  </span></span>
<span id="cb44-19"><a href="vizedges.html#cb44-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(<span class="fu">arrange</span>(edges, flow)) <span class="sc">+</span> </span>
<span id="cb44-20"><a href="vizedges.html#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">lwd=</span><span class="st">&quot;flow_width&quot;</span>, <span class="at">scale=</span><span class="dv">2</span>, <span class="at">alpha=</span><span class="fl">0.5</span>,</span>
<span id="cb44-21"><a href="vizedges.html#cb44-21" aria-hidden="true" tabindex="-1"></a>           <span class="at">lwd.legend =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)<span class="sc">*</span><span class="dv">2</span>, </span>
<span id="cb44-22"><a href="vizedges.html#cb44-22" aria-hidden="true" tabindex="-1"></a>           <span class="at">legend.lwd.is.portrait =</span> <span class="cn">TRUE</span>,</span>
<span id="cb44-23"><a href="vizedges.html#cb44-23" aria-hidden="true" tabindex="-1"></a>           <span class="at">lwd.legend.labels=</span><span class="fu">c</span>(<span class="st">&#39;300-600&#39;</span>,<span class="st">&#39;601-3400&#39;</span>,</span>
<span id="cb44-24"><a href="vizedges.html#cb44-24" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&#39;3401-30,000&#39;</span>,<span class="st">&#39;30,001-130,000&#39;</span>),</span>
<span id="cb44-25"><a href="vizedges.html#cb44-25" aria-hidden="true" tabindex="-1"></a>           <span class="at">title.lwd =</span> <span class="fu">c</span>(<span class="st">&#39;Commutes Across Counties&#39;</span>)) <span class="sc">+</span> </span>
<span id="cb44-26"><a href="vizedges.html#cb44-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">&#39;right&#39;</span>, <span class="st">&#39;top&#39;</span>),</span>
<span id="cb44-27"><a href="vizedges.html#cb44-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">inner.margins =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.05</span>))</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
</div>
<div id="visualizing-edges-by-color" class="section level2" number="4.4">
<h2><span class="header-section-number">4.4</span> Visualizing Edges by Color</h2>
<p>To visualize edges by color, we assign a variable column <code>flow</code> to argument <code>col</code> in <code>tm_lines</code>. Since we already established that the edges are better viewed through a skewed flow breaks, we manually assign break values for color. To do that, we give argument <code>breaks</code> a vector of fixed numbers, and set argument <code>style</code> to <code>fixed</code>. The following map has constant line width across different colors.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="vizedges.html#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb45-2"><a href="vizedges.html#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tm_shape</span>(GA_county) <span class="sc">+</span> </span>
<span id="cb45-3"><a href="vizedges.html#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">alpha=</span><span class="dv">0</span>, <span class="at">border.col =</span> <span class="st">&#39;black&#39;</span>) <span class="sc">+</span> </span>
<span id="cb45-4"><a href="vizedges.html#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(<span class="fu">arrange</span>(edges, flow)) <span class="sc">+</span> </span>
<span id="cb45-5"><a href="vizedges.html#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># all the parameters for adjusting colors</span></span>
<span id="cb45-6"><a href="vizedges.html#cb45-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(<span class="at">col=</span><span class="st">&quot;flow&quot;</span>, <span class="at">alpha=</span><span class="fl">0.5</span>, <span class="at">scale =</span> <span class="dv">1</span>,</span>
<span id="cb45-7"><a href="vizedges.html#cb45-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">breaks =</span> <span class="fu">round</span>(<span class="fu">quantile</span>(edges<span class="sc">$</span>flow, <span class="at">probs=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="fl">0.99</span>, <span class="dv">1</span>)), <span class="dv">0</span>),</span>
<span id="cb45-8"><a href="vizedges.html#cb45-8" aria-hidden="true" tabindex="-1"></a>           <span class="at">style=</span><span class="st">&quot;fixed&quot;</span>, <span class="at">n =</span> <span class="dv">4</span>, </span>
<span id="cb45-9"><a href="vizedges.html#cb45-9" aria-hidden="true" tabindex="-1"></a>           <span class="at">title.col =</span> <span class="fu">c</span>(<span class="st">&#39;Commutes Across Counties&#39;</span>),</span>
<span id="cb45-10"><a href="vizedges.html#cb45-10" aria-hidden="true" tabindex="-1"></a>           <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&#39;300-600&#39;</span>,<span class="st">&#39;601-3400&#39;</span>,<span class="st">&#39;3401-30,000&#39;</span>,<span class="st">&#39;30,001-130,000&#39;</span>),</span>
<span id="cb45-11"><a href="vizedges.html#cb45-11" aria-hidden="true" tabindex="-1"></a>           <span class="at">palette=</span><span class="fu">c</span>(<span class="st">&#39;#094081&#39;</span>, <span class="st">&#39;#2B8CBE&#39;</span>, <span class="st">&#39;#7BCCC4&#39;</span>, <span class="st">&#39;#CCEBC5&#39;</span>)) <span class="sc">+</span> </span>
<span id="cb45-12"><a href="vizedges.html#cb45-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">&#39;right&#39;</span>, <span class="st">&#39;top&#39;</span>),</span>
<span id="cb45-13"><a href="vizedges.html#cb45-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">inner.margins =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.05</span>))</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-40-1.png" width="672" /></p>
</div>
<div id="visualizing-edges-by-width-and-color" class="section level2" number="4.5">
<h2><span class="header-section-number">4.5</span> Visualizing Edges by Width and Color</h2>
<p>Similar to node visualization, to visualize edges with both line width and color, we need to add arguments for both and create a combined legend through <code>tm_add_legend</code>. Unfortunately, the package does not have an automatic way to combine color and line width legend together, so we have to define the values manually.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="vizedges.html#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb46-2"><a href="vizedges.html#cb46-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-3"><a href="vizedges.html#cb46-3" aria-hidden="true" tabindex="-1"></a>map <span class="ot">=</span> <span class="fu">tm_shape</span>(GA_county) <span class="sc">+</span> </span>
<span id="cb46-4"><a href="vizedges.html#cb46-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">alpha=</span><span class="dv">0</span>, <span class="at">border.col =</span> <span class="st">&#39;black&#39;</span>) <span class="sc">+</span> </span>
<span id="cb46-5"><a href="vizedges.html#cb46-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(<span class="fu">arrange</span>(edges, flow)) <span class="sc">+</span> </span>
<span id="cb46-6"><a href="vizedges.html#cb46-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(</span>
<span id="cb46-7"><a href="vizedges.html#cb46-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">#arguments that define the styles for color </span></span>
<span id="cb46-8"><a href="vizedges.html#cb46-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">col=</span><span class="st">&quot;flow&quot;</span>, <span class="at">alpha=</span><span class="fl">0.8</span>, </span>
<span id="cb46-9"><a href="vizedges.html#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">round</span>(<span class="fu">quantile</span>(edges<span class="sc">$</span>flow, <span class="at">probs=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="fl">0.99</span>, <span class="dv">1</span>)), <span class="dv">0</span>),</span>
<span id="cb46-10"><a href="vizedges.html#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">style=</span><span class="st">&quot;fixed&quot;</span>, <span class="at">n =</span> <span class="dv">4</span>, </span>
<span id="cb46-11"><a href="vizedges.html#cb46-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">palette=</span><span class="fu">c</span>(<span class="st">&#39;#094081&#39;</span>, <span class="st">&#39;#2B8CBE&#39;</span>, <span class="st">&#39;#7BCCC4&#39;</span>, <span class="st">&#39;#CCEBC5&#39;</span>),</span>
<span id="cb46-12"><a href="vizedges.html#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.col.show =</span> <span class="cn">FALSE</span>,</span>
<span id="cb46-13"><a href="vizedges.html#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">#arguments that define the styles for line width </span></span>
<span id="cb46-14"><a href="vizedges.html#cb46-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">lwd=</span><span class="st">&quot;flow_width&quot;</span>, <span class="at">scale=</span><span class="dv">2</span>,</span>
<span id="cb46-15"><a href="vizedges.html#cb46-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.lwd.show =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb46-16"><a href="vizedges.html#cb46-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add manual legends to combine color and line width schema</span></span>
<span id="cb46-17"><a href="vizedges.html#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_add_legend</span>(</span>
<span id="cb46-18"><a href="vizedges.html#cb46-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">type=</span><span class="fu">c</span>(<span class="st">&#39;line&#39;</span>), </span>
<span id="cb46-19"><a href="vizedges.html#cb46-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;#094081&#39;</span>, <span class="st">&#39;#2B8CBE&#39;</span>, <span class="st">&#39;#7BCCC4&#39;</span>, <span class="st">&#39;#CCEBC5&#39;</span>), </span>
<span id="cb46-20"><a href="vizedges.html#cb46-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span>), </span>
<span id="cb46-21"><a href="vizedges.html#cb46-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&#39;300-600&#39;</span>,<span class="st">&#39;601-3400&#39;</span>,<span class="st">&#39;3401-30,000&#39;</span>,<span class="st">&#39;30,001-130,000&#39;</span>),</span>
<span id="cb46-22"><a href="vizedges.html#cb46-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">title=</span><span class="st">&#39;Commutes Across Counties&#39;</span>) <span class="sc">+</span> </span>
<span id="cb46-23"><a href="vizedges.html#cb46-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">&#39;right&#39;</span>, <span class="st">&#39;top&#39;</span>),</span>
<span id="cb46-24"><a href="vizedges.html#cb46-24" aria-hidden="true" tabindex="-1"></a>            <span class="at">inner.margins =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.05</span>))</span>
<span id="cb46-25"><a href="vizedges.html#cb46-25" aria-hidden="true" tabindex="-1"></a>map</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-41-1.png" width="672" /></p>
<p>Perfect! Now we can see clearly that commutes across counties are most intensive around the Atlanta metropolitan area and less so in the south of the state. We can further perfect the map by <strong>adding information about within county flows and visualize the numbers as node sizes</strong>. Here we show a new technique, which is to save the map we already plotted as a variable, and add new components to it. In this way, we do not have to regenerate the portion of the map that we already produced and speed up the mapping and testing time dramatically!</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="vizedges.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># creating nodes as point geometry that represent within county flows </span></span>
<span id="cb47-2"><a href="vizedges.html#cb47-2" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb47-3"><a href="vizedges.html#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(w_county, h_county, S000)) <span class="sc">%&gt;%</span> </span>
<span id="cb47-4"><a href="vizedges.html#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">flow =</span> S000) <span class="sc">%&gt;%</span> </span>
<span id="cb47-5"><a href="vizedges.html#cb47-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(h_county <span class="sc">==</span> w_county) <span class="sc">%&gt;%</span></span>
<span id="cb47-6"><a href="vizedges.html#cb47-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(GA_county <span class="sc">%&gt;%</span> <span class="fu">st_centroid</span>(), <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;h_county&#39;</span> <span class="ot">=</span> <span class="st">&#39;GEOID&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb47-7"><a href="vizedges.html#cb47-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb47-8"><a href="vizedges.html#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="vizedges.html#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="co"># here we use quantile breaks for node size </span></span>
<span id="cb47-10"><a href="vizedges.html#cb47-10" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">=</span> <span class="fu">quantile</span>(nodes<span class="sc">$</span>flow, <span class="at">probs=</span><span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.25</span>))</span>
<span id="cb47-11"><a href="vizedges.html#cb47-11" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> nodes <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb47-12"><a href="vizedges.html#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="fu">case_when</span>(</span>
<span id="cb47-13"><a href="vizedges.html#cb47-13" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;=</span> brks[<span class="dv">1</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">2</span>] <span class="sc">~</span> <span class="fl">0.1</span>,</span>
<span id="cb47-14"><a href="vizedges.html#cb47-14" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks[<span class="dv">2</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">3</span>] <span class="sc">~</span> <span class="fl">0.3</span>,</span>
<span id="cb47-15"><a href="vizedges.html#cb47-15" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks[<span class="dv">3</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">4</span>] <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb47-16"><a href="vizedges.html#cb47-16" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks[<span class="dv">4</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">5</span>] <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb47-17"><a href="vizedges.html#cb47-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb47-18"><a href="vizedges.html#cb47-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb47-19"><a href="vizedges.html#cb47-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-20"><a href="vizedges.html#cb47-20" aria-hidden="true" tabindex="-1"></a><span class="co">#visualize nodes on top of the map from last section</span></span>
<span id="cb47-21"><a href="vizedges.html#cb47-21" aria-hidden="true" tabindex="-1"></a>map <span class="ot">=</span> map <span class="sc">+</span> </span>
<span id="cb47-22"><a href="vizedges.html#cb47-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(nodes) <span class="sc">+</span></span>
<span id="cb47-23"><a href="vizedges.html#cb47-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_symbols</span>(</span>
<span id="cb47-24"><a href="vizedges.html#cb47-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">size=</span><span class="st">&quot;size&quot;</span>, <span class="at">scale=</span><span class="fl">0.8</span>, </span>
<span id="cb47-25"><a href="vizedges.html#cb47-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">border.col=</span><span class="st">&#39;black&#39;</span>, <span class="at">border.alpha=</span><span class="fl">0.5</span>, </span>
<span id="cb47-26"><a href="vizedges.html#cb47-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># values in sizes.legend = relative size defined in &#39;size&#39; column * scale </span></span>
<span id="cb47-27"><a href="vizedges.html#cb47-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">sizes.legend =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)<span class="sc">*</span><span class="fl">0.8</span>,</span>
<span id="cb47-28"><a href="vizedges.html#cb47-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># labels have rounded the break values</span></span>
<span id="cb47-29"><a href="vizedges.html#cb47-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">sizes.legend.labels=</span><span class="fu">c</span>(<span class="st">&#39;70-1000&#39;</span>,<span class="st">&#39;1001-2500&#39;</span>,<span class="st">&#39;2501-7000&#39;</span>,<span class="st">&#39;7001-250,000&#39;</span>),</span>
<span id="cb47-30"><a href="vizedges.html#cb47-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.size=</span><span class="fu">c</span>(<span class="st">&#39;Commutes Within Counties&#39;</span>),</span>
<span id="cb47-31"><a href="vizedges.html#cb47-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.size.is.portrait =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb47-32"><a href="vizedges.html#cb47-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">&#39;right&#39;</span>, <span class="st">&#39;top&#39;</span>),</span>
<span id="cb47-33"><a href="vizedges.html#cb47-33" aria-hidden="true" tabindex="-1"></a>            <span class="at">inner.margins =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.25</span>)) <span class="co">#added margins to accomodate legends</span></span>
<span id="cb47-34"><a href="vizedges.html#cb47-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-35"><a href="vizedges.html#cb47-35" aria-hidden="true" tabindex="-1"></a>map</span></code></pre></div>
<p><img src="SSN_tutorial_files/figure-html/unnamed-chunk-42-1.png" width="672" /></p>
<p>To export the tmap object into a local folder, you can add:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="vizedges.html#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_save</span>(map, <span class="at">filename=</span><span class="st">&#39;YOUR_LOCAL_FOLDER_PATH/map.png&#39;</span>)</span></code></pre></div>
<p>Here is the full code to replicate the map above</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="vizedges.html#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb49-2"><a href="vizedges.html#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb49-3"><a href="vizedges.html#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tmap)</span>
<span id="cb49-4"><a href="vizedges.html#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tigris)</span>
<span id="cb49-5"><a href="vizedges.html#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lehdr)</span>
<span id="cb49-6"><a href="vizedges.html#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stplanr)</span>
<span id="cb49-7"><a href="vizedges.html#cb49-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-8"><a href="vizedges.html#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="co">#counties is a function in tigris package</span></span>
<span id="cb49-9"><a href="vizedges.html#cb49-9" aria-hidden="true" tabindex="-1"></a>GA_county <span class="ot">=</span> <span class="fu">counties</span>(<span class="at">state =</span> <span class="st">&#39;GA&#39;</span>, <span class="at">cb=</span><span class="cn">TRUE</span>, <span class="at">year=</span><span class="dv">2018</span>, <span class="at">progress_bar=</span><span class="cn">FALSE</span>) </span>
<span id="cb49-10"><a href="vizedges.html#cb49-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-11"><a href="vizedges.html#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="co">#grab_lodes is a function in lehdr package</span></span>
<span id="cb49-12"><a href="vizedges.html#cb49-12" aria-hidden="true" tabindex="-1"></a>data <span class="ot">=</span> <span class="fu">grab_lodes</span>(<span class="at">state=</span><span class="st">&#39;ga&#39;</span>, <span class="at">year=</span><span class="dv">2018</span>, <span class="at">lodes_type =</span> <span class="st">&#39;od&#39;</span>, <span class="at">state_part =</span> <span class="st">&#39;main&#39;</span>, <span class="at">agg_geo =</span> <span class="st">&#39;county&#39;</span>)</span>
<span id="cb49-13"><a href="vizedges.html#cb49-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-14"><a href="vizedges.html#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="co">#filter top 1000 county-to-county flows </span></span>
<span id="cb49-15"><a href="vizedges.html#cb49-15" aria-hidden="true" tabindex="-1"></a>ctc_commutes <span class="ot">=</span> data <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(w_county, h_county, S000)) <span class="sc">%&gt;%</span> </span>
<span id="cb49-16"><a href="vizedges.html#cb49-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">flow =</span> S000) <span class="sc">%&gt;%</span> </span>
<span id="cb49-17"><a href="vizedges.html#cb49-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(h_county <span class="sc">!=</span> w_county) <span class="sc">%&gt;%</span> </span>
<span id="cb49-18"><a href="vizedges.html#cb49-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(flow)) <span class="sc">%&gt;%</span> </span>
<span id="cb49-19"><a href="vizedges.html#cb49-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>) </span>
<span id="cb49-20"><a href="vizedges.html#cb49-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-21"><a href="vizedges.html#cb49-21" aria-hidden="true" tabindex="-1"></a><span class="co">#--- Create lines from OD dataframe ---# </span></span>
<span id="cb49-22"><a href="vizedges.html#cb49-22" aria-hidden="true" tabindex="-1"></a>cnty_centroid <span class="ot">=</span> GA_county <span class="sc">%&gt;%</span> <span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="fu">c</span>(GEOID, geometry))</span>
<span id="cb49-23"><a href="vizedges.html#cb49-23" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> <span class="fu">od2line</span>(ctc_commutes, cnty_centroid)</span>
<span id="cb49-24"><a href="vizedges.html#cb49-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-25"><a href="vizedges.html#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Convert flows within county into point geometry --- #</span></span>
<span id="cb49-26"><a href="vizedges.html#cb49-26" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> data <span class="sc">%&gt;%</span> </span>
<span id="cb49-27"><a href="vizedges.html#cb49-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(w_county, h_county, S000)) <span class="sc">%&gt;%</span> </span>
<span id="cb49-28"><a href="vizedges.html#cb49-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">flow =</span> S000) <span class="sc">%&gt;%</span> </span>
<span id="cb49-29"><a href="vizedges.html#cb49-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(h_county <span class="sc">==</span> w_county) <span class="sc">%&gt;%</span></span>
<span id="cb49-30"><a href="vizedges.html#cb49-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(GA_county <span class="sc">%&gt;%</span> <span class="fu">st_centroid</span>(), <span class="at">by=</span><span class="fu">c</span>(<span class="st">&#39;h_county&#39;</span> <span class="ot">=</span> <span class="st">&#39;GEOID&#39;</span>), <span class="at">copy=</span><span class="cn">FALSE</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb49-31"><a href="vizedges.html#cb49-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb49-32"><a href="vizedges.html#cb49-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-33"><a href="vizedges.html#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create Breaks for edge width --- # </span></span>
<span id="cb49-34"><a href="vizedges.html#cb49-34" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">quantile</span>(edges<span class="sc">$</span>flow, <span class="at">probs=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="fl">0.99</span>, <span class="dv">1</span>)), <span class="dv">0</span>)</span>
<span id="cb49-35"><a href="vizedges.html#cb49-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-36"><a href="vizedges.html#cb49-36" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">=</span> edges <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb49-37"><a href="vizedges.html#cb49-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">flow_width =</span> <span class="fu">case_when</span>(</span>
<span id="cb49-38"><a href="vizedges.html#cb49-38" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;=</span> brks[<span class="dv">1</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">2</span>] <span class="sc">~</span> <span class="fl">0.1</span>,</span>
<span id="cb49-39"><a href="vizedges.html#cb49-39" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks[<span class="dv">2</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">3</span>] <span class="sc">~</span> <span class="fl">0.3</span>,</span>
<span id="cb49-40"><a href="vizedges.html#cb49-40" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks[<span class="dv">3</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">4</span>] <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb49-41"><a href="vizedges.html#cb49-41" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks[<span class="dv">4</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks[<span class="dv">5</span>] <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb49-42"><a href="vizedges.html#cb49-42" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-43"><a href="vizedges.html#cb49-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-44"><a href="vizedges.html#cb49-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-45"><a href="vizedges.html#cb49-45" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Create Breaks for node size --- # </span></span>
<span id="cb49-46"><a href="vizedges.html#cb49-46" aria-hidden="true" tabindex="-1"></a>brks2 <span class="ot">=</span> <span class="fu">quantile</span>(nodes<span class="sc">$</span>flow, <span class="at">probs=</span><span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="fl">0.25</span>))</span>
<span id="cb49-47"><a href="vizedges.html#cb49-47" aria-hidden="true" tabindex="-1"></a>nodes <span class="ot">=</span> nodes <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb49-48"><a href="vizedges.html#cb49-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> <span class="fu">case_when</span>(</span>
<span id="cb49-49"><a href="vizedges.html#cb49-49" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;=</span> brks2[<span class="dv">1</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks2[<span class="dv">2</span>] <span class="sc">~</span> <span class="fl">0.1</span>,</span>
<span id="cb49-50"><a href="vizedges.html#cb49-50" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks2[<span class="dv">2</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks2[<span class="dv">3</span>] <span class="sc">~</span> <span class="fl">0.3</span>,</span>
<span id="cb49-51"><a href="vizedges.html#cb49-51" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks2[<span class="dv">3</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks2[<span class="dv">4</span>] <span class="sc">~</span> <span class="fl">0.5</span>,</span>
<span id="cb49-52"><a href="vizedges.html#cb49-52" aria-hidden="true" tabindex="-1"></a>    flow <span class="sc">&gt;</span> brks2[<span class="dv">4</span>] <span class="sc">&amp;</span> flow <span class="sc">&lt;=</span> brks2[<span class="dv">5</span>] <span class="sc">~</span> <span class="dv">1</span></span>
<span id="cb49-53"><a href="vizedges.html#cb49-53" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb49-54"><a href="vizedges.html#cb49-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb49-55"><a href="vizedges.html#cb49-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-56"><a href="vizedges.html#cb49-56" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Visualize the map ---- # </span></span>
<span id="cb49-57"><a href="vizedges.html#cb49-57" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_mode</span>(<span class="st">&#39;plot&#39;</span>)</span>
<span id="cb49-58"><a href="vizedges.html#cb49-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-59"><a href="vizedges.html#cb49-59" aria-hidden="true" tabindex="-1"></a>map <span class="ot">=</span> <span class="fu">tm_shape</span>(GA_county) <span class="sc">+</span> </span>
<span id="cb49-60"><a href="vizedges.html#cb49-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_polygons</span>(<span class="at">alpha=</span><span class="dv">0</span>, <span class="at">border.col =</span> <span class="st">&#39;black&#39;</span>) <span class="sc">+</span> </span>
<span id="cb49-61"><a href="vizedges.html#cb49-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(<span class="fu">arrange</span>(edges, flow)) <span class="sc">+</span> </span>
<span id="cb49-62"><a href="vizedges.html#cb49-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_lines</span>(</span>
<span id="cb49-63"><a href="vizedges.html#cb49-63" aria-hidden="true" tabindex="-1"></a>    <span class="co">#arguments that define the styles for color </span></span>
<span id="cb49-64"><a href="vizedges.html#cb49-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">col=</span><span class="st">&quot;flow&quot;</span>, <span class="at">alpha=</span><span class="fl">0.8</span>, </span>
<span id="cb49-65"><a href="vizedges.html#cb49-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">breaks =</span> <span class="fu">round</span>(<span class="fu">quantile</span>(edges<span class="sc">$</span>flow, <span class="at">probs=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span>, <span class="fl">0.99</span>, <span class="dv">1</span>)), <span class="dv">0</span>),</span>
<span id="cb49-66"><a href="vizedges.html#cb49-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">style=</span><span class="st">&quot;fixed&quot;</span>, <span class="at">n =</span> <span class="dv">4</span>, </span>
<span id="cb49-67"><a href="vizedges.html#cb49-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">palette=</span><span class="fu">c</span>(<span class="st">&#39;#094081&#39;</span>, <span class="st">&#39;#2B8CBE&#39;</span>, <span class="st">&#39;#7BCCC4&#39;</span>, <span class="st">&#39;#CCEBC5&#39;</span>),</span>
<span id="cb49-68"><a href="vizedges.html#cb49-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.col.show =</span> <span class="cn">FALSE</span>,</span>
<span id="cb49-69"><a href="vizedges.html#cb49-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">#arguments that define the styles for line width </span></span>
<span id="cb49-70"><a href="vizedges.html#cb49-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">lwd=</span><span class="st">&quot;flow_width&quot;</span>, <span class="at">scale=</span><span class="dv">2</span>,</span>
<span id="cb49-71"><a href="vizedges.html#cb49-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.lwd.show =</span> <span class="cn">FALSE</span>) <span class="sc">+</span> </span>
<span id="cb49-72"><a href="vizedges.html#cb49-72" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add manual legends to combine color and line width schema </span></span>
<span id="cb49-73"><a href="vizedges.html#cb49-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_add_legend</span>(</span>
<span id="cb49-74"><a href="vizedges.html#cb49-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">type=</span><span class="fu">c</span>(<span class="st">&#39;line&#39;</span>), </span>
<span id="cb49-75"><a href="vizedges.html#cb49-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">col=</span><span class="fu">c</span>(<span class="st">&#39;#094081&#39;</span>, <span class="st">&#39;#2B8CBE&#39;</span>, <span class="st">&#39;#7BCCC4&#39;</span>, <span class="st">&#39;#CCEBC5&#39;</span>), </span>
<span id="cb49-76"><a href="vizedges.html#cb49-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">lwd=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span>, <span class="fl">0.1</span>), </span>
<span id="cb49-77"><a href="vizedges.html#cb49-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&#39;300-600&#39;</span>,<span class="st">&#39;601-3400&#39;</span>,<span class="st">&#39;3401-30,000&#39;</span>,<span class="st">&#39;30,001-130,000&#39;</span>),</span>
<span id="cb49-78"><a href="vizedges.html#cb49-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">title=</span><span class="st">&#39;Commutes Across Counties&#39;</span>) <span class="sc">+</span> </span>
<span id="cb49-79"><a href="vizedges.html#cb49-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">#add inner margin to accomodate legend size </span></span>
<span id="cb49-80"><a href="vizedges.html#cb49-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">&#39;right&#39;</span>, <span class="st">&#39;top&#39;</span>),</span>
<span id="cb49-81"><a href="vizedges.html#cb49-81" aria-hidden="true" tabindex="-1"></a>            <span class="at">inner.margins =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.1</span>)) <span class="sc">+</span></span>
<span id="cb49-82"><a href="vizedges.html#cb49-82" aria-hidden="true" tabindex="-1"></a>  <span class="co"># visualize nodes </span></span>
<span id="cb49-83"><a href="vizedges.html#cb49-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_shape</span>(nodes) <span class="sc">+</span></span>
<span id="cb49-84"><a href="vizedges.html#cb49-84" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_symbols</span>(</span>
<span id="cb49-85"><a href="vizedges.html#cb49-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">size=</span><span class="st">&quot;size&quot;</span>, <span class="at">scale=</span><span class="fl">0.8</span>, </span>
<span id="cb49-86"><a href="vizedges.html#cb49-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha=</span><span class="dv">0</span>, <span class="at">border.col=</span><span class="st">&#39;black&#39;</span>, <span class="at">border.alpha=</span><span class="fl">0.5</span>, </span>
<span id="cb49-87"><a href="vizedges.html#cb49-87" aria-hidden="true" tabindex="-1"></a>    <span class="co"># values in sizes.legend = relative size defined in &#39;size&#39; column * scale </span></span>
<span id="cb49-88"><a href="vizedges.html#cb49-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">sizes.legend =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="dv">1</span>)<span class="sc">*</span><span class="fl">0.8</span>,</span>
<span id="cb49-89"><a href="vizedges.html#cb49-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># labels have rounded the break values</span></span>
<span id="cb49-90"><a href="vizedges.html#cb49-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">sizes.legend.labels=</span><span class="fu">c</span>(<span class="st">&#39;70-1000&#39;</span>,<span class="st">&#39;1001-2500&#39;</span>,<span class="st">&#39;2501-7000&#39;</span>,<span class="st">&#39;7001-250,000&#39;</span>),</span>
<span id="cb49-91"><a href="vizedges.html#cb49-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">title.size=</span><span class="fu">c</span>(<span class="st">&#39;Commutes Within Counties&#39;</span>),</span>
<span id="cb49-92"><a href="vizedges.html#cb49-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.size.is.portrait =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb49-93"><a href="vizedges.html#cb49-93" aria-hidden="true" tabindex="-1"></a>  <span class="co"># since the default layout is too small to accomodate both legends</span></span>
<span id="cb49-94"><a href="vizedges.html#cb49-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tm_layout</span>(<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="st">&#39;right&#39;</span>, <span class="st">&#39;top&#39;</span>),</span>
<span id="cb49-95"><a href="vizedges.html#cb49-95" aria-hidden="true" tabindex="-1"></a>            <span class="at">inner.margins =</span> <span class="fu">c</span>(<span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.25</span>))</span>
<span id="cb49-96"><a href="vizedges.html#cb49-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-97"><a href="vizedges.html#cb49-97" aria-hidden="true" tabindex="-1"></a>map</span>
<span id="cb49-98"><a href="vizedges.html#cb49-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-99"><a href="vizedges.html#cb49-99" aria-hidden="true" tabindex="-1"></a><span class="fu">tmap_save</span>(map, <span class="at">filename=</span><span class="st">&#39;YOUR_LOCAL_FOLDER_PATH/map.png&#39;</span>)</span></code></pre></div>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="nodes.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="advanced-aesthetics.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["SSN_tutorial.pdf", "SSN_tutorial.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
